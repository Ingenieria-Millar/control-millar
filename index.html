<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Control de Piso ‚Äî Confecciones Millar</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#080c14;--panel:#0f1520;--border:#1a2236;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--text:#e2e8f0;--muted:#4b5a72;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);font-family:'Segoe UI',Arial,sans-serif;color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(26,34,54,0.5) 1px,transparent 1px),linear-gradient(90deg,rgba(26,34,54,0.5) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0;}

header{position:relative;z-index:2;display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:rgba(15,21,32,0.97);border-bottom:1px solid var(--border);}
.hd-left{display:flex;align-items:center;gap:12px;}
.live-dot{width:11px;height:11px;border-radius:50%;background:var(--muted);}
.live-dot.online{background:var(--green);box-shadow:0 0 10px rgba(34,197,94,0.8);animation:lp 2s ease-in-out infinite;}
.live-dot.offline{background:var(--red);box-shadow:0 0 8px rgba(239,68,68,0.7);}
@keyframes lp{0%,100%{box-shadow:0 0 6px rgba(34,197,94,0.6);}50%{box-shadow:0 0 18px rgba(34,197,94,1),0 0 32px rgba(34,197,94,0.5);}}
h1{font-size:19px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#f1f5f9;}
.conn-label{font-size:11px;font-weight:600;letter-spacing:1.5px;color:var(--green);text-transform:uppercase;}
.clock{font-family:'Courier New',monospace;font-size:17px;color:#e2e8f0;letter-spacing:2px;font-weight:700;}
.stats{position:relative;z-index:2;display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px 24px;background:rgba(8,12,20,0.9);border-bottom:1px solid var(--border);}
.stat{display:flex;align-items:center;gap:7px;padding:6px 16px;border-radius:6px;background:var(--panel);border:1px solid var(--border);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;user-select:none;}
.stat:hover{border-color:#2d3f5a;background:#1a2236;}
.stat.active-filter.fg{border-color:var(--green);background:rgba(34,197,94,0.12);color:var(--green);}
.stat.active-filter.fy{border-color:var(--yellow);background:rgba(234,179,8,0.12);color:var(--yellow);}
.stat.active-filter.fr{border-color:var(--red);background:rgba(239,68,68,0.12);color:var(--red);}
.sd{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.sd.g{background:var(--green);box-shadow:0 0 7px rgba(34,197,94,0.8);}
.sd.y{background:var(--yellow);box-shadow:0 0 7px rgba(234,179,8,0.8);}
.sd.r{background:var(--red);box-shadow:0 0 7px rgba(239,68,68,0.8);}
.filter-hint{font-size:11px;color:var(--muted);letter-spacing:1px;font-style:italic;}
.view-toggle{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.btn-bar{padding:5px 14px;border-radius:6px;font-size:13px;font-weight:600;letter-spacing:1px;cursor:pointer;transition:all 0.2s;border:1px solid var(--border);background:transparent;color:var(--muted);}
.btn-bar:hover{border-color:#2d3f5a;color:var(--text);}
.btn-bar.green{border-color:rgba(34,197,94,0.4);background:rgba(34,197,94,0.08);color:var(--green);}
.btn-bar.green:hover{background:rgba(34,197,94,0.15);}
.btn-bar.yellow{border-color:rgba(234,179,8,0.4);background:rgba(234,179,8,0.06);color:var(--yellow);}
.btn-bar.yellow:hover{background:rgba(234,179,8,0.12);}
.btn-bar.blue{border-color:rgba(99,179,237,0.3);color:#93c5fd;}
.btn-bar.blue:hover{background:rgba(99,179,237,0.08);}
.btn-bar.red{border-color:rgba(239,68,68,0.3);color:#fca5a5;}
.btn-bar.red:hover{background:rgba(239,68,68,0.08);}
.btn-bar.purple{border-color:rgba(167,139,250,0.4);background:rgba(167,139,250,0.07);color:#c4b5fd;}
.btn-bar.purple:hover{background:rgba(167,139,250,0.14);}
#nav-single{display:none;position:relative;z-index:2;padding:10px 24px;background:rgba(8,12,20,0.9);border-bottom:1px solid var(--border);gap:8px;justify-content:flex-end;align-items:center;}
main{position:relative;z-index:1;padding:24px;max-width:1200px;margin:0 auto;padding-bottom:24px;}
.grid{display:grid;grid-template-columns:repeat(9,1fr);gap:12px;}
.module{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px 10px 10px;display:flex;flex-direction:column;align-items:center;gap:5px;overflow:hidden;transition:transform 0.15s,border-color 0.3s,box-shadow 0.3s;user-select:none;-webkit-tap-highlight-color:transparent;animation:fi 0.25s ease;}
@keyframes fi{from{opacity:0;transform:scale(0.92);}to{opacity:1;transform:scale(1);}}
.module.readonly{cursor:default;}.module.clickable{cursor:pointer;}.module.clickable:hover{transform:scale(1.03);}
.module::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0;transition:background 0.4s;}
.module.green{border-color:rgba(34,197,94,0.25);box-shadow:0 2px 16px rgba(34,197,94,0.07);}
.module.yellow{border-color:rgba(234,179,8,0.3);box-shadow:0 2px 16px rgba(234,179,8,0.08);}
.module.red{border-color:rgba(239,68,68,0.4);box-shadow:0 4px 24px rgba(239,68,68,0.15);}
.module.green::before{background:var(--green);}.module.yellow::before{background:var(--yellow);}.module.red::before{background:var(--red);}
.mod-id{font-family:'Courier New',monospace;font-size:12px;font-weight:700;letter-spacing:2px;color:#cbd5e1;align-self:flex-start;}
.light{width:50px;height:50px;border-radius:50%;transition:background 0.4s,box-shadow 0.4s;position:relative;}
.light::after{content:'';position:absolute;top:8px;left:11px;width:14px;height:8px;border-radius:50%;background:rgba(255,255,255,0.22);transform:rotate(-30deg);}
.module.green .light{background:radial-gradient(circle at 35% 35%,#4ade80,#15803d);box-shadow:0 0 16px rgba(34,197,94,0.7),0 0 32px rgba(34,197,94,0.3);}
.module.yellow .light{background:radial-gradient(circle at 35% 35%,#fde047,#a16207);box-shadow:0 0 16px rgba(234,179,8,0.7);animation:yb 1.6s ease-in-out infinite;}
.module.red .light{background:radial-gradient(circle at 35% 35%,#f87171,#991b1b);box-shadow:0 0 20px rgba(239,68,68,0.8),0 0 40px rgba(239,68,68,0.4);animation:rb 0.85s ease-in-out infinite;}
@keyframes yb{0%,100%{box-shadow:0 0 12px rgba(234,179,8,0.6);}50%{box-shadow:0 0 28px rgba(234,179,8,1),0 0 50px rgba(234,179,8,0.5);}}
@keyframes rb{0%,100%{box-shadow:0 0 16px rgba(239,68,68,0.7);}50%{box-shadow:0 0 36px rgba(239,68,68,1),0 0 68px rgba(239,68,68,0.6);}}
.mod-label{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;border-radius:4px;}
.module.green .mod-label{color:var(--green);background:rgba(34,197,94,0.1);}
.module.yellow .mod-label{color:var(--yellow);background:rgba(234,179,8,0.1);}
.module.red .mod-label{color:var(--red);background:rgba(239,68,68,0.12);}
.mod-timer{font-family:'Courier New',monospace;font-size:11px;font-weight:700;padding:2px 6px;border-radius:4px;letter-spacing:1px;min-height:18px;}
.module.red .mod-timer{color:var(--red);background:rgba(239,68,68,0.1);}
.module.yellow .mod-timer{color:var(--yellow);background:rgba(234,179,8,0.08);}
.module.green .mod-timer{visibility:hidden;}
.mod-mec{font-size:9px;font-weight:800;color:#f1f5f9;letter-spacing:0.3px;text-align:center;line-height:1.3;min-height:13px;padding:0 2px;word-break:break-word;}
.empty-msg{grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--muted);font-size:15px;letter-spacing:2px;}
#single-view{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:65vh;gap:24px;}
#single-view.active{display:flex;}
#grid-view.hidden{display:none;}
.big-wrap{display:flex;flex-direction:column;align-items:center;gap:22px;padding:48px 68px;background:var(--panel);border-radius:20px;border:1px solid var(--border);cursor:pointer;min-width:280px;transition:transform 0.18s,box-shadow 0.4s,border-color 0.4s;user-select:none;}
.big-wrap:active{transform:scale(0.97);}
.big-wrap.green{border-color:rgba(34,197,94,0.35);box-shadow:0 8px 50px rgba(34,197,94,0.15);}
.big-wrap.yellow{border-color:rgba(234,179,8,0.35);box-shadow:0 8px 50px rgba(234,179,8,0.15);}
.big-wrap.red{border-color:rgba(239,68,68,0.45);box-shadow:0 8px 60px rgba(239,68,68,0.25);}
.big-id{font-family:'Courier New',monospace;font-size:28px;letter-spacing:8px;color:#cbd5e1;}
.big-light{width:148px;height:148px;border-radius:50%;transition:background 0.4s,box-shadow 0.4s;position:relative;}
.big-light::after{content:'';position:absolute;top:24px;left:30px;width:44px;height:26px;border-radius:50%;background:rgba(255,255,255,0.2);transform:rotate(-30deg);}
.big-wrap.green .big-light{background:radial-gradient(circle at 35% 35%,#4ade80,#15803d);box-shadow:0 0 55px rgba(34,197,94,0.8),0 0 110px rgba(34,197,94,0.4);}
.big-wrap.yellow .big-light{background:radial-gradient(circle at 35% 35%,#fde047,#a16207);box-shadow:0 0 55px rgba(234,179,8,0.8);animation:yb 1.6s ease-in-out infinite;}
.big-wrap.red .big-light{background:radial-gradient(circle at 35% 35%,#f87171,#991b1b);box-shadow:0 0 65px rgba(239,68,68,0.9),0 0 130px rgba(239,68,68,0.5);animation:rb 0.85s ease-in-out infinite;}
.big-status{font-size:24px;font-weight:700;letter-spacing:4px;text-transform:uppercase;}
.big-wrap.green .big-status{color:var(--green);}.big-wrap.yellow .big-status{color:var(--yellow);}.big-wrap.red .big-status{color:var(--red);}
.big-timer{font-family:'Courier New',monospace;font-size:15px;font-weight:700;padding:5px 16px;border-radius:6px;letter-spacing:2px;min-height:30px;}
.big-wrap.red .big-timer{color:var(--red);background:rgba(239,68,68,0.1);}
.big-wrap.yellow .big-timer{color:var(--yellow);background:rgba(234,179,8,0.08);}
.big-wrap.green .big-timer{visibility:hidden;}
.tap-hint{font-size:12px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
#toasts{position:fixed;top:75px;right:18px;z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.toast{padding:11px 16px;border-radius:8px;background:var(--panel);border-left:3px solid;font-size:14px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,0.5);animation:tin 0.3s ease,tout 0.4s ease 2.6s forwards;max-width:270px;}
.toast.green{border-color:var(--green);color:var(--green);}.toast.yellow{border-color:var(--yellow);color:var(--yellow);}.toast.red{border-color:var(--red);color:var(--red);}
@keyframes tin{from{transform:translateX(110%);opacity:0;}to{transform:none;opacity:1;}}
@keyframes tout{to{opacity:0;transform:translateX(16px);}}
.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,0.12);transform:scale(0);animation:rip 0.55s linear;pointer-events:none;}
@keyframes rip{to{transform:scale(5);opacity:0;}}
/* LOGIN */
.login-screen{position:fixed;inset:0;z-index:500;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;}
.login-screen.hidden{display:none;}
.login-box{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:44px 48px;display:flex;flex-direction:column;align-items:center;gap:22px;width:90%;max-width:380px;box-shadow:0 24px 80px rgba(0,0,0,0.8);animation:slup 0.3s ease;}
@keyframes slup{from{transform:translateY(20px);opacity:0;}to{transform:none;opacity:1;}}
.login-logo{font-size:36px;}
.login-title{font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;text-align:center;line-height:1.5;}
.login-title span{display:block;font-size:11px;color:var(--muted);letter-spacing:2px;margin-top:4px;font-weight:400;}
.login-select,.login-input{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:15px;outline:none;transition:border-color 0.2s;}
.login-select{font-weight:600;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%234b5a72' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;}
.login-input{font-family:'Courier New',monospace;font-size:22px;letter-spacing:10px;text-align:center;}
.login-select:focus,.login-input:focus{border-color:#3d5a8a;}
.login-input.error{border-color:var(--red);animation:shake 0.35s ease;}
@keyframes shake{0%,100%{transform:none;}20%,60%{transform:translateX(-7px);}40%,80%{transform:translateX(7px);}}
.login-btn{width:100%;padding:15px;border-radius:10px;border:none;background:var(--green);color:#080c14;font-size:14px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:opacity 0.2s;}
.login-btn:hover{opacity:0.88;}
.login-error{font-size:12px;color:var(--red);letter-spacing:1px;min-height:16px;text-align:center;}
/* SELECTOR */
.selector-screen{position:fixed;inset:0;z-index:490;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:36px;}
.selector-screen.hidden{display:none;}
.sel-title{font-size:18px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#f1f5f9;text-align:center;}
.sel-btns{display:flex;flex-direction:column;gap:14px;width:300px;}
.sel-btn{padding:20px;border-radius:14px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:15px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:12px;}
.sel-btn:hover{transform:translateY(-2px);}
.sel-btn.mec-btn{border-color:rgba(239,68,68,0.35);}
.sel-btn.mec-btn:hover{border-color:rgba(239,68,68,0.7);box-shadow:0 4px 20px rgba(239,68,68,0.12);}
.sel-btn.prod-btn{border-color:rgba(34,197,94,0.35);}
.sel-btn.prod-btn:hover{border-color:rgba(34,197,94,0.7);box-shadow:0 4px 20px rgba(34,197,94,0.12);}
.sel-back{padding:10px 28px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.sel-back:hover{background:#1a2236;color:var(--text);}
/* MODTABLE */
.modtable-screen{position:fixed;inset:0;z-index:480;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;}
.modtable-screen.hidden{display:none;}
.modtable-title{font-size:16px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#f1f5f9;}
.modtable-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;width:90%;max-width:480px;}
.modtable-btn{padding:14px 6px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:#cbd5e1;font-family:'Courier New',monospace;font-size:13px;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all 0.18s;text-align:center;}
.modtable-btn:hover{background:#1a2540;border-color:#3d5a8a;color:#93c5fd;transform:scale(1.05);}
/* MODALES */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:600;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.modal-overlay.hidden{display:none;}
.modal-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:36px 40px;display:flex;flex-direction:column;align-items:center;gap:18px;min-width:300px;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;}
.modal-icon{font-size:38px;}.modal-title{font-size:15px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;text-align:center;}
.modal-sub{font-size:12px;color:var(--muted);letter-spacing:1px;text-align:center;line-height:1.6;}
.modal-btn{width:100%;padding:13px;border-radius:8px;border:none;background:var(--green);color:#080c14;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:opacity 0.2s;}
.modal-btn:hover{opacity:0.85;}
.modal-btn.secondary{background:transparent;color:var(--muted);border:1px solid var(--border);margin-top:-6px;}
.modal-btn.secondary:hover{background:#1a2236;opacity:1;}
.mec-btn{width:100%;padding:11px 16px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.18s;text-align:left;}
.mec-btn:hover{background:#1a2540;border-color:#3d5a8a;color:#93c5fd;}
/* EXCEL */
.excel-modal-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:36px 40px;display:flex;flex-direction:column;gap:20px;min-width:340px;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;}
.excel-title{font-size:15px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;}
.excel-row{display:flex;flex-direction:column;gap:6px;}
.excel-label{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.excel-date{width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;outline:none;transition:border-color 0.2s;}
.excel-date:focus{border-color:#3d5a8a;}
.excel-info{font-size:12px;color:var(--muted);text-align:center;}
.excel-info span{color:var(--green);font-weight:700;}
.excel-btns{display:flex;gap:10px;}
.excel-btns button{flex:1;padding:12px;border-radius:8px;border:none;font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:opacity 0.2s;}
.excel-btns .btn-dl{background:var(--green);color:#080c14;}.excel-btns .btn-dl:hover{opacity:0.85;}
.excel-btns .btn-cancel{background:var(--panel);color:var(--muted);border:1px solid var(--border);}.excel-btns .btn-cancel:hover{background:#1a2236;}
/* FIX */
.fix-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:32px 36px;display:flex;flex-direction:column;gap:14px;width:90%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;max-height:90vh;overflow-y:auto;}
.fix-title{font-size:14px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;text-align:center;}
.fix-sub{font-size:12px;color:var(--muted);letter-spacing:1px;text-align:center;}
.fix-mod-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;}
.fix-mod-opt{padding:9px 4px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-family:'Courier New',monospace;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.18s;text-align:center;}
.fix-mod-opt:hover{background:#1a2540;border-color:#3d5a8a;color:#93c5fd;}
.fix-mod-opt.selected{background:#1a2540;border-color:var(--yellow);color:var(--yellow);}
/* ACUMULADO */
.acum-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:28px 32px;display:flex;flex-direction:column;gap:16px;width:95%;max-width:700px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;}
.acum-title{font-size:14px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;text-align:center;}
.acum-sub{font-size:11px;color:var(--muted);text-align:center;letter-spacing:1px;}
.acum-table{width:100%;border-collapse:collapse;}
.acum-table th{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;}
.acum-table td{font-size:13px;padding:9px 10px;border-bottom:1px solid rgba(26,34,54,0.6);font-family:'Courier New',monospace;}
.acum-table tr:last-child td{border-bottom:none;}
.acum-table tr:hover td{background:rgba(255,255,255,0.02);}
.acum-mod{font-weight:700;color:#cbd5e1;letter-spacing:2px;}
.acum-red{color:var(--red);font-weight:700;}
.acum-yellow{color:var(--yellow);font-weight:700;}
.acum-zero{color:var(--muted);}
.acum-badge{display:inline-block;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:700;font-family:'Segoe UI',sans-serif;}
.acum-badge.active-red{background:rgba(239,68,68,0.12);color:var(--red);}
.acum-badge.active-yel{background:rgba(234,179,8,0.1);color:var(--yellow);}
.acum-filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.acum-filter-sel{padding:7px 12px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:12px;font-weight:600;outline:none;cursor:pointer;transition:border-color 0.2s;}
.acum-filter-sel:focus{border-color:#3d5a8a;}
.acum-sort-btn{padding:7px 14px;border-radius:8px;border:1px solid rgba(167,139,250,0.4);background:rgba(167,139,250,0.07);color:#c4b5fd;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;}
.acum-sort-btn:hover{background:rgba(167,139,250,0.14);}
.acum-count{font-size:11px;color:var(--muted);letter-spacing:1px;margin-left:auto;}
</style>
</head>
<body>

<header>
  <div class="hd-left">
    <div class="live-dot online" id="live-dot"></div>
    <h1>Confecciones Millar</h1>
  </div>
  <div style="display:flex;align-items:center;gap:20px">
    <span class="conn-label" id="conn-label">DEMO LOCAL ‚úì</span>
    <span class="clock" id="clock">00:00:00</span>
  </div>
</header>

<div class="stats" id="stats-bar" style="display:none;">
  <div class="stat fg" id="stat-green"  onclick="toggleFilter('green')"><div class="sd g"></div><span id="cnt-g">0</span>&nbsp;Operativos</div>
  <div class="stat fy" id="stat-yellow" onclick="toggleFilter('yellow')"><div class="sd y"></div><span id="cnt-y">0</span>&nbsp;Atendiendo</div>
  <div class="stat fr" id="stat-red"    onclick="toggleFilter('red')"><div class="sd r"></div><span id="cnt-r">0</span>&nbsp;Alerta</div>
  <span class="filter-hint" id="filter-hint"></span>
  <div class="view-toggle">
    <button class="btn-bar purple" onclick="openAcumuladoModal()">üìä Acumulado</button>
    <button class="btn-bar green"  id="btn-excel-bar" style="display:none;" onclick="openExcelModal()">üì• Excel</button>
    <button class="btn-bar yellow" id="btn-fix-mec"   style="display:none;" onclick="openFixMecModal()">üîß Corregir</button>
    <button class="btn-bar red"    id="btn-cambiar-user" style="display:none;" onclick="volverLogin()">üë§ Cambiar usuario</button>

    <button class="btn-bar blue"   onclick="atrasDesdeTablero()">‚¨Ö Atr√°s</button>
  </div>
</div>

<div id="nav-single">
  <button class="btn-bar" onclick="cambiarModulo()">üì± Cambiar M√≥dulo</button>
  <button class="btn-bar blue" onclick="atrasDesdeModulo()">‚¨Ö Atr√°s</button>
</div>

<main>
  <div id="grid-view" class="hidden"><div class="grid" id="grid"></div></div>
  <div id="single-view"><div id="big-container"></div></div>
</main>
<div id="toasts"></div>

<!-- PANTALLA 1: LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">üè≠</div>
    <div class="login-title">Control de Piso<span>Confecciones Millar</span></div>
    <select class="login-select" id="login-user">
      <option value="">‚Äî Selecciona tu usuario ‚Äî</option>
    </select>
    <input class="login-input" id="login-pass" type="password" maxlength="30" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
    <div class="login-error" id="login-error"></div>
    <button class="login-btn" onclick="submitLogin()">Ingresar ‚Üí</button>
  </div>
</div>

<!-- PANTALLA 2: SELECCI√ìN DE √ÅREA -->
<div class="selector-screen hidden" id="area-screen">
  <div class="sel-title" id="area-title">Bienvenido</div>
  <div class="sel-btns" id="area-btns"></div>
  <button class="sel-back" onclick="volverLogin()">‚¨Ö Cerrar sesi√≥n</button>
</div>

<!-- PANTALLA 3: LOGIN M√ìDULO INDIVIDUAL (solo usuario M√≥dulos) -->
<div class="login-screen hidden" id="modulo-login-screen">
  <div class="login-box">
    <div class="login-logo">üì±</div>
    <div class="login-title">Acceso M√≥dulo<span>Selecciona tu m√≥dulo e ingresa</span></div>
    <select class="login-select" id="modulo-sel">
      <option value="">‚Äî Selecciona tu m√≥dulo ‚Äî</option>
    </select>
    <input class="login-input" id="modulo-pass" type="password" maxlength="30" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
    <div class="login-error" id="modulo-error"></div>
    <button class="login-btn" onclick="submitModuloLogin()">Ingresar ‚Üí</button>
    <button class="sel-back" style="width:100%;margin-top:-4px;" onclick="volverAArea()">‚¨Ö Atr√°s</button>
  </div>
</div>

<!-- TABLA DE M√ìDULOS -->
<div class="modtable-screen hidden" id="modtable-screen">
  <div class="modtable-title">Selecciona tu m√≥dulo</div>
  <div class="modtable-grid" id="modtable-grid"></div>
  <button class="sel-back" onclick="volverAArea()">‚¨Ö Atr√°s</button>
</div>

<!-- MODAL: mec√°nico -->
<div class="modal-overlay hidden" id="modal-mecanico">
  <div class="modal-box" style="max-width:360px;width:90%;">
    <div class="modal-icon">üîß</div>
    <div class="modal-title" id="mec-title">¬øQui√©n atendi√≥?</div>
    <div class="modal-sub"   id="mec-sub">Selecciona el mec√°nico</div>
    <div style="width:100%;display:flex;flex-direction:column;gap:8px;" id="mec-list"></div>
    <button class="modal-btn secondary" onclick="cancelMecanico()">Cancelar</button>
  </div>
</div>

<!-- MODAL: Excel -->
<div class="modal-overlay hidden" id="excel-modal">
  <div class="excel-modal-box">
    <div class="excel-title">üì• Descargar Reporte Excel</div>
    <div class="excel-row"><label class="excel-label">Fecha inicio</label><input class="excel-date" type="date" id="date-from"></div>
    <div class="excel-row"><label class="excel-label">Fecha fin</label><input class="excel-date" type="date" id="date-to"></div>
    <div class="excel-info" id="excel-info"></div>
    <div class="excel-btns">
      <button class="btn-cancel" onclick="closeExcelModal()">Cancelar</button>
      <button class="btn-dl"     onclick="downloadExcel()">‚¨á Descargar</button>
    </div>
  </div>
</div>

<!-- MODAL: Corregir mec√°nico -->
<div class="modal-overlay hidden" id="modal-fix-mec">
  <div class="fix-box">
    <div class="fix-title">üîß Corregir Mec√°nico</div>
    <div class="fix-sub" id="fix-step-lbl">Paso 1 ‚Äî Selecciona el m√≥dulo</div>
    <div class="fix-mod-grid" id="fix-mod-grid"></div>
    <div id="fix-mec-section" style="display:none;flex-direction:column;gap:8px;">
      <div class="fix-sub">Paso 2 ‚Äî Selecciona el mec√°nico correcto</div>
      <div id="fix-mec-list" style="display:flex;flex-direction:column;gap:7px;"></div>
    </div>
    <button class="modal-btn secondary" onclick="closeFixMecModal()">Cancelar</button>
  </div>
</div>

<!-- MODAL: Acumulado -->
<div class="modal-overlay hidden" id="modal-acumulado">
  <div class="acum-box">
    <div class="acum-title">üìä Tiempo Acumulado por M√≥dulo</div>
    <div class="acum-sub" id="acum-fecha"></div>
    <div class="acum-filters">
      <select class="acum-filter-sel" id="acum-f-modulo" onchange="renderAcumulado()">
        <option value="">Todos los m√≥dulos</option>
      </select>
      <select class="acum-filter-sel" id="acum-f-estado" onchange="renderAcumulado()">
        <option value="">Todos los estados</option>
        <option value="red">üî¥ Alerta</option>
        <option value="yellow">üü° Atendiendo</option>
        <option value="green">üü¢ Operativo</option>
        <option value="contiempo">‚è± Con tiempo &gt; 0</option>
      </select>
      <button class="acum-sort-btn" id="acum-sort-btn" onclick="toggleAcumSort()">‚Üì Mayor tiempo</button>
      <span class="acum-count" id="acum-count"></span>
    </div>
    <table class="acum-table">
      <thead>
        <tr>
          <th>M√≥dulo</th>
          <th>Estado</th>
          <th>üî¥ Alerta acum.</th>
          <th>üü° Atendiendo acum.</th>
          <th>‚è± Total parado</th>
        </tr>
      </thead>
      <tbody id="acum-tbody"></tbody>
    </table>
    <button class="modal-btn secondary" onclick="closeAcumuladoModal()">Cerrar</button>
  </div>
</div>

<script>
const MODULES=['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27'];
const LABELS={green:'Operativo',yellow:'Atendiendo',red:'Alerta'};
const NEXT={green:'red',red:'yellow',yellow:'green'};
const MECANICOS=['ANDRES RIOS','CESAR CIFUENTES','DAIRON ZAPATA','ELKIN LOPEZ','JUAN C GONZALEZ','OSCAR ZEA','RICARDO SERNA','WALTER PEREZ','YON CANO'];

const USUARIOS={
  'Programador':  {pass:'1',perms:['area_mecanicos','area_produccion','tablero','modulos','excel','fix']},
  'Administrador':{pass:'1',perms:['area_mecanicos','tablero','excel']},
  'Modulos':      {pass:'1',perms:['area_produccion','modulos']},
  'Televisor':    {pass:'1',perms:['area_mecanicos','tablero']},
  'Mecanicos':    {pass:'1',perms:['area_mecanicos','tablero']},
};

const states={}, timers={}, lastMec={}, acumRed={}, acumYellow={};
MODULES.forEach(id=>{ states[id]='green'; timers[id]=Date.now(); lastMec[id]=''; acumRed[id]=0; acumYellow[id]=0; });

let selectedMod=null, activeFilter=null, currentView=null, pendingTransicion=null, currentUser=null;
function hasPerm(p){ return currentUser&&USUARIOS[currentUser]&&USUARIOS[currentUser].perms.includes(p); }
function isProg(){ return hasPerm('fix')&&hasPerm('modulos')&&hasPerm('tablero'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET ‚Äî Conexi√≥n en tiempo real
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ws=null, wsReady=false, reconnectTimer=null;

function connectWS(){
  const proto=location.protocol==='https:'?'wss':'ws';
  const url=`${proto}://${location.host}`;
  ws=new WebSocket(url);

  ws.onopen=()=>{
    wsReady=true;
    clearTimeout(reconnectTimer);
    setConnStatus(true);
  };

  ws.onmessage=(e)=>{
    try{
      const msg=JSON.parse(e.data);
      if(msg.type==='init'){
        // Recibir estado completo del servidor al conectar
        MODULES.forEach(id=>{
          if(msg.states[id] && msg.states[id]!==states[id]){
            states[id]=msg.states[id];
            timers[id]=Date.now();
          }
          if(msg.lastMec[id]) lastMec[id]=msg.lastMec[id];
        });
        updateStats();
        if(currentView==='grid') renderGrid();
        if(currentView==='single') renderBig();
      } else if(msg.type==='change'){
        // Cambio de otro dispositivo ‚Äî aplicar localmente sin reenviar
        const id=msg.id, s=msg.state;
        const prev=states[id];
        const dur=Date.now()-(timers[id]||Date.now());
        if(prev==='red')    acumRed[id]   +=dur;
        if(prev==='yellow') acumYellow[id]+=dur;
        states[id]=s; timers[id]=Date.now();
        if(s==='red') lastMec[id]='';
        else if(msg.mecanico) lastMec[id]=msg.mecanico;
        if(s==='red'&&currentUser==='Televisor') playAlertSound();
        updateStats();
        if(selectedMod===id) renderBig();
        renderGrid();
      }
    }catch(err){}
  };

  ws.onclose=()=>{
    wsReady=false;
    setConnStatus(false);
    // Reconectar autom√°ticamente cada 3 segundos
    reconnectTimer=setTimeout(connectWS, 3000);
  };

  ws.onerror=()=>{ ws.close(); };
}

function setConnStatus(online){
  const dot=document.getElementById('live-dot');
  const lbl=document.getElementById('conn-label');
  if(online){
    dot.className='live-dot online';
    lbl.textContent='EN L√çNEA ‚úì';
    lbl.style.color='var(--green)';
  } else {
    dot.className='live-dot offline';
    lbl.textContent='RECONECTANDO...';
    lbl.style.color='var(--red)';
  }
}

function wsSend(payload){
  if(ws && wsReady && ws.readyState===1){
    ws.send(JSON.stringify(payload));
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIAL ‚Äî Se guarda en localStorage del servidor (server.js lo persiste si quieres)
// Por ahora sigue en localStorage del navegador para el Excel
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY='mant_historial_v2';
function loadHistory(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch(e){return[];} }
function saveHistory(h){ try{localStorage.setItem(STORAGE_KEY,JSON.stringify(h));}catch(e){} }
function logChange(modulo,prev,next,durMs,mecanico){
  if(!((prev==='red'&&next==='yellow')||(prev==='yellow'&&next==='green'))) return;
  const h=loadHistory();
  h.push({fecha:new Date().toLocaleDateString('es-CO'),modulo,estadoAnterior:prev,estadoNuevo:next,durMinutos:parseFloat((durMs/60000).toFixed(2)),mecanico:mecanico||''});
  if(h.length>10000) h.splice(0,h.length-10000);
  saveHistory(h);
}

// ‚îÄ‚îÄ SONIDO ALERTA (SIRENA AMBULANCIA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx=null;
function playAlertSound(){
  try{
    if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    const durTotal=6;
    const ciclo=0.6;
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type='sawtooth';
    g.gain.setValueAtTime(0.85, audioCtx.currentTime);
    g.gain.setValueAtTime(0.85, audioCtx.currentTime+durTotal-0.1);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+durTotal);
    const t0=audioCtx.currentTime;
    for(let i=0;i<Math.floor(durTotal/ciclo);i++){
      const t=t0+(i*ciclo);
      const freqStart=i%2===0?700:1050;
      const freqEnd  =i%2===0?1050:700;
      o.frequency.setValueAtTime(freqStart, t);
      o.frequency.linearRampToValueAtTime(freqEnd, t+ciclo);
    }
    o.start(audioCtx.currentTime);
    o.stop(audioCtx.currentTime+durTotal);
  }catch(e){}
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateLoginSelect(){
  const sel = document.getElementById('login-user');
  const prev = sel.value;
  sel.innerHTML = '<option value="">‚Äî Selecciona tu usuario ‚Äî</option>';
  // Usuarios activos ordenados alfab√©ticamente
  const cfg = loadConfig();
  const extras = (cfg._usuarios_extra||[]).filter(u=>!u.disabled);
  const allNames = Object.entries(USUARIOS)
    .filter(([k,v])=> v.perms && v.perms.length > 0) // solo habilitados
    .map(([k])=>k)
    .concat(extras.map(u=>u.nombre))
    .filter((v,i,a)=>a.indexOf(v)===i) // deduplicar
    .sort((a,b)=>a.localeCompare(b));
  allNames.forEach(nombre=>{
    const o = document.createElement('option');
    o.value = nombre;
    o.textContent = nombre;
    sel.appendChild(o);
  });
  if(prev) sel.value = prev;
}

window.addEventListener('DOMContentLoaded',()=>{
  applyConfig();
  rebuildModules();
  populateLoginSelect();
  updateStats();
  setConnStatus(false);
  connectWS();
  document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')submitLogin();});
  document.getElementById('modulo-pass').addEventListener('keydown',e=>{if(e.key==='Enter')submitModuloLogin();});
  const msel=document.getElementById('modulo-sel');
  MODULES.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;msel.appendChild(o);});
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANTALLA 1 ‚Äî LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function submitLogin(){
  const usuario=document.getElementById('login-user').value;
  const pass=document.getElementById('login-pass').value;
  const err=document.getElementById('login-error');
  const inp=document.getElementById('login-pass');
  if(!usuario){err.textContent='Selecciona un usuario';return;}
  if(!USUARIOS[usuario]){err.textContent='Usuario no v√°lido';return;}
  // Usuario M√≥dulos entra sin contrase√±a
  if(usuario==='Modulos'){
    currentUser=usuario;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('login-pass').value='';
    document.getElementById('login-error').textContent='';
    mostrarAreaScreen();return;
  }
  if(pass!==USUARIOS[usuario].pass){
    inp.classList.add('error');err.textContent='Contrase√±a incorrecta';inp.value='';
    setTimeout(()=>{inp.classList.remove('error');inp.focus();},400);return;
  }
  currentUser=usuario;
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('login-pass').value='';
  document.getElementById('login-error').textContent='';
  mostrarAreaScreen();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANTALLA 2 ‚Äî SELECCI√ìN DE √ÅREA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mostrarAreaScreen(){
  const btns=document.getElementById('area-btns');btns.innerHTML='';
  document.getElementById('area-title').textContent='Bienvenido, '+currentUser;
  if(hasPerm('area_mecanicos')){
    const b=document.createElement('button');b.className='sel-btn mec-btn';
    b.innerHTML='üîß&nbsp; MEC√ÅNICOS';
    b.onclick=()=>elegirArea('mecanicos');
    btns.appendChild(b);
  }
  if(hasPerm('area_produccion')){
    const b=document.createElement('button');b.className='sel-btn prod-btn';
    b.innerHTML='üè≠&nbsp; PRODUCCI√ìN';
    b.onclick=()=>elegirArea('produccion');
    btns.appendChild(b);
  }
  if(isProg()){
    const b=document.createElement('button');b.className='sel-btn';
    b.style.cssText='border-color:rgba(167,139,250,0.35);';
    b.innerHTML='‚öôÔ∏è&nbsp; CONFIGURACI√ìN';
    b.onmouseover=()=>b.style.cssText='border-color:rgba(167,139,250,0.7);box-shadow:0 4px 20px rgba(167,139,250,0.12);';
    b.onmouseout=()=>b.style.cssText='border-color:rgba(167,139,250,0.35);';
    b.onclick=()=>{ document.getElementById('area-screen').classList.add('hidden'); openConfigModal(); };
    btns.appendChild(b);
  }
  document.getElementById('area-screen').classList.remove('hidden');
}

function elegirArea(area){
  document.getElementById('area-screen').classList.add('hidden');
  if(area==='mecanicos'){
    entrarTablero();
  } else {
    if(currentUser==='Modulos'){
      document.getElementById('modulo-pass').value='';
      document.getElementById('modulo-error').textContent='';
      document.getElementById('modulo-login-screen').classList.remove('hidden');
    } else {
      abrirModtable();
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANTALLA 3 ‚Äî LOGIN M√ìDULO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function submitModuloLogin(){
  const modulo=document.getElementById('modulo-sel').value;
  const pass=document.getElementById('modulo-pass').value;
  const err=document.getElementById('modulo-error');
  const inp=document.getElementById('modulo-pass');
  if(!modulo){err.textContent='Selecciona tu m√≥dulo';return;}
  // Contrase√±a personalizada o por defecto el nombre del m√≥dulo
  const cfg=loadConfig();
  const customPass=(cfg._modulos_pass||{})[modulo];
  const expected = customPass || modulo;
  if(pass.toUpperCase()!==expected.toUpperCase()){
    inp.classList.add('error');err.textContent='Contrase√±a incorrecta';inp.value='';
    setTimeout(()=>{inp.classList.remove('error');inp.focus();},400);return;
  }
  selectedMod=modulo;
  document.getElementById('modulo-login-screen').classList.add('hidden');
  document.getElementById('modulo-pass').value='';
  document.getElementById('modulo-error').textContent='';
  setView('single');
}

// ‚îÄ‚îÄ NAVEGACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function volverLogin(){
  ocultarTodo();currentUser=null;selectedMod=null;
  populateLoginSelect();
  document.getElementById('login-user').value='';
  document.getElementById('login-pass').value='';
  document.getElementById('login-error').textContent='';
  document.getElementById('login-screen').classList.remove('hidden');
}
function volverAArea(){
  ['modulo-login-screen','modtable-screen'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  mostrarAreaScreen();
}
function ocultarTodo(){
  ['area-screen','modulo-login-screen','modtable-screen'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('stats-bar').style.display='none';
  document.getElementById('nav-single').style.display='none';
  document.getElementById('grid-view').classList.add('hidden');
  document.getElementById('single-view').classList.remove('active');
  currentView=null;
}
function entrarTablero(){ setView('grid'); }
function abrirModtable(){
  const grid=document.getElementById('modtable-grid');grid.innerHTML='';
  MODULES.forEach(id=>{
    const btn=document.createElement('button');btn.className='modtable-btn';btn.textContent=id;
    btn.addEventListener('click',()=>{selectedMod=id;document.getElementById('modtable-screen').classList.add('hidden');setView('single');});
    grid.appendChild(btn);
  });
  document.getElementById('modtable-screen').classList.remove('hidden');
}
function cambiarModulo(){
  if(currentUser==='Modulos'){
    document.getElementById('modulo-pass').value='';
    document.getElementById('modulo-error').textContent='';
    document.getElementById('single-view').classList.remove('active');
    document.getElementById('nav-single').style.display='none';
    currentView=null;
    document.getElementById('modulo-login-screen').classList.remove('hidden');
    return;
  }
  document.getElementById('single-view').classList.remove('active');
  document.getElementById('nav-single').style.display='none';
  currentView=null;abrirModtable();
}
function atrasDesdeTablero(){
  document.getElementById('stats-bar').style.display='none';
  document.getElementById('grid-view').classList.add('hidden');
  currentView=null;mostrarAreaScreen();
}
function atrasDesdeModulo(){
  document.getElementById('nav-single').style.display='none';
  document.getElementById('single-view').classList.remove('active');
  currentView=null;volverAArea();
}

// ‚îÄ‚îÄ VISTAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setView(v){
  currentView=v;
  document.getElementById('grid-view').classList.toggle('hidden',v==='single');
  document.getElementById('single-view').classList.toggle('active',v==='single');
  document.getElementById('stats-bar').style.display  =v==='grid'  ?'flex':'none';
  document.getElementById('nav-single').style.display =v==='single'?'flex':'none';
  if(v==='grid'){
    document.getElementById('btn-excel-bar').style.display  =hasPerm('excel')?'':'none';
    document.getElementById('btn-fix-mec').style.display    =hasPerm('fix')  ?'':'none';
    document.getElementById('btn-cambiar-user').style.display=isProg()       ?'':'none';
  }
  if(v==='grid')   renderGrid();
  if(v==='single') renderBig();
}

// ‚îÄ‚îÄ ESTADOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyChange(id,s){
  const prev=states[id];if(prev===s)return;
  const needsMec=(prev==='red'&&s==='yellow')||(prev==='yellow'&&s==='green');
  if(needsMec){
    pendingTransicion={id,estado:s};
    openMecanicoModal(
      prev==='red'?'¬øQui√©n lleg√≥ a atender?':'¬øQui√©n solucion√≥ la falla?',
      prev==='red'?'Mec√°nico que atendi√≥ el llamado':'Mec√°nico que resolvi√≥ el problema'
    );return;
  }
  commitChange(id,s,null);
}
function openMecanicoModal(titulo,subtitulo){
  document.getElementById('mec-title').textContent=titulo;
  document.getElementById('mec-sub').textContent=subtitulo;
  const list=document.getElementById('mec-list');list.innerHTML='';
  MECANICOS.forEach(nombre=>{
    const btn=document.createElement('button');btn.className='mec-btn';btn.textContent='üîß '+nombre;
    btn.addEventListener('click',()=>selectMecanico(nombre));list.appendChild(btn);
  });
  document.getElementById('modal-mecanico').classList.remove('hidden');
}
function selectMecanico(nombre){
  document.getElementById('modal-mecanico').classList.add('hidden');
  if(pendingTransicion){commitChange(pendingTransicion.id,pendingTransicion.estado,nombre);pendingTransicion=null;}
}
function cancelMecanico(){document.getElementById('modal-mecanico').classList.add('hidden');pendingTransicion=null;}

function commitChange(id,s,mecanico){
  const prev=states[id],ahora=Date.now();
  const dur=ahora-(timers[id]||ahora);
  if(prev==='red')    acumRed[id]   +=dur;
  if(prev==='yellow') acumYellow[id]+=dur;
  logChange(id,prev,s,dur,mecanico);
  states[id]=s;timers[id]=ahora;
  if(mecanico) lastMec[id]=mecanico;
  if(s==='red') lastMec[id]=''; // Resetear mec√°nico al volver a alerta
  if(s==='red'&&currentUser==='Televisor') playAlertSound();
  // Enviar cambio al servidor para sincronizar otros dispositivos
  wsSend({type:'change', id, state:s, mecanico:mecanico||''});
  updateStats();if(selectedMod===id)renderBig();showToast(id,s);renderGrid();
}

function toggleFilter(color){
  activeFilter=activeFilter===color?null:color;
  ['green','yellow','red'].forEach(c=>document.getElementById('stat-'+c).classList.toggle('active-filter',activeFilter===c));
  document.getElementById('filter-hint').textContent=activeFilter?`Filtrando: ${LABELS[activeFilter]}  ¬∑  Toca de nuevo para ver todos`:'';
  renderGrid();
}
function renderGrid(){
  const grid=document.getElementById('grid');grid.innerHTML='';
  const visible=activeFilter?MODULES.filter(id=>states[id]===activeFilter):MODULES;
  const cols=visible.length<=3?visible.length:visible.length<=9?3:visible.length<=12?4:visible.length<=18?6:9;
  grid.style.gridTemplateColumns=`repeat(${Math.max(1,cols)},1fr)`;
  if(!visible.length){grid.innerHTML='<div class="empty-msg">‚úÖ No hay m√≥dulos en este estado</div>';return;}
  const canClick=hasPerm('fix');
  visible.forEach(id=>{
    const s=states[id];
    const div=document.createElement('div');
    div.className=`module ${canClick?'clickable':'readonly'} ${s}`;div.id=`mod-${id}`;
    const mecHtml=(s==='yellow'||s==='red')&&lastMec[id]?`<span class="mod-mec">üîß ${lastMec[id]}</span>`:`<span class="mod-mec"></span>`;
    div.innerHTML=`<span class="mod-id">${id}</span><div class="light"></div><span class="mod-label">${LABELS[s]}</span><span class="mod-timer" id="timer-${id}"></span>${mecHtml}`;
    if(canClick) div.addEventListener('click',e=>{addRipple(div,e);applyChange(id,NEXT[states[id]]);});
    grid.appendChild(div);
  });
}
function updateStats(){
  let g=0,y=0,r=0;
  Object.values(states).forEach(s=>{if(s==='green')g++;else if(s==='yellow')y++;else r++;});
  document.getElementById('cnt-g').textContent=g;
  document.getElementById('cnt-y').textContent=y;
  document.getElementById('cnt-r').textContent=r;
}
function formatTime(ms){
  const s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60);
  if(h>0)return`${h}h ${String(m%60).padStart(2,'0')}m`;
  if(m>0)return`${m}m ${String(s%60).padStart(2,'0')}s`;
  return`${s}s`;
}
setInterval(()=>{
  const now=Date.now();
  MODULES.forEach(id=>{const el=document.getElementById(`timer-${id}`);if(el)el.textContent=(states[id]==='red'||states[id]==='yellow')?'‚è± '+formatTime(now-timers[id]):'';});
  const bt=document.getElementById('big-timer');
  if(bt&&selectedMod&&(states[selectedMod]==='red'||states[selectedMod]==='yellow'))bt.textContent='‚è± '+formatTime(now-timers[selectedMod]);
  else if(bt)bt.textContent='';
},1000);
function renderBig(){
  if(!selectedMod)return;
  const s=states[selectedMod];
  const tt=(s==='red'||s==='yellow')?'‚è± '+formatTime(Date.now()-timers[selectedMod]):'';
  document.getElementById('big-container').innerHTML=`
    <div class="big-wrap ${s}" id="big-mod">
      <span class="big-id">${selectedMod}</span><div class="big-light"></div>
      <span class="big-status">${LABELS[s]}</span>
      <span class="big-timer" id="big-timer">${tt}</span>
      <span class="tap-hint">Toca para cambiar estado</span>
    </div>`;
  document.getElementById('big-mod').addEventListener('click',e=>{addRipple(document.getElementById('big-mod'),e);applyChange(selectedMod,NEXT[states[selectedMod]]);});
}

// ‚îÄ‚îÄ MODAL ACUMULADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let acumSortDesc=true;
function openAcumuladoModal(){
  const fMod=document.getElementById('acum-f-modulo');
  const prev=fMod.value;
  fMod.innerHTML='<option value="">Todos los m√≥dulos</option>';
  MODULES.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;fMod.appendChild(o);});
  fMod.value=prev;
  document.getElementById('acum-f-estado').value='';
  document.getElementById('acum-fecha').textContent='Sesi√≥n actual ‚Äî '+new Date().toLocaleDateString('es-CO',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('modal-acumulado').classList.remove('hidden');
  renderAcumulado();
}
function toggleAcumSort(){
  acumSortDesc=!acumSortDesc;
  document.getElementById('acum-sort-btn').textContent=acumSortDesc?'‚Üì Mayor tiempo':'‚Üë Menor tiempo';
  renderAcumulado();
}
function renderAcumulado(){
  const now=Date.now();
  const filtMod=document.getElementById('acum-f-modulo').value;
  const filtEst=document.getElementById('acum-f-estado').value;
  let rows=MODULES.map(id=>{
    const s=states[id];
    const cur=now-timers[id];
    const totalR=acumRed[id]   +(s==='red'   ?cur:0);
    const totalY=acumYellow[id]+(s==='yellow' ?cur:0);
    const total=totalR+totalY;
    return{id,s,totalR,totalY,total};
  });
  if(filtMod) rows=rows.filter(r=>r.id===filtMod);
  if(filtEst==='red')            rows=rows.filter(r=>r.s==='red');
  else if(filtEst==='yellow')    rows=rows.filter(r=>r.s==='yellow');
  else if(filtEst==='green')     rows=rows.filter(r=>r.s==='green');
  else if(filtEst==='contiempo') rows=rows.filter(r=>r.total>0);
  rows.sort((a,b)=>acumSortDesc?(b.total-a.total):(a.total-b.total));
  const tbody=document.getElementById('acum-tbody');tbody.innerHTML='';
  rows.forEach(({id,s,totalR,totalY,total})=>{
    let badge='';
    if(s==='red')         badge='<span class="acum-badge active-red">üî¥ Alerta</span>';
    else if(s==='yellow') badge='<span class="acum-badge active-yel">üü° Atendiendo</span>';
    else                  badge='<span style="color:var(--green);font-size:12px;">üü¢ Operativo</span>';
    const fR=totalR>0?`<span class="acum-red">${formatTime(totalR)}</span>`:'<span class="acum-zero">‚Äî</span>';
    const fY=totalY>0?`<span class="acum-yellow">${formatTime(totalY)}</span>`:'<span class="acum-zero">‚Äî</span>';
    const fT=total>0?`<b style="color:#e2e8f0">${formatTime(total)}</b>`:'<span class="acum-zero">‚Äî</span>';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="acum-mod">${id}</td><td>${badge}</td><td>${fR}</td><td>${fY}</td><td>${fT}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('acum-count').textContent=`${rows.length} de ${MODULES.length} m√≥dulos`;
}
function closeAcumuladoModal(){document.getElementById('modal-acumulado').classList.add('hidden');}

// ‚îÄ‚îÄ CORREGIR MEC√ÅNICO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFixMecModal(){
  const grid=document.getElementById('fix-mod-grid');grid.innerHTML='';
  document.getElementById('fix-mec-section').style.display='none';
  document.getElementById('fix-step-lbl').textContent='Paso 1 ‚Äî Selecciona el m√≥dulo';
  MODULES.forEach(id=>{
    const btn=document.createElement('button');btn.className='fix-mod-opt';btn.textContent=id;
    btn.addEventListener('click',()=>fixSelectMod(id,btn));grid.appendChild(btn);
  });
  document.getElementById('modal-fix-mec').classList.remove('hidden');
}
function fixSelectMod(id,btn){
  document.querySelectorAll('.fix-mod-opt').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('fix-step-lbl').textContent=`M√≥dulo ${id} ‚Äî Paso 2: elige mec√°nico`;
  const sec=document.getElementById('fix-mec-section');sec.style.display='flex';sec.style.flexDirection='column';
  const list=document.getElementById('fix-mec-list');list.innerHTML='';
  MECANICOS.forEach(nombre=>{
    const b=document.createElement('button');b.className='mec-btn';b.textContent='üîß '+nombre;
    b.addEventListener('click',()=>{lastMec[id]=nombre;renderGrid();closeFixMecModal();showToastSimple(`‚úÖ ${id} ‚Üí ${nombre}`);});
    list.appendChild(b);
  });
}
function closeFixMecModal(){document.getElementById('modal-fix-mec').classList.add('hidden');}

// ‚îÄ‚îÄ EXCEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openExcelModal(){
  const today=new Date(),toStr=d=>d.toISOString().slice(0,10);
  const weekAgo=new Date(today);weekAgo.setDate(today.getDate()-7);
  document.getElementById('date-from').value=toStr(weekAgo);
  document.getElementById('date-to').value=toStr(today);
  document.getElementById('excel-modal').classList.remove('hidden');
  updateExcelInfo();
  document.getElementById('date-from').oninput=updateExcelInfo;
  document.getElementById('date-to').oninput=updateExcelInfo;
}
function closeExcelModal(){document.getElementById('excel-modal').classList.add('hidden');}
function filteredHistory(){
  const from=document.getElementById('date-from').value,to=document.getElementById('date-to').value;
  if(!from||!to)return[];
  return loadHistory().filter(r=>{const p=r.fecha.split('/');if(p.length!==3)return false;const iso=`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;return iso>=from&&iso<=to;});
}
function updateExcelInfo(){const f=filteredHistory();document.getElementById('excel-info').innerHTML=`Se exportar√°n <span>${f.length}</span> registro${f.length!==1?'s':''} en el rango seleccionado`;}
function downloadExcel(){
  const rows=filteredHistory();
  if(!rows.length){document.getElementById('excel-info').innerHTML='<span style="color:var(--red)">No hay registros en ese rango</span>';return;}
  const data=rows.map(r=>({'Fecha':r.fecha,'M√≥dulo':r.modulo,'Transici√≥n':`${LABELS[r.estadoAnterior]} ‚Üí ${LABELS[r.estadoNuevo]}`,'Duraci√≥n (minutos)':r.durMinutos,'Mec√°nico':r.mecanico||''}));
  const ws2=XLSX.utils.json_to_sheet(data);ws2['!cols']=[{wch:12},{wch:8},{wch:28},{wch:20},{wch:22}];
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws2,'Historial');
  const desde=document.getElementById('date-from').value.replace(/-/g,''),hasta=document.getElementById('date-to').value.replace(/-/g,'');
  XLSX.writeFile(wb,`mecanicos_millar_${desde}_${hasta}.xlsx`);
  closeExcelModal();showToastSimple('‚úÖ Excel descargado correctamente');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACIONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Lista maestra de permisos ‚Äî agregar aqu√≠ cada nueva pantalla/funci√≥n
const ALL_PERMS = [
  {key:'area_mecanicos', label:'Ver Tablero Mec√°nicos'},
  {key:'tablero',        label:'Tablero Planta'},
  {key:'excel',          label:'Descargar Excel'},
  {key:'area_produccion',label:'√Årea Producci√≥n'},
  {key:'modulos',        label:'M√≥dulos (Vista M√≥dulo)'},
  {key:'fix',            label:'Corregir Mec√°nico'},
];
const PERM_LABELS = Object.fromEntries(ALL_PERMS.map(p=>[p.key,p.label]));

const CONFIG_PERMS = {
  'Administrador': {label:'Administrador', available:ALL_PERMS.map(p=>p.key)},
  'Televisor':     {label:'Televisor',     available:ALL_PERMS.map(p=>p.key)},
  'Mecanicos':     {label:'Mec√°nicos',     available:ALL_PERMS.map(p=>p.key)},
  'Modulos':       {label:'M√≥dulos',       available:ALL_PERMS.map(p=>p.key)},
};
const CONFIG_KEY = 'millar_config_v1';

function loadConfig(){
  try{ return JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}'); }catch(e){ return {}; }
}
function saveConfig(cfg){ localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg)); }

function applyConfig(){
  const cfg = loadConfig();
  // Aplicar cambios a usuarios base
  Object.keys(CONFIG_PERMS).forEach(user=>{
    if(!cfg[user]) return;
    if(cfg[user].disabled){ delete USUARIOS[user]; return; }
    if(cfg[user].perms) USUARIOS[user].perms = cfg[user].perms;
  });
  // Cargar usuarios extra creados manualmente
  (cfg._usuarios_extra||[]).forEach(u=>{
    if(u.disabled){ delete USUARIOS[u.nombre]; return; }
    USUARIOS[u.nombre] = {pass: u.pass, perms: u.perms||[]};
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACIONES ‚Äî 3 pesta√±as: Usuarios | M√≥dulos | Permisos
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentCfgTab = 'usuarios';
let userFormMode = null; // 'create' | 'edit'
let userFormTarget = null; // nombre del usuario editado
let modFormMode = null;
let modFormTarget = null;
let deleteCallback = null;

function openConfigModal(){
  currentCfgTab = 'usuarios';
  document.getElementById('modal-config').classList.remove('hidden');
  const s = document.getElementById('cfg-search');
  if(s) s.value = '';
  switchCfgTab('usuarios');
}

function onCfgSearch(){
  if(currentCfgTab==='usuarios')  renderCfgUsuarios();
  if(currentCfgTab==='modulos')   renderCfgModulos();
  if(currentCfgTab==='permisos')  renderCfgPermisos();
}

function getCfgSearchQuery(){
  const el = document.getElementById('cfg-search');
  return el ? el.value.trim().toLowerCase() : '';
}

function onCfgCrear(){
  if(currentCfgTab==='usuarios') openUserForm('create');
  if(currentCfgTab==='modulos')  openModForm('create');
}
function closeConfigModal(){
  document.getElementById('modal-config').classList.add('hidden');
  populateLoginSelect();
  if(currentView===null) mostrarAreaScreen();
}
function switchCfgTab(tab){
  currentCfgTab = tab;
  const s = document.getElementById('cfg-search');
  if(s) s.value = '';
  const btnCrear = document.getElementById('cfg-btn-crear');
  if(btnCrear) btnCrear.style.display = tab==='permisos' ? 'none' : '';
  ['usuarios','modulos','permisos'].forEach(t=>{
    const btn = document.getElementById('cfg-tab-'+t);
    if(t===tab){ btn.style.background='var(--green)'; btn.style.color='#080c14'; btn.style.borderColor='var(--green)'; }
    else { btn.style.background='transparent'; btn.style.color='var(--muted)'; btn.style.borderColor='var(--border)'; }
  });
  if(tab==='usuarios')  renderCfgUsuarios();
  if(tab==='modulos')   renderCfgModulos();
  if(tab==='permisos')  renderCfgPermisos();
}

// ‚îÄ‚îÄ PESTA√ëA USUARIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCfgUsuarios(){
  // Usuarios base del sistema (no editables = Programador)
  const base = {};
  Object.entries(USUARIOS).forEach(([k,v])=>{ base[k]={pass:v.pass, perms:v.perms, builtin: k==='Programador'}; });
  // Merge con extras guardados en config
  const cfg = loadConfig();
  if(cfg._usuarios_extra){ cfg._usuarios_extra.forEach(u=>{ base[u.nombre]={pass:u.pass, perms:u.perms||[], disabled:!!u.disabled, extra:true}; }); }
  return base;
}
function getUsuariosExtra(){
  const cfg = loadConfig(); return cfg._usuarios_extra||[];
}
function saveUsuariosExtra(arr){
  const cfg = loadConfig(); cfg._usuarios_extra=arr; saveConfig(cfg);
}

function renderCfgUsuarios(){
  const container = document.getElementById('cfg-content');
  container.innerHTML = '';


  const q = getCfgSearchQuery();
  const allUsers = getCfgUsuarios();
  Object.entries(allUsers)
    .sort(([a],[b])=>a.localeCompare(b))
    .filter(([nombre])=> !q || nombre.toLowerCase().includes(q)).forEach(([nombre, data])=>{
    const card = document.createElement('div');
    const isDisabled = !!data.disabled;
    const isBuiltin = !!data.builtin;
    card.style.cssText='background:#080c14;border:1px solid #1a2236;border-radius:10px;padding:13px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;';
    // Info
    const info = document.createElement('div');
    info.style.cssText='flex:1;min-width:0;';
    info.innerHTML=`
      <div style="font-size:14px;font-weight:700;color:${isDisabled?'var(--muted)':'#f1f5f9'};display:flex;align-items:center;gap:8px;">
        ${nombre} ${isBuiltin?'<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(167,139,250,0.15);color:#c4b5fd;letter-spacing:1px;">SISTEMA</span>':''}
        ${isDisabled?'<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,0.12);color:var(--red);">INACTIVO</span>':''}
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:3px;font-family:Courier New,monospace;letter-spacing:2px;">${isBuiltin?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢':'Pass: '+data.pass}</div>`;
    card.appendChild(info);
    // Acciones
    const actions = document.createElement('div');
    actions.style.cssText='display:flex;gap:6px;flex-shrink:0;';
    if(!isBuiltin){
      const btnEdit = document.createElement('button');
      btnEdit.style.cssText='padding:6px 12px;border-radius:6px;border:1px solid rgba(99,179,237,0.3);background:transparent;color:#93c5fd;font-size:12px;font-weight:600;cursor:pointer;';
      btnEdit.textContent='‚úèÔ∏è Editar';
      btnEdit.onclick=()=>openUserForm('edit', nombre, data.pass);
      actions.appendChild(btnEdit);

      const btnToggle = document.createElement('button');
      btnToggle.style.cssText=`padding:6px 12px;border-radius:6px;border:1px solid ${isDisabled?'rgba(34,197,94,0.3)':'rgba(234,179,8,0.3)'};background:transparent;color:${isDisabled?'var(--green)':'var(--yellow)'};font-size:12px;font-weight:600;cursor:pointer;`;
      btnToggle.textContent=isDisabled?'‚úÖ Habilitar':'‚è∏ Inhabilitar';
      btnToggle.onclick=()=>toggleExtraUser(nombre);
      actions.appendChild(btnToggle);

      const btnDel = document.createElement('button');
      btnDel.style.cssText='padding:6px 12px;border-radius:6px;border:1px solid rgba(239,68,68,0.3);background:transparent;color:var(--red);font-size:12px;font-weight:600;cursor:pointer;';
      btnDel.textContent='üóë Eliminar';
      btnDel.onclick=()=>confirmDelete(`¬øEliminar usuario "${nombre}"?`, 'Esta acci√≥n no se puede deshacer.', ()=>deleteExtraUser(nombre));
      actions.appendChild(btnDel);
    } else {
      // Usuarios builtin: solo inhabilitar/habilitar (excepto Programador)
      if(nombre!=='Programador'){
        const cfg=loadConfig(); const isOff=!!(cfg[nombre]&&cfg[nombre].disabled);
        const btnToggle = document.createElement('button');
        btnToggle.style.cssText=`padding:6px 12px;border-radius:6px;border:1px solid ${isOff?'rgba(34,197,94,0.3)':'rgba(234,179,8,0.3)'};background:transparent;color:${isOff?'var(--green)':'var(--yellow)'};font-size:12px;font-weight:600;cursor:pointer;`;
        btnToggle.textContent=isOff?'‚úÖ Habilitar':'‚è∏ Inhabilitar';
        btnToggle.onclick=()=>{ toggleUserEnabled(nombre,null); renderCfgUsuarios(); };
        actions.appendChild(btnToggle);
      }
    }
    card.appendChild(actions);
    container.appendChild(card);
  });
}

function openUserForm(mode, nombre='', pass=''){
  userFormMode=mode; userFormTarget=nombre;
  document.getElementById('user-form-title').textContent = mode==='create'?'Nuevo Usuario':'Editar Usuario';
  document.getElementById('uf-nombre').value=nombre;
  document.getElementById('uf-nombre').disabled=(mode==='edit');
  document.getElementById('uf-nombre').style.opacity=(mode==='edit')?'0.5':'1';
  document.getElementById('uf-pass').value=pass;
  document.getElementById('uf-error').textContent='';
  document.getElementById('modal-user-form').classList.remove('hidden');
  setTimeout(()=>document.getElementById(mode==='create'?'uf-nombre':'uf-pass').focus(),100);
}
function closeUserForm(){ document.getElementById('modal-user-form').classList.add('hidden'); }
function saveUserForm(){
  const nombre = document.getElementById('uf-nombre').value.trim();
  const pass   = document.getElementById('uf-pass').value.trim();
  const errEl  = document.getElementById('uf-error');
  if(!nombre){ errEl.textContent='El nombre no puede estar vac√≠o'; document.getElementById('uf-nombre').style.borderColor='var(--red)'; return; }
  if(!pass)  { errEl.textContent='La contrase√±a no puede estar vac√≠a'; document.getElementById('uf-pass').style.borderColor='var(--red)'; return; }
  const extras = getUsuariosExtra();
  if(userFormMode==='create'){
    if(USUARIOS[nombre]||extras.find(u=>u.nombre===nombre)){ errEl.textContent='Ya existe un usuario con ese nombre'; return; }
    extras.push({nombre, pass, perms:[], disabled:false});
    USUARIOS[nombre]={pass, perms:[]};
  } else {
    const idx=extras.findIndex(u=>u.nombre===userFormTarget);
    if(idx>-1){ extras[idx].pass=pass; }
    if(USUARIOS[userFormTarget]) USUARIOS[userFormTarget].pass=pass;
  }
  saveUsuariosExtra(extras);
  closeUserForm();
  renderCfgUsuarios();
  showToastSimple(`‚úÖ Usuario ${userFormMode==='create'?'creado':'actualizado'}`);
}
function toggleExtraUser(nombre){
  const extras=getUsuariosExtra();
  const idx=extras.findIndex(u=>u.nombre===nombre);
  if(idx>-1){ extras[idx].disabled=!extras[idx].disabled; if(USUARIOS[nombre]) USUARIOS[nombre].perms=extras[idx].disabled?[]:extras[idx].perms; }
  saveUsuariosExtra(extras); renderCfgUsuarios();
}
function deleteExtraUser(nombre){
  const extras=getUsuariosExtra().filter(u=>u.nombre!==nombre);
  saveUsuariosExtra(extras);
  delete USUARIOS[nombre];
  renderCfgUsuarios();
  showToastSimple(`üóë Usuario "${nombre}" eliminado`);
}

// ‚îÄ‚îÄ PESTA√ëA M√ìDULOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCfgModulos(){
  const cfg=loadConfig();
  const disabled=cfg._modulos_disabled||[];
  const extra=cfg._modulos_extra||[];
  return {disabled, extra};
}
function saveCfgModulos(disabled, extra){
  const cfg=loadConfig(); cfg._modulos_disabled=disabled; cfg._modulos_extra=extra; saveConfig(cfg);
  // Reconstruir array MODULES global
  rebuildModules();
}
function rebuildModules(){
  const cfg=loadConfig();
  const base=['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27'];
  const extra=cfg._modulos_extra||[];
  const disabled=cfg._modulos_disabled||[];
  const renamed=cfg._modulos_renamed||{};
  // Rebuild global MODULES
  MODULES.length=0;
  [...base,...extra].forEach(id=>{
    if(!disabled.includes(id)) MODULES.push(renamed[id]||id);
  });
  // Init states for new modules
  MODULES.forEach(id=>{ if(states[id]===undefined){states[id]='green';timers[id]=Date.now();lastMec[id]='';acumRed[id]=0;acumYellow[id]=0;} });
}

function renderCfgModulos(){
  const container=document.getElementById('cfg-content');
  container.innerHTML='';
  const cfg=loadConfig();
  const disabled=cfg._modulos_disabled||[];
  const extra=cfg._modulos_extra||[];
  const renamed=cfg._modulos_renamed||{};
  const base=['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27'];



  // Grid de m√≥dulos
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:8px;';

  const allMods=[...base.map(id=>({id,extra:false})),...extra.map(id=>({id,extra:true}))];
  const qm = getCfgSearchQuery();
  allMods.filter(({id})=> !qm || id.toLowerCase().includes(qm) || (renamed[id]||'').toLowerCase().includes(qm)).forEach(({id,extra:isExtra})=>{
    const isDisabled=disabled.includes(id);
    const displayName=renamed[id]||id;
    const card=document.createElement('div');
    card.style.cssText=`background:#080c14;border:1px solid ${isDisabled?'#1a2236':'rgba(34,197,94,0.15)'};border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:8px;opacity:${isDisabled?'0.5':'1'};`;
    const modPassVal = (cfg._modulos_pass||{})[id]||id;
    card.innerHTML=`<div style="flex:1;min-width:0;">
      <div style="font-family:Courier New,monospace;font-size:13px;font-weight:700;color:${isDisabled?'var(--muted)':'#cbd5e1'};letter-spacing:2px;">${displayName}</div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px;letter-spacing:1px;">üîë ${modPassVal}</div>
    </div>`;
    const acts=document.createElement('div');
    acts.style.cssText='display:flex;gap:4px;';
    // Editar nombre
    const bEdit=document.createElement('button');
    bEdit.style.cssText='padding:4px 8px;border-radius:5px;border:1px solid rgba(99,179,237,0.3);background:transparent;color:#93c5fd;font-size:11px;cursor:pointer;';
    bEdit.textContent='‚úèÔ∏è';bEdit.title='Renombrar';
    bEdit.onclick=()=>openModForm('edit',id,displayName);
    acts.appendChild(bEdit);
    // Inhabilitar/habilitar
    const bToggle=document.createElement('button');
    bToggle.style.cssText=`padding:4px 8px;border-radius:5px;border:1px solid ${isDisabled?'rgba(34,197,94,0.3)':'rgba(234,179,8,0.3)'};background:transparent;color:${isDisabled?'var(--green)':'var(--yellow)'};font-size:11px;cursor:pointer;`;
    bToggle.textContent=isDisabled?'‚úÖ':'‚è∏';bToggle.title=isDisabled?'Habilitar':'Inhabilitar';
    bToggle.onclick=()=>toggleModulo(id);
    acts.appendChild(bToggle);
    // Eliminar (solo extras)
    if(isExtra){
      const bDel=document.createElement('button');
      bDel.style.cssText='padding:4px 8px;border-radius:5px;border:1px solid rgba(239,68,68,0.3);background:transparent;color:var(--red);font-size:11px;cursor:pointer;';
      bDel.textContent='üóë';bDel.title='Eliminar';
      bDel.onclick=()=>confirmDelete(`¬øEliminar m√≥dulo "${displayName}"?`,'Esta acci√≥n no se puede deshacer.',()=>deleteModulo(id));
      acts.appendChild(bDel);
    }
    card.appendChild(acts);
    grid.appendChild(card);
  });
  container.appendChild(grid);
}

function getModPass(id){
  const cfg=loadConfig();
  const passes=cfg._modulos_pass||{};
  return passes[id]||'';
}
function openModForm(mode, id='', nombre=''){
  modFormMode=mode; modFormTarget=id;
  document.getElementById('mod-form-title').textContent=mode==='create'?'Nuevo M√≥dulo':'Editar M√≥dulo';
  const nombreInput=document.getElementById('mf-nombre');
  nombreInput.value=nombre;
  nombreInput.disabled=(mode==='edit');
  nombreInput.style.opacity=(mode==='edit')?'0.5':'1';
  document.getElementById('mf-pass').value=getModPass(id);
  document.getElementById('mf-error').textContent='';
  document.getElementById('modal-mod-form').classList.remove('hidden');
  setTimeout(()=>document.getElementById(mode==='create'?'mf-nombre':'mf-pass').focus(),100);
}
function closeModForm(){ document.getElementById('modal-mod-form').classList.add('hidden'); }
function saveModForm(){
  const nombre=document.getElementById('mf-nombre').value.trim().toUpperCase();
  const pass=document.getElementById('mf-pass').value.trim();
  const errEl=document.getElementById('mf-error');
  if(!nombre){ errEl.textContent='El nombre no puede estar vac√≠o'; return; }
  const cfg=loadConfig();
  const base=['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27'];
  const extra=cfg._modulos_extra||[];
  if(!cfg._modulos_pass) cfg._modulos_pass={};
  if(modFormMode==='create'){
    if([...base,...extra].includes(nombre)){ errEl.textContent='Ya existe un m√≥dulo con ese nombre'; return; }
    extra.push(nombre);
    cfg._modulos_extra=extra;
    states[nombre]='green'; timers[nombre]=Date.now(); lastMec[nombre]=''; acumRed[nombre]=0; acumYellow[nombre]=0;
  } else {
    if(!cfg._modulos_renamed) cfg._modulos_renamed={};
    cfg._modulos_renamed[modFormTarget]=nombre;
  }
  // Guardar contrase√±a si se defini√≥
  const targetId = modFormMode==='create' ? nombre : modFormTarget;
  if(pass) cfg._modulos_pass[targetId]=pass;
  else delete cfg._modulos_pass[targetId];
  saveConfig(cfg);
  rebuildModules();
  closeModForm();
  renderCfgModulos();
  showToastSimple(`‚úÖ M√≥dulo ${modFormMode==='create'?'creado':'actualizado'}`);
}
function toggleModulo(id){
  const cfg=loadConfig();
  const disabled=cfg._modulos_disabled||[];
  const idx=disabled.indexOf(id);
  if(idx>-1) disabled.splice(idx,1); else disabled.push(id);
  cfg._modulos_disabled=disabled; saveConfig(cfg);
  rebuildModules(); renderCfgModulos();
}
function deleteModulo(id){
  const cfg=loadConfig();
  cfg._modulos_extra=(cfg._modulos_extra||[]).filter(m=>m!==id);
  cfg._modulos_disabled=(cfg._modulos_disabled||[]).filter(m=>m!==id);
  if(cfg._modulos_renamed) delete cfg._modulos_renamed[id];
  saveConfig(cfg);
  rebuildModules(); renderCfgModulos();
  showToastSimple(`üóë M√≥dulo "${id}" eliminado`);
}

// ‚îÄ‚îÄ PESTA√ëA PERMISOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCfgPermisos(){
  const cfg = loadConfig();
  const container = document.getElementById('cfg-content');
  container.innerHTML = '';
  const qp = getCfgSearchQuery();

  // Combinar usuarios base (CONFIG_PERMS) + usuarios extra creados manualmente
  const extraUsers = (cfg._usuarios_extra||[]).map(u=>([u.nombre, {label: u.nombre, isExtra: true}]));
  const baseEntries = Object.entries(CONFIG_PERMS).map(([k,v])=>([k, {...v, isExtra:false}]));
  const allEntries = [...baseEntries, ...extraUsers]
    .sort(([a],[b])=>a.localeCompare(b))
    .filter(([user, meta])=> !qp || user.toLowerCase().includes(qp) || (meta.label||'').toLowerCase().includes(qp));

  allEntries.forEach(([user, meta])=>{
    const userCfg = cfg[user] || {};
    const isDisabled = !!userCfg.disabled;
    const activePerms = userCfg.perms !== undefined ? userCfg.perms : (USUARIOS[user]?.perms || []);
    const card = document.createElement('div');
    card.style.cssText = 'background:#080c14;border:1px solid #1a2236;border-radius:12px;padding:16px;margin-bottom:12px;';
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;';
    header.innerHTML = `
      <span style="font-size:14px;font-weight:700;letter-spacing:1px;color:#f1f5f9;">${meta.label}</span>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--muted);">
        <span>${isDisabled?'Deshabilitado':'Habilitado'}</span>
        <div onclick="toggleUserEnabled('${user}',this)" style="width:40px;height:22px;border-radius:11px;background:${isDisabled?'#1a2236':'var(--green)'};border:1px solid ${isDisabled?'#2d3f5a':'var(--green)'};cursor:pointer;position:relative;transition:all 0.2s;">
          <div style="position:absolute;top:3px;${isDisabled?'left:3px':'left:19px'};width:14px;height:14px;border-radius:50%;background:${isDisabled?'var(--muted)':'#080c14'};transition:all 0.2s;"></div>
        </div>
      </label>`;
    card.appendChild(header);
    if(!isDisabled){
      const permsDiv = document.createElement('div');
      permsDiv.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:8px;';
      ALL_PERMS.forEach(({key, label})=>{
        const checked = activePerms.includes(key);
        const row = document.createElement('label');
        row.style.cssText = 'display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px;color:var(--muted);';
        row.innerHTML = `
          <input type="checkbox" data-user="${user}" data-perm="${key}" ${checked?'checked':''}
            onchange="togglePerm('${user}','${key}',this.checked)"
            style="width:16px;height:16px;accent-color:var(--green);cursor:pointer;">
          <span>${label}</span>`;
        permsDiv.appendChild(row);
      });
      card.appendChild(permsDiv);
    }
    container.appendChild(card);
  });
}

// ‚îÄ‚îÄ CONFIRM DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmDelete(titulo, sub, cb){
  deleteCallback=cb;
  document.getElementById('confirm-delete-title').textContent=titulo;
  document.getElementById('confirm-delete-sub').textContent=sub;
  document.getElementById('modal-confirm-delete').classList.remove('hidden');
}
function closeConfirmDelete(){ document.getElementById('modal-confirm-delete').classList.add('hidden'); deleteCallback=null; }
function executeDelete(){ const cb=deleteCallback; closeConfirmDelete(); if(cb) cb(); }

// ‚îÄ‚îÄ CONFIG helpers (mantener compatibilidad) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// renderConfigContent ahora redirige a la pesta√±a de permisos
function renderConfigContent(){ renderCfgPermisos(); }

function toggleUserEnabled(user, toggleEl){
  const cfg = loadConfig();
  if(!cfg[user]) cfg[user] = {};
  cfg[user].disabled = !cfg[user].disabled;
  saveConfig(cfg);
  if(cfg[user].disabled){
    USUARIOS[user] = {pass: USUARIOS[user]?.pass||'1', perms:[]};
  } else {
    const meta = CONFIG_PERMS[user];
    USUARIOS[user] = {pass: USUARIOS[user]?.pass||'1', perms: cfg[user].perms || meta.available};
  }
  if(currentCfgTab==='permisos') renderCfgPermisos();
  if(currentCfgTab==='usuarios') renderCfgUsuarios();
}

function togglePerm(user, perm, enabled){
  const cfg = loadConfig();
  if(!cfg[user]) cfg[user] = {};
  const base = cfg[user].perms !== undefined ? cfg[user].perms : (USUARIOS[user]?.perms ? [...USUARIOS[user].perms] : []);
  if(enabled){ if(!base.includes(perm)) base.push(perm); }
  else { const idx=base.indexOf(perm); if(idx>-1) base.splice(idx,1); }
  cfg[user].perms = base;
  // Si es usuario extra, tambi√©n actualizar en _usuarios_extra
  const extras = cfg._usuarios_extra||[];
  const ei = extras.findIndex(u=>u.nombre===user);
  if(ei>-1){ extras[ei].perms=base; cfg._usuarios_extra=extras; }
  saveConfig(cfg);
  if(USUARIOS[user]) USUARIOS[user].perms = base;
  else USUARIOS[user] = {pass: (extras[ei]?.pass||''), perms: base};
}

// Apply saved config on load
applyConfig();

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(id,state){const msgs={red:`üî¥ ${id} ‚Äî Solicita mec√°nico`,yellow:`üü° ${id} ‚Äî Mec√°nico en camino`,green:`üü¢ ${id} ‚Äî Resuelto`};const t=document.createElement('div');t.className=`toast ${state}`;t.textContent=msgs[state];document.getElementById('toasts').appendChild(t);setTimeout(()=>t.remove(),3200);}
function showToastSimple(msg){const t=document.createElement('div');t.className='toast green';t.textContent=msg;document.getElementById('toasts').appendChild(t);setTimeout(()=>t.remove(),3200);}
function addRipple(el,e){const r=el.getBoundingClientRect(),rip=document.createElement('div');rip.className='ripple';const sz=Math.max(r.width,r.height);rip.style.cssText=`width:${sz}px;height:${sz}px;left:${e.clientX-r.left-sz/2}px;top:${e.clientY-r.top-sz/2}px`;el.appendChild(rip);setTimeout(()=>rip.remove(),650);}
setInterval(()=>{const n=new Date();document.getElementById('clock').textContent=[n.getHours(),n.getMinutes(),n.getSeconds()].map(x=>String(x).padStart(2,'0')).join(':');},1000);
</script>


<!-- MODAL: Configuraciones -->
<div class="modal-overlay hidden" id="modal-config">
  <div style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:28px 28px 24px;display:flex;flex-direction:column;gap:16px;width:96%;max-width:580px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;">
    <div style="text-align:center;font-size:15px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;">‚öôÔ∏è CONFIGURACIONES</div>
    <!-- Pesta√±as -->
    <div style="display:flex;gap:6px;border-bottom:1px solid var(--border);padding-bottom:12px;">
      <button id="cfg-tab-usuarios"  onclick="switchCfgTab('usuarios')"  style="flex:1;padding:9px 6px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;background:var(--green);color:#080c14;font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all 0.2s;">üë§ USUARIOS</button>
      <button id="cfg-tab-modulos"   onclick="switchCfgTab('modulos')"   style="flex:1;padding:9px 6px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;background:transparent;color:var(--muted);font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all 0.2s;">üè≠ M√ìDULOS</button>
      <button id="cfg-tab-permisos"  onclick="switchCfgTab('permisos')"  style="flex:1;padding:9px 6px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;background:transparent;color:var(--muted);font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all 0.2s;">üîë PERMISOS</button>
    </div>
    <!-- Buscador + Crear -->
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="position:relative;flex:1;">
        <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none;">üîç</span>
        <input id="cfg-search" type="text" placeholder="Buscar..." oninput="onCfgSearch()"
          style="width:100%;padding:10px 14px 10px 36px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;outline:none;transition:border-color 0.2s;"
          onfocus="this.style.borderColor='#3d5a8a'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <button id="cfg-btn-crear" onclick="onCfgCrear()"
        style="padding:10px 16px;border-radius:8px;border:1px solid rgba(34,197,94,0.4);background:rgba(34,197,94,0.08);color:var(--green);font-size:13px;font-weight:700;white-space:nowrap;cursor:pointer;transition:all 0.2s;flex-shrink:0;"
        onmouseover="this.style.background='rgba(34,197,94,0.15)'" onmouseout="this.style.background='rgba(34,197,94,0.08)'">
        + Crear
      </button>
    </div>
    <!-- Contenido pesta√±as -->
    <div id="cfg-content" style="overflow-y:auto;flex:1;min-height:0;"></div>
    <button class="modal-btn secondary" onclick="closeConfigModal()" style="margin-top:4px;flex-shrink:0;">Cerrar</button>
  </div>
</div>

<!-- MODAL: Formulario usuario (crear/editar) -->
<div class="modal-overlay hidden" id="modal-user-form" style="z-index:700;">
  <div class="modal-box" style="max-width:360px;width:92%;gap:14px;">
    <div class="modal-title" id="user-form-title">Nuevo Usuario</div>
    <div style="width:100%;display:flex;flex-direction:column;gap:10px;">
      <div style="display:flex;flex-direction:column;gap:5px;">
        <label style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Nombre de usuario</label>
        <input id="uf-nombre" type="text" placeholder="Ej: Supervisor" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;outline:none;" oninput="this.style.borderColor='var(--border)'">
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;">
        <label style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Contrase√±a</label>
        <input id="uf-pass" type="text" placeholder="Contrase√±a" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;font-family:'Courier New',monospace;letter-spacing:3px;outline:none;" oninput="this.style.borderColor='var(--border)'">
      </div>
    </div>
    <div id="uf-error" style="font-size:12px;color:var(--red);min-height:16px;text-align:center;"></div>
    <div style="display:flex;gap:8px;width:100%;">
      <button class="modal-btn secondary" style="flex:1;" onclick="closeUserForm()">Cancelar</button>
      <button class="modal-btn" style="flex:1;" onclick="saveUserForm()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: Formulario m√≥dulo (crear/editar) -->
<div class="modal-overlay hidden" id="modal-mod-form" style="z-index:700;">
  <div class="modal-box" style="max-width:360px;width:92%;gap:14px;">
    <div class="modal-title" id="mod-form-title">Nuevo M√≥dulo</div>
    <div style="width:100%;display:flex;flex-direction:column;gap:10px;">
      <div style="display:flex;flex-direction:column;gap:5px;">
        <label style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Nombre del m√≥dulo</label>
        <input id="mf-nombre" type="text" placeholder="Ej: M28" maxlength="10" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:16px;font-family:'Courier New',monospace;letter-spacing:4px;outline:none;" oninput="this.style.borderColor='var(--border)'">
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;">
        <label style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Contrase√±a del m√≥dulo</label>
        <input id="mf-pass" type="text" placeholder="Dejar vac√≠o = usar nombre como clave" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;font-family:'Courier New',monospace;letter-spacing:3px;outline:none;" oninput="this.style.borderColor='var(--border)'">
      </div>
    </div>
    <div id="mf-error" style="font-size:12px;color:var(--red);min-height:16px;text-align:center;"></div>
    <div style="display:flex;gap:8px;width:100%;">
      <button class="modal-btn secondary" style="flex:1;" onclick="closeModForm()">Cancelar</button>
      <button class="modal-btn" style="flex:1;" onclick="saveModForm()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: Confirmaci√≥n eliminar -->
<div class="modal-overlay hidden" id="modal-confirm-delete" style="z-index:700;">
  <div class="modal-box" style="max-width:340px;width:92%;gap:16px;">
    <div class="modal-icon">‚ö†Ô∏è</div>
    <div class="modal-title" id="confirm-delete-title">¬øEliminar?</div>
    <div class="modal-sub" id="confirm-delete-sub">Esta acci√≥n no se puede deshacer.</div>
    <div style="display:flex;gap:8px;width:100%;">
      <button class="modal-btn secondary" style="flex:1;" onclick="closeConfirmDelete()">Cancelar</button>
      <button style="flex:1;padding:13px;border-radius:8px;border:none;background:var(--red);color:#fff;font-size:13px;font-weight:700;letter-spacing:1px;cursor:pointer;" onclick="executeDelete()">Eliminar</button>
    </div>
  </div>
</div>

</body>
</html>
