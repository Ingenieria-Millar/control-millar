<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Control de Piso ‚Äî Confecciones Millar</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#080c14;--panel:#0f1520;--border:#1a2236;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--text:#e2e8f0;--muted:#4b5a72;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);font-family:'Segoe UI',Arial,sans-serif;color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(26,34,54,0.5) 1px,transparent 1px),linear-gradient(90deg,rgba(26,34,54,0.5) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0;}

header{position:relative;z-index:2;display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:rgba(15,21,32,0.97);border-bottom:1px solid var(--border);}
.hd-left{display:flex;align-items:center;gap:12px;}
.live-dot{width:11px;height:11px;border-radius:50%;background:var(--muted);}
.live-dot.online{background:var(--green);box-shadow:0 0 10px rgba(34,197,94,0.8);animation:lp 2s ease-in-out infinite;}
.live-dot.offline{background:var(--red);box-shadow:0 0 8px rgba(239,68,68,0.7);}
@keyframes lp{0%,100%{box-shadow:0 0 6px rgba(34,197,94,0.6);}50%{box-shadow:0 0 18px rgba(34,197,94,1),0 0 32px rgba(34,197,94,0.5);}}
h1{font-size:19px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#f1f5f9;}
.conn-label{font-size:11px;font-weight:600;letter-spacing:1.5px;color:var(--green);text-transform:uppercase;}
.clock{font-family:'Courier New',monospace;font-size:17px;color:#e2e8f0;letter-spacing:2px;font-weight:700;}
.stats{position:relative;z-index:2;display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px 24px;background:rgba(8,12,20,0.9);border-bottom:1px solid var(--border);}
.stat{display:flex;align-items:center;gap:7px;padding:6px 16px;border-radius:6px;background:var(--panel);border:1px solid var(--border);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;user-select:none;}
.stat:hover{border-color:#2d3f5a;background:#1a2236;}
.stat.active-filter.fg{border-color:var(--green);background:rgba(34,197,94,0.12);color:var(--green);}
.stat.active-filter.fy{border-color:var(--yellow);background:rgba(234,179,8,0.12);color:var(--yellow);}
.stat.active-filter.fr{border-color:var(--red);background:rgba(239,68,68,0.12);color:var(--red);}
.sd{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.sd.g{background:var(--green);box-shadow:0 0 7px rgba(34,197,94,0.8);}
.sd.y{background:var(--yellow);box-shadow:0 0 7px rgba(234,179,8,0.8);}
.sd.r{background:var(--red);box-shadow:0 0 7px rgba(239,68,68,0.8);}
.filter-hint{font-size:11px;color:var(--muted);letter-spacing:1px;font-style:italic;}
.view-toggle{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.btn-bar{padding:5px 14px;border-radius:6px;font-size:13px;font-weight:600;letter-spacing:1px;cursor:pointer;transition:all 0.2s;border:1px solid var(--border);background:transparent;color:var(--muted);}
.btn-bar:hover{border-color:#2d3f5a;color:var(--text);}
.btn-bar.green{border-color:rgba(34,197,94,0.4);background:rgba(34,197,94,0.08);color:var(--green);}
.btn-bar.green:hover{background:rgba(34,197,94,0.15);}
.btn-bar.yellow{border-color:rgba(234,179,8,0.4);background:rgba(234,179,8,0.06);color:var(--yellow);}
.btn-bar.yellow:hover{background:rgba(234,179,8,0.12);}
.btn-bar.blue{border-color:rgba(99,179,237,0.3);color:#93c5fd;}
.btn-bar.blue:hover{background:rgba(99,179,237,0.08);}
.btn-bar.red{border-color:rgba(239,68,68,0.3);color:#fca5a5;}
.btn-bar.red:hover{background:rgba(239,68,68,0.08);}
.btn-bar.purple{border-color:rgba(167,139,250,0.4);background:rgba(167,139,250,0.07);color:#c4b5fd;}
.btn-bar.purple:hover{background:rgba(167,139,250,0.14);}
#nav-single{display:none;position:relative;z-index:2;padding:10px 24px;background:rgba(8,12,20,0.9);border-bottom:1px solid var(--border);gap:8px;justify-content:flex-end;align-items:center;}
main{position:relative;z-index:1;padding:24px;max-width:1200px;margin:0 auto;padding-bottom:24px;}
.grid{display:grid;grid-template-columns:repeat(9,1fr);gap:12px;}
.module{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px 10px 10px;display:flex;flex-direction:column;align-items:center;gap:5px;overflow:hidden;transition:transform 0.15s,border-color 0.3s,box-shadow 0.3s;user-select:none;-webkit-tap-highlight-color:transparent;animation:fi 0.25s ease;}
@keyframes fi{from{opacity:0;transform:scale(0.92);}to{opacity:1;transform:scale(1);}}
.module.readonly{cursor:default;}.module.clickable{cursor:pointer;}.module.clickable:hover{transform:scale(1.03);}
.module::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0;transition:background 0.4s;}
.module.green{border-color:rgba(34,197,94,0.25);box-shadow:0 2px 16px rgba(34,197,94,0.07);}
.module.yellow{border-color:rgba(234,179,8,0.3);box-shadow:0 2px 16px rgba(234,179,8,0.08);}
.module.red{border-color:rgba(239,68,68,0.4);box-shadow:0 4px 24px rgba(239,68,68,0.15);}
.module.green::before{background:var(--green);}.module.yellow::before{background:var(--yellow);}.module.red::before{background:var(--red);}
.mod-id{font-family:'Courier New',monospace;font-size:12px;font-weight:700;letter-spacing:2px;color:#cbd5e1;align-self:flex-start;}
.light{width:50px;height:50px;border-radius:50%;transition:background 0.4s,box-shadow 0.4s;position:relative;}
.light::after{content:'';position:absolute;top:8px;left:11px;width:14px;height:8px;border-radius:50%;background:rgba(255,255,255,0.22);transform:rotate(-30deg);}
.module.green .light{background:radial-gradient(circle at 35% 35%,#4ade80,#15803d);box-shadow:0 0 16px rgba(34,197,94,0.7),0 0 32px rgba(34,197,94,0.3);}
.module.yellow .light{background:radial-gradient(circle at 35% 35%,#fde047,#a16207);box-shadow:0 0 16px rgba(234,179,8,0.7);animation:yb 1.6s ease-in-out infinite;}
.module.red .light{background:radial-gradient(circle at 35% 35%,#f87171,#991b1b);box-shadow:0 0 20px rgba(239,68,68,0.8),0 0 40px rgba(239,68,68,0.4);animation:rb 0.85s ease-in-out infinite;}
@keyframes yb{0%,100%{box-shadow:0 0 12px rgba(234,179,8,0.6);}50%{box-shadow:0 0 28px rgba(234,179,8,1),0 0 50px rgba(234,179,8,0.5);}}
@keyframes rb{0%,100%{box-shadow:0 0 16px rgba(239,68,68,0.7);}50%{box-shadow:0 0 36px rgba(239,68,68,1),0 0 68px rgba(239,68,68,0.6);}}
.mod-label{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;border-radius:4px;}
.module.green .mod-label{color:var(--green);background:rgba(34,197,94,0.1);}
.module.yellow .mod-label{color:var(--yellow);background:rgba(234,179,8,0.1);}
.module.red .mod-label{color:var(--red);background:rgba(239,68,68,0.12);}
.mod-timer{font-family:'Courier New',monospace;font-size:11px;font-weight:700;padding:2px 6px;border-radius:4px;letter-spacing:1px;min-height:18px;}
.module.red .mod-timer{color:var(--red);background:rgba(239,68,68,0.1);}
.module.yellow .mod-timer{color:var(--yellow);background:rgba(234,179,8,0.08);}
.module.green .mod-timer{visibility:hidden;}
.mod-mec{font-size:9px;font-weight:800;color:#f1f5f9;letter-spacing:0.3px;text-align:center;line-height:1.3;min-height:13px;padding:0 2px;word-break:break-word;}
.empty-msg{grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--muted);font-size:15px;letter-spacing:2px;}
#single-view{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:65vh;gap:24px;}
#single-view.active{display:flex;}
#grid-view.hidden{display:none;}
.big-wrap{display:flex;flex-direction:column;align-items:center;gap:22px;padding:48px 68px;background:var(--panel);border-radius:20px;border:1px solid var(--border);cursor:pointer;min-width:280px;transition:transform 0.18s,box-shadow 0.4s,border-color 0.4s;user-select:none;}
.big-wrap:active{transform:scale(0.97);}
.big-wrap.green{border-color:rgba(34,197,94,0.35);box-shadow:0 8px 50px rgba(34,197,94,0.15);}
.big-wrap.yellow{border-color:rgba(234,179,8,0.35);box-shadow:0 8px 50px rgba(234,179,8,0.15);}
.big-wrap.red{border-color:rgba(239,68,68,0.45);box-shadow:0 8px 60px rgba(239,68,68,0.25);}
.big-id{font-family:'Courier New',monospace;font-size:28px;letter-spacing:8px;color:#cbd5e1;}
.big-light{width:148px;height:148px;border-radius:50%;transition:background 0.4s,box-shadow 0.4s;position:relative;}
.big-light::after{content:'';position:absolute;top:24px;left:30px;width:44px;height:26px;border-radius:50%;background:rgba(255,255,255,0.2);transform:rotate(-30deg);}
.big-wrap.green .big-light{background:radial-gradient(circle at 35% 35%,#4ade80,#15803d);box-shadow:0 0 55px rgba(34,197,94,0.8),0 0 110px rgba(34,197,94,0.4);}
.big-wrap.yellow .big-light{background:radial-gradient(circle at 35% 35%,#fde047,#a16207);box-shadow:0 0 55px rgba(234,179,8,0.8);animation:yb 1.6s ease-in-out infinite;}
.big-wrap.red .big-light{background:radial-gradient(circle at 35% 35%,#f87171,#991b1b);box-shadow:0 0 65px rgba(239,68,68,0.9),0 0 130px rgba(239,68,68,0.5);animation:rb 0.85s ease-in-out infinite;}
.big-status{font-size:24px;font-weight:700;letter-spacing:4px;text-transform:uppercase;}
.big-wrap.green .big-status{color:var(--green);}.big-wrap.yellow .big-status{color:var(--yellow);}.big-wrap.red .big-status{color:var(--red);}
.big-timer{font-family:'Courier New',monospace;font-size:15px;font-weight:700;padding:5px 16px;border-radius:6px;letter-spacing:2px;min-height:30px;}
.big-wrap.red .big-timer{color:var(--red);background:rgba(239,68,68,0.1);}
.big-wrap.yellow .big-timer{color:var(--yellow);background:rgba(234,179,8,0.08);}
.big-wrap.green .big-timer{visibility:hidden;}
.tap-hint{font-size:12px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
#toasts{position:fixed;top:75px;right:18px;z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.toast{padding:11px 16px;border-radius:8px;background:var(--panel);border-left:3px solid;font-size:14px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,0.5);animation:tin 0.3s ease,tout 0.4s ease 2.6s forwards;max-width:270px;}
.toast.green{border-color:var(--green);color:var(--green);}.toast.yellow{border-color:var(--yellow);color:var(--yellow);}.toast.red{border-color:var(--red);color:var(--red);}
@keyframes tin{from{transform:translateX(110%);opacity:0;}to{transform:none;opacity:1;}}
@keyframes tout{to{opacity:0;transform:translateX(16px);}}
.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,0.12);transform:scale(0);animation:rip 0.55s linear;pointer-events:none;}
@keyframes rip{to{transform:scale(5);opacity:0;}}
/* LOGIN */
.login-screen{position:fixed;inset:0;z-index:500;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;}
.login-screen.hidden{display:none;}
.login-box{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:44px 48px;display:flex;flex-direction:column;align-items:center;gap:22px;width:90%;max-width:380px;box-shadow:0 24px 80px rgba(0,0,0,0.8);animation:slup 0.3s ease;}
@keyframes slup{from{transform:translateY(20px);opacity:0;}to{transform:none;opacity:1;}}
.login-logo{font-size:36px;}
.login-title{font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;text-align:center;line-height:1.5;}
.login-title span{display:block;font-size:11px;color:var(--muted);letter-spacing:2px;margin-top:4px;font-weight:400;}
.login-select,.login-input{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:15px;outline:none;transition:border-color 0.2s;}
.login-select{font-weight:600;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%234b5a72' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;}
.login-input{font-family:'Courier New',monospace;font-size:22px;letter-spacing:10px;text-align:center;}
.login-select:focus,.login-input:focus{border-color:#3d5a8a;}
.login-input.error{border-color:var(--red);animation:shake 0.35s ease;}
@keyframes shake{0%,100%{transform:none;}20%,60%{transform:translateX(-7px);}40%,80%{transform:translateX(7px);}}
.login-btn{width:100%;padding:15px;border-radius:10px;border:none;background:var(--green);color:#080c14;font-size:14px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:opacity 0.2s;}
.login-btn:hover{opacity:0.88;}
.login-error{font-size:12px;color:var(--red);letter-spacing:1px;min-height:16px;text-align:center;}
/* SELECTOR */
.selector-screen{position:fixed;inset:0;z-index:490;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:36px;}
.selector-screen.hidden{display:none;}
.sel-title{font-size:18px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#f1f5f9;text-align:center;}
.sel-btns{display:flex;flex-direction:column;gap:14px;width:300px;}
.sel-btn{padding:20px;border-radius:14px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:15px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:12px;}
.sel-btn:hover{transform:translateY(-2px);}
.sel-btn.mec-btn{border-color:rgba(239,68,68,0.35);}
.sel-btn.mec-btn:hover{border-color:rgba(239,68,68,0.7);box-shadow:0 4px 20px rgba(239,68,68,0.12);}
.sel-btn.prod-btn{border-color:rgba(34,197,94,0.35);}
.sel-btn.prod-btn:hover{border-color:rgba(34,197,94,0.7);box-shadow:0 4px 20px rgba(34,197,94,0.12);}
.sel-back{padding:10px 28px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.sel-back:hover{background:#1a2236;color:var(--text);}
/* MODTABLE */
.modtable-screen{position:fixed;inset:0;z-index:480;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;}
.modtable-screen.hidden{display:none;}
.modtable-title{font-size:16px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#f1f5f9;}
.modtable-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;width:90%;max-width:480px;}
.modtable-btn{padding:14px 6px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:#cbd5e1;font-family:'Courier New',monospace;font-size:13px;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all 0.18s;text-align:center;}
.modtable-btn:hover{background:#1a2540;border-color:#3d5a8a;color:#93c5fd;transform:scale(1.05);}
/* MODALES */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:600;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.modal-overlay.hidden{display:none;}
.modal-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:36px 40px;display:flex;flex-direction:column;align-items:center;gap:18px;min-width:300px;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;}
.modal-icon{font-size:38px;}.modal-title{font-size:15px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;text-align:center;}
.modal-sub{font-size:12px;color:var(--muted);letter-spacing:1px;text-align:center;line-height:1.6;}
.modal-btn{width:100%;padding:13px;border-radius:8px;border:none;background:var(--green);color:#080c14;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:opacity 0.2s;}
.modal-btn:hover{opacity:0.85;}
.modal-btn.secondary{background:transparent;color:var(--muted);border:1px solid var(--border);margin-top:-6px;}
.modal-btn.secondary:hover{background:#1a2236;opacity:1;}
.mec-btn{width:100%;padding:11px 16px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.18s;text-align:left;}
.mec-btn:hover{background:#1a2540;border-color:#3d5a8a;color:#93c5fd;}
/* EXCEL */
.excel-modal-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:36px 40px;display:flex;flex-direction:column;gap:20px;min-width:340px;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;}
.excel-title{font-size:15px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;}
.excel-row{display:flex;flex-direction:column;gap:6px;}
.excel-label{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.excel-date{width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;outline:none;transition:border-color 0.2s;}
.excel-date:focus{border-color:#3d5a8a;}
.excel-info{font-size:12px;color:var(--muted);text-align:center;}
.excel-info span{color:var(--green);font-weight:700;}
.excel-btns{display:flex;gap:10px;}
.excel-btns button{flex:1;padding:12px;border-radius:8px;border:none;font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:opacity 0.2s;}
.excel-btns .btn-dl{background:var(--green);color:#080c14;}.excel-btns .btn-dl:hover{opacity:0.85;}
.excel-btns .btn-cancel{background:var(--panel);color:var(--muted);border:1px solid var(--border);}.excel-btns .btn-cancel:hover{background:#1a2236;}
/* FIX */
.fix-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:32px 36px;display:flex;flex-direction:column;gap:14px;width:90%;max-width:500px;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;max-height:90vh;overflow-y:auto;}
.fix-title{font-size:14px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;text-align:center;}
.fix-sub{font-size:12px;color:var(--muted);letter-spacing:1px;text-align:center;}
.fix-mod-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;}
.fix-mod-opt{padding:9px 4px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-family:'Courier New',monospace;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.18s;text-align:center;}
.fix-mod-opt:hover{background:#1a2540;border-color:#3d5a8a;color:#93c5fd;}
.fix-mod-opt.selected{background:#1a2540;border-color:var(--yellow);color:var(--yellow);}
/* ACUMULADO */
.acum-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:28px 32px;display:flex;flex-direction:column;gap:16px;width:95%;max-width:700px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;}
.acum-title{font-size:14px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;text-align:center;}
.acum-sub{font-size:11px;color:var(--muted);text-align:center;letter-spacing:1px;}
.acum-table{width:100%;border-collapse:collapse;}
.acum-table th{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;}
.acum-table td{font-size:13px;padding:9px 10px;border-bottom:1px solid rgba(26,34,54,0.6);font-family:'Courier New',monospace;}
.acum-table tr:last-child td{border-bottom:none;}
.acum-table tr:hover td{background:rgba(255,255,255,0.02);}
.acum-mod{font-weight:700;color:#cbd5e1;letter-spacing:2px;}
.acum-red{color:var(--red);font-weight:700;}
.acum-yellow{color:var(--yellow);font-weight:700;}
.acum-zero{color:var(--muted);}
.acum-badge{display:inline-block;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:700;font-family:'Segoe UI',sans-serif;}
.acum-badge.active-red{background:rgba(239,68,68,0.12);color:var(--red);}
.acum-badge.active-yel{background:rgba(234,179,8,0.1);color:var(--yellow);}
.acum-filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.acum-filter-sel{padding:7px 12px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:12px;font-weight:600;outline:none;cursor:pointer;transition:border-color 0.2s;}
.acum-filter-sel:focus{border-color:#3d5a8a;}
.acum-sort-btn{padding:7px 14px;border-radius:8px;border:1px solid rgba(167,139,250,0.4);background:rgba(167,139,250,0.07);color:#c4b5fd;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;}
.acum-sort-btn:hover{background:rgba(167,139,250,0.14);}
.acum-count{font-size:11px;color:var(--muted);letter-spacing:1px;margin-left:auto;}
</style>
</head>
<body>

<header>
  <div class="hd-left">
    <div class="live-dot online" id="live-dot"></div>
    <h1>Confecciones Millar</h1>
  </div>
  <div style="display:flex;align-items:center;gap:20px">
    <span class="conn-label" id="conn-label">DEMO LOCAL ‚úì</span>
    <span class="clock" id="clock">00:00:00</span>
  </div>
</header>

<div class="stats" id="stats-bar" style="display:none;">
  <div class="stat fg" id="stat-green"  onclick="toggleFilter('green')"><div class="sd g"></div><span id="cnt-g">0</span>&nbsp;Operativos</div>
  <div class="stat fy" id="stat-yellow" onclick="toggleFilter('yellow')"><div class="sd y"></div><span id="cnt-y">0</span>&nbsp;Atendiendo</div>
  <div class="stat fr" id="stat-red"    onclick="toggleFilter('red')"><div class="sd r"></div><span id="cnt-r">0</span>&nbsp;Alerta</div>
  <span class="filter-hint" id="filter-hint"></span>
  <div class="view-toggle">
    <button class="btn-bar purple" onclick="openAcumuladoModal()">üìä Acumulado</button>
    <button class="btn-bar green"  id="btn-excel-bar" style="display:none;" onclick="openExcelModal()">üì• Excel</button>
    <button class="btn-bar yellow" id="btn-fix-mec"   style="display:none;" onclick="openFixMecModal()">üîß Corregir</button>
    <button class="btn-bar red"    id="btn-cambiar-user" style="display:none;" onclick="volverLogin()">üë§ Cambiar usuario</button>

    <button class="btn-bar blue"   onclick="atrasDesdeTablero()">‚¨Ö Atr√°s</button>
  </div>
</div>

<div id="nav-single">
  <button class="btn-bar" onclick="cambiarModulo()">üì± Cambiar M√≥dulo</button>
  <button class="btn-bar blue" onclick="atrasDesdeModulo()">‚¨Ö Atr√°s</button>
</div>

<main>
  <div id="grid-view" class="hidden"><div class="grid" id="grid"></div></div>
  <div id="single-view"><div id="big-container"></div></div>
</main>
<div id="toasts"></div>

<!-- PANTALLA 1: LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">üè≠</div>
    <div class="login-title">Control de Piso<span>Confecciones Millar</span></div>
    <select class="login-select" id="login-user">
      <option value="">‚Äî Selecciona tu usuario ‚Äî</option>
    </select>
    <input class="login-input" id="login-pass" type="password" maxlength="30" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
    <div class="login-error" id="login-error"></div>
    <button class="login-btn" onclick="submitLogin()">Ingresar ‚Üí</button>
  </div>
</div>

<!-- PANTALLA 2: SELECCI√ìN DE √ÅREA -->
<div class="selector-screen hidden" id="area-screen">
  <div class="sel-title" id="area-title">Bienvenido</div>
  <div class="sel-btns" id="area-btns"></div>
  <button class="sel-back" onclick="volverLogin()">‚¨Ö Cerrar sesi√≥n</button>
</div>

<!-- PANTALLA 3: LOGIN M√ìDULO INDIVIDUAL (solo usuario M√≥dulos) -->
<div class="login-screen hidden" id="modulo-login-screen">
  <div class="login-box">
    <div class="login-logo">üì±</div>
    <div class="login-title">Acceso M√≥dulo<span>Selecciona tu m√≥dulo e ingresa</span></div>
    <select class="login-select" id="modulo-sel">
      <option value="">‚Äî Selecciona tu m√≥dulo ‚Äî</option>
    </select>
    <input class="login-input" id="modulo-pass" type="password" maxlength="30" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
    <div class="login-error" id="modulo-error"></div>
    <button class="login-btn" onclick="submitModuloLogin()">Ingresar ‚Üí</button>
    <button class="sel-back" style="width:100%;margin-top:-4px;" onclick="volverAArea()">‚¨Ö Atr√°s</button>
  </div>
</div>

<!-- TABLA DE M√ìDULOS -->
<div class="modtable-screen hidden" id="modtable-screen">
  <div class="modtable-title">Selecciona tu m√≥dulo</div>
  <div class="modtable-grid" id="modtable-grid"></div>
  <button class="sel-back" onclick="volverAArea()">‚¨Ö Atr√°s</button>
</div>

<!-- MODAL: mec√°nico -->
<div class="modal-overlay hidden" id="modal-mecanico">
  <div class="modal-box" style="max-width:360px;width:90%;">
    <div class="modal-icon">üîß</div>
    <div class="modal-title" id="mec-title">¬øQui√©n atendi√≥?</div>
    <div class="modal-sub"   id="mec-sub">Selecciona el mec√°nico</div>
    <div style="width:100%;display:flex;flex-direction:column;gap:8px;" id="mec-list"></div>
    <button class="modal-btn secondary" onclick="cancelMecanico()">Cancelar</button>
  </div>
</div>

<!-- MODAL: Excel -->
<div class="modal-overlay hidden" id="excel-modal">
  <div class="excel-modal-box">
    <div class="excel-title">üì• Descargar Reporte Excel</div>
    <div class="excel-row"><label class="excel-label">Fecha inicio</label><input class="excel-date" type="date" id="date-from"></div>
    <div class="excel-row"><label class="excel-label">Fecha fin</label><input class="excel-date" type="date" id="date-to"></div>
    <div class="excel-info" id="excel-info"></div>
    <div class="excel-btns">
      <button class="btn-cancel" onclick="closeExcelModal()">Cancelar</button>
      <button class="btn-dl"     onclick="downloadExcel()">‚¨á Descargar</button>
    </div>
  </div>
</div>

<!-- MODAL: Corregir mec√°nico -->
<div class="modal-overlay hidden" id="modal-fix-mec">
  <div class="fix-box">
    <div class="fix-title">üîß Corregir Mec√°nico</div>
    <div class="fix-sub" id="fix-step-lbl">Paso 1 ‚Äî Selecciona el m√≥dulo</div>
    <div class="fix-mod-grid" id="fix-mod-grid"></div>
    <div id="fix-mec-section" style="display:none;flex-direction:column;gap:8px;">
      <div class="fix-sub">Paso 2 ‚Äî Selecciona el mec√°nico correcto</div>
      <div id="fix-mec-list" style="display:flex;flex-direction:column;gap:7px;"></div>
    </div>
    <button class="modal-btn secondary" onclick="closeFixMecModal()">Cancelar</button>
  </div>
</div>

<!-- MODAL: Acumulado -->
<div class="modal-overlay hidden" id="modal-acumulado">
  <div class="acum-box">
    <div class="acum-title">üìä Tiempo Acumulado por M√≥dulo</div>
    <div class="acum-sub" id="acum-fecha"></div>
    <div class="acum-filters">
      <select class="acum-filter-sel" id="acum-f-modulo" onchange="renderAcumulado()">
        <option value="">Todos los m√≥dulos</option>
      </select>
      <select class="acum-filter-sel" id="acum-f-estado" onchange="renderAcumulado()">
        <option value="">Todos los estados</option>
        <option value="red">üî¥ Alerta</option>
        <option value="yellow">üü° Atendiendo</option>
        <option value="green">üü¢ Operativo</option>
        <option value="contiempo">‚è± Con tiempo &gt; 0</option>
      </select>
      <button class="acum-sort-btn" id="acum-sort-btn" onclick="toggleAcumSort()">‚Üì Mayor tiempo</button>
      <span class="acum-count" id="acum-count"></span>
    </div>
    <table class="acum-table">
      <thead>
        <tr>
          <th>M√≥dulo</th>
          <th>Estado</th>
          <th>üî¥ Alerta acum.</th>
          <th>üü° Atendiendo acum.</th>
          <th>‚è± Total parado</th>
        </tr>
      </thead>
      <tbody id="acum-tbody"></tbody>
    </table>
    <button class="modal-btn secondary" onclick="closeAcumuladoModal()">Cerrar</button>
  </div>
</div>

<script>
const MODULES=['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27'];
const LABELS={green:'Operativo',yellow:'Atendiendo',red:'Alerta'};
const NEXT={green:'red',red:'yellow',yellow:'green'};
const MECANICOS=['ANDRES RIOS','CESAR CIFUENTES','DAIRON ZAPATA','ELKIN LOPEZ','JUAN C GONZALEZ','OSCAR ZEA','RICARDO SERNA','WALTER PEREZ','YON CANO'];

const USUARIOS={
  'Programador':  {pass:'1',perms:['area_mecanicos','area_produccion','tablero','modulos','excel','fix','area_ingreso']},
  'Administrador':{pass:'1',perms:['area_mecanicos','tablero','excel','area_ingreso']},
  'Modulos':      {pass:'1',perms:['area_produccion','modulos']},
  'Televisor':    {pass:'1',perms:['area_mecanicos','tablero']},
  'Mecanicos':    {pass:'1',perms:['area_mecanicos','tablero']},
};

const states={}, timers={}, lastMec={}, acumRed={}, acumYellow={};
MODULES.forEach(id=>{ states[id]='green'; timers[id]=Date.now(); lastMec[id]=''; acumRed[id]=0; acumYellow[id]=0; });

let selectedMod=null, activeFilter=null, currentView=null, pendingTransicion=null, currentUser=null;
function hasPerm(p){ return currentUser&&USUARIOS[currentUser]&&USUARIOS[currentUser].perms.includes(p); }
function isProg(){ return hasPerm('fix')&&hasPerm('modulos')&&hasPerm('tablero'); }

// ‚îÄ‚îÄ Variables globales Control de Asistencia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Deben estar en scope global para que el WebSocket las llene
// antes de que se ejecute runIngresoScript()
let iaState   = null;
let iaRecords = [];
let iaReady   = false;

function iaSaveState(){
  wsSend({ type: 'ia_save_state', state: JSON.parse(JSON.stringify(iaState)) });
}
function iaSaveRecords(){ /* registros se envian individualmente */ }

function iaWaitReady(cb){
  if(iaReady){ cb(); return; }
  const t=setInterval(()=>{ if(iaReady){ clearInterval(t); cb(); }},100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET ‚Äî Conexi√≥n en tiempo real
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ws=null, wsReady=false, reconnectTimer=null;

function connectWS(){
  const proto=location.protocol==='https:'?'wss':'ws';
  const url=`${proto}://${location.host}`;
  ws=new WebSocket(url);

  ws.onopen=()=>{
    wsReady=true;
    clearTimeout(reconnectTimer);
    setConnStatus(true);
  };

  ws.onmessage=(e)=>{
    try{
      const msg=JSON.parse(e.data);

      // ‚îÄ‚îÄ Control de Piso ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if(msg.type==='init'){
        MODULES.forEach(id=>{
          if(msg.states[id] && msg.states[id]!==states[id]){
            states[id]=msg.states[id]; timers[id]=Date.now();
          }
          if(msg.lastMec[id]) lastMec[id]=msg.lastMec[id];
        });
        // ‚îÄ‚îÄ Control de Asistencia: recibir datos del servidor ‚îÄ‚îÄ
        if(msg.iaState)   iaState   = msg.iaState;
        if(msg.iaRecords) iaRecords = msg.iaRecords;
        iaReady = true;
        updateStats();
        if(currentView==='grid')   renderGrid();
        if(currentView==='single') renderBig();

      } else if(msg.type==='change'){
        const id=msg.id, s=msg.state;
        const prev=states[id];
        const dur=Date.now()-(timers[id]||Date.now());
        if(prev==='red')    acumRed[id]   +=dur;
        if(prev==='yellow') acumYellow[id]+=dur;
        states[id]=s; timers[id]=Date.now();
        if(s==='red') lastMec[id]='';
        else if(msg.mecanico) lastMec[id]=msg.mecanico;
        if(s==='red'&&currentUser==='Televisor') playAlertSound();
        updateStats();
        if(selectedMod===id) renderBig();
        renderGrid();

      // ‚îÄ‚îÄ Control de Asistencia: sincronizaci√≥n entre dispositivos ‚îÄ‚îÄ
      } else if(msg.type==='ia_add_record'){
        if(!iaRecords) iaRecords=[];
        iaRecords = iaRecords.filter(r=>
          !(r.empName===msg.record.empName && r.date===msg.record.date && r.supervisor===msg.record.supervisor)
        );
        iaRecords.push(msg.record);
        if(typeof iaUpdateStats==='function') iaUpdateStats();
        if(typeof iaRenderTodayChips==='function') iaRenderTodayChips();
        if(typeof iaRenderHistory==='function' && document.getElementById('ia-tab-history') && !document.getElementById('ia-tab-history').classList.contains('hidden')) iaRenderHistory();
        if(typeof iaRenderAdminTable==='function' && document.getElementById('ia-tab-records') && !document.getElementById('ia-tab-records').classList.contains('hidden')) iaRenderAdminTable();

      } else if(msg.type==='ia_delete_record'){
        if(iaRecords) iaRecords = iaRecords.filter(r=>r.id!==msg.id);
        if(typeof iaUpdateStats==='function') iaUpdateStats();
        if(typeof iaRenderTodayChips==='function') iaRenderTodayChips();
        if(typeof iaRenderAdminTable==='function') iaRenderAdminTable();

      } else if(msg.type==='ia_edit_record'){
        if(iaRecords){ const idx=iaRecords.findIndex(r=>r.id===msg.record.id); if(idx>-1) iaRecords[idx]=msg.record; }
        if(typeof iaRenderAdminTable==='function') iaRenderAdminTable();

      } else if(msg.type==='ia_save_state'){
        iaState = msg.state;
        if(typeof iaBuildLoginSelect==='function') iaBuildLoginSelect();
      }

    }catch(err){ console.error('WS error:', err); }
  };

  ws.onclose=()=>{
    wsReady=false;
    setConnStatus(false);
    // Reconectar autom√°ticamente cada 3 segundos
    reconnectTimer=setTimeout(connectWS, 3000);
  };

  ws.onerror=()=>{ ws.close(); };
}

function setConnStatus(online){
  const dot=document.getElementById('live-dot');
  const lbl=document.getElementById('conn-label');
  if(online){
    dot.className='live-dot online';
    lbl.textContent='EN L√çNEA ‚úì';
    lbl.style.color='var(--green)';
  } else {
    dot.className='live-dot offline';
    lbl.textContent='RECONECTANDO...';
    lbl.style.color='var(--red)';
  }
}

function wsSend(payload){
  if(ws && wsReady && ws.readyState===1){
    ws.send(JSON.stringify(payload));
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIAL ‚Äî Se guarda en localStorage del servidor (server.js lo persiste si quieres)
// Por ahora sigue en localStorage del navegador para el Excel
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY='mant_historial_v2';
function loadHistory(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch(e){return[];} }
function saveHistory(h){ try{localStorage.setItem(STORAGE_KEY,JSON.stringify(h));}catch(e){} }
function logChange(modulo,prev,next,durMs,mecanico){
  if(!((prev==='red'&&next==='yellow')||(prev==='yellow'&&next==='green'))) return;
  const h=loadHistory();
  h.push({fecha:new Date().toLocaleDateString('es-CO'),modulo,estadoAnterior:prev,estadoNuevo:next,durMinutos:parseFloat((durMs/60000).toFixed(2)),mecanico:mecanico||''});
  if(h.length>10000) h.splice(0,h.length-10000);
  saveHistory(h);
}

// ‚îÄ‚îÄ SONIDO ALERTA (SIRENA AMBULANCIA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx=null;
function playAlertSound(){
  try{
    if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    const durTotal=6;
    const ciclo=0.6;
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type='sawtooth';
    g.gain.setValueAtTime(0.85, audioCtx.currentTime);
    g.gain.setValueAtTime(0.85, audioCtx.currentTime+durTotal-0.1);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+durTotal);
    const t0=audioCtx.currentTime;
    for(let i=0;i<Math.floor(durTotal/ciclo);i++){
      const t=t0+(i*ciclo);
      const freqStart=i%2===0?700:1050;
      const freqEnd  =i%2===0?1050:700;
      o.frequency.setValueAtTime(freqStart, t);
      o.frequency.linearRampToValueAtTime(freqEnd, t+ciclo);
    }
    o.start(audioCtx.currentTime);
    o.stop(audioCtx.currentTime+durTotal);
  }catch(e){}
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateLoginSelect(){
  const sel = document.getElementById('login-user');
  const prev = sel.value;
  sel.innerHTML = '<option value="">‚Äî Selecciona tu usuario ‚Äî</option>';
  // Usuarios activos ordenados alfab√©ticamente
  const cfg = loadConfig();
  const extras = (cfg._usuarios_extra||[]).filter(u=>!u.disabled);
  const allNames = Object.entries(USUARIOS)
    .filter(([k,v])=> v.perms && v.perms.length > 0) // solo habilitados
    .map(([k])=>k)
    .concat(extras.map(u=>u.nombre))
    .filter((v,i,a)=>a.indexOf(v)===i) // deduplicar
    .sort((a,b)=>a.localeCompare(b));
  allNames.forEach(nombre=>{
    const o = document.createElement('option');
    o.value = nombre;
    o.textContent = nombre;
    sel.appendChild(o);
  });
  if(prev) sel.value = prev;
}

window.addEventListener('DOMContentLoaded',()=>{
  applyConfig();
  rebuildModules();
  populateLoginSelect();
  updateStats();
  setConnStatus(false);
  connectWS();
  document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')submitLogin();});
  document.getElementById('modulo-pass').addEventListener('keydown',e=>{if(e.key==='Enter')submitModuloLogin();});
  const msel=document.getElementById('modulo-sel');
  MODULES.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;msel.appendChild(o);});
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANTALLA 1 ‚Äî LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function submitLogin(){
  const usuario=document.getElementById('login-user').value;
  const pass=document.getElementById('login-pass').value;
  const err=document.getElementById('login-error');
  const inp=document.getElementById('login-pass');
  if(!usuario){err.textContent='Selecciona un usuario';return;}
  if(!USUARIOS[usuario]){err.textContent='Usuario no v√°lido';return;}
  // Usuario M√≥dulos entra sin contrase√±a
  if(usuario==='Modulos'){
    currentUser=usuario;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('login-pass').value='';
    document.getElementById('login-error').textContent='';
    mostrarAreaScreen();return;
  }
  if(pass!==USUARIOS[usuario].pass){
    inp.classList.add('error');err.textContent='Contrase√±a incorrecta';inp.value='';
    setTimeout(()=>{inp.classList.remove('error');inp.focus();},400);return;
  }
  currentUser=usuario;
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('login-pass').value='';
  document.getElementById('login-error').textContent='';
  mostrarAreaScreen();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANTALLA 2 ‚Äî SELECCI√ìN DE √ÅREA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mostrarAreaScreen(){
  const btns=document.getElementById('area-btns');btns.innerHTML='';
  document.getElementById('area-title').textContent='Bienvenido, '+currentUser;
  if(hasPerm('area_mecanicos')){
    const b=document.createElement('button');b.className='sel-btn mec-btn';
    b.innerHTML='üîß&nbsp; MEC√ÅNICOS';
    b.onclick=()=>elegirArea('mecanicos');
    btns.appendChild(b);
  }
  if(hasPerm('area_produccion')){
    const b=document.createElement('button');b.className='sel-btn prod-btn';
    b.innerHTML='üè≠&nbsp; PRODUCCI√ìN';
    b.onclick=()=>elegirArea('produccion');
    btns.appendChild(b);
  }
  if(hasPerm('area_ingreso')){
    const b=document.createElement('button');b.className='sel-btn';
    b.style.cssText='border-color:rgba(99,179,237,0.35);';
    b.innerHTML='üè¢&nbsp; CONTROL DE INGRESO';
    b.onmouseover=()=>b.style.cssText='border-color:rgba(99,179,237,0.7);box-shadow:0 4px 20px rgba(99,179,237,0.15);';
    b.onmouseout=()=>b.style.cssText='border-color:rgba(99,179,237,0.35);';
    b.onclick=()=>{ document.getElementById('area-screen').classList.add('hidden'); abrirControlIngreso(); };
    btns.appendChild(b);
  }
  if(isProg()){
    const b=document.createElement('button');b.className='sel-btn';
    b.style.cssText='border-color:rgba(167,139,250,0.35);';
    b.innerHTML='‚öôÔ∏è&nbsp; CONFIGURACI√ìN';
    b.onmouseover=()=>b.style.cssText='border-color:rgba(167,139,250,0.7);box-shadow:0 4px 20px rgba(167,139,250,0.12);';
    b.onmouseout=()=>b.style.cssText='border-color:rgba(167,139,250,0.35);';
    b.onclick=()=>{ document.getElementById('area-screen').classList.add('hidden'); openConfigModal(); };
    btns.appendChild(b);
  }
  document.getElementById('area-screen').classList.remove('hidden');
}

function elegirArea(area){
  document.getElementById('area-screen').classList.add('hidden');
  if(area==='mecanicos'){
    entrarTablero();
  } else {
    if(currentUser==='Modulos'){
      document.getElementById('modulo-pass').value='';
      document.getElementById('modulo-error').textContent='';
      document.getElementById('modulo-login-screen').classList.remove('hidden');
    } else {
      abrirModtable();
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANTALLA 3 ‚Äî LOGIN M√ìDULO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function submitModuloLogin(){
  const modulo=document.getElementById('modulo-sel').value;
  const pass=document.getElementById('modulo-pass').value;
  const err=document.getElementById('modulo-error');
  const inp=document.getElementById('modulo-pass');
  if(!modulo){err.textContent='Selecciona tu m√≥dulo';return;}
  // Contrase√±a personalizada o por defecto el nombre del m√≥dulo
  const cfg=loadConfig();
  const customPass=(cfg._modulos_pass||{})[modulo];
  const expected = customPass || modulo;
  if(pass.toUpperCase()!==expected.toUpperCase()){
    inp.classList.add('error');err.textContent='Contrase√±a incorrecta';inp.value='';
    setTimeout(()=>{inp.classList.remove('error');inp.focus();},400);return;
  }
  selectedMod=modulo;
  document.getElementById('modulo-login-screen').classList.add('hidden');
  document.getElementById('modulo-pass').value='';
  document.getElementById('modulo-error').textContent='';
  setView('single');
}

// ‚îÄ‚îÄ NAVEGACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function volverLogin(){
  ocultarTodo();currentUser=null;selectedMod=null;
  populateLoginSelect();
  document.getElementById('login-user').value='';
  document.getElementById('login-pass').value='';
  document.getElementById('login-error').textContent='';
  document.getElementById('login-screen').classList.remove('hidden');
}
function volverAArea(){
  ['modulo-login-screen','modtable-screen'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  mostrarAreaScreen();
}
function ocultarTodo(){
  ['area-screen','modulo-login-screen','modtable-screen'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('stats-bar').style.display='none';
  document.getElementById('nav-single').style.display='none';
  document.getElementById('grid-view').classList.add('hidden');
  document.getElementById('single-view').classList.remove('active');
  currentView=null;
}
function entrarTablero(){ setView('grid'); }
function abrirModtable(){
  const grid=document.getElementById('modtable-grid');grid.innerHTML='';
  MODULES.forEach(id=>{
    const btn=document.createElement('button');btn.className='modtable-btn';btn.textContent=id;
    btn.addEventListener('click',()=>{selectedMod=id;document.getElementById('modtable-screen').classList.add('hidden');setView('single');});
    grid.appendChild(btn);
  });
  document.getElementById('modtable-screen').classList.remove('hidden');
}
function cambiarModulo(){
  if(currentUser==='Modulos'){
    document.getElementById('modulo-pass').value='';
    document.getElementById('modulo-error').textContent='';
    document.getElementById('single-view').classList.remove('active');
    document.getElementById('nav-single').style.display='none';
    currentView=null;
    document.getElementById('modulo-login-screen').classList.remove('hidden');
    return;
  }
  document.getElementById('single-view').classList.remove('active');
  document.getElementById('nav-single').style.display='none';
  currentView=null;abrirModtable();
}
function atrasDesdeTablero(){
  document.getElementById('stats-bar').style.display='none';
  document.getElementById('grid-view').classList.add('hidden');
  currentView=null;mostrarAreaScreen();
}
function atrasDesdeModulo(){
  document.getElementById('nav-single').style.display='none';
  document.getElementById('single-view').classList.remove('active');
  currentView=null;volverAArea();
}

// ‚îÄ‚îÄ VISTAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setView(v){
  currentView=v;
  document.getElementById('grid-view').classList.toggle('hidden',v==='single');
  document.getElementById('single-view').classList.toggle('active',v==='single');
  document.getElementById('stats-bar').style.display  =v==='grid'  ?'flex':'none';
  document.getElementById('nav-single').style.display =v==='single'?'flex':'none';
  if(v==='grid'){
    document.getElementById('btn-excel-bar').style.display  =hasPerm('excel')?'':'none';
    document.getElementById('btn-fix-mec').style.display    =hasPerm('fix')  ?'':'none';
    document.getElementById('btn-cambiar-user').style.display=isProg()       ?'':'none';
  }
  if(v==='grid')   renderGrid();
  if(v==='single') renderBig();
}

// ‚îÄ‚îÄ ESTADOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyChange(id,s){
  const prev=states[id];if(prev===s)return;
  const needsMec=(prev==='red'&&s==='yellow')||(prev==='yellow'&&s==='green');
  if(needsMec){
    pendingTransicion={id,estado:s};
    openMecanicoModal(
      prev==='red'?'¬øQui√©n lleg√≥ a atender?':'¬øQui√©n solucion√≥ la falla?',
      prev==='red'?'Mec√°nico que atendi√≥ el llamado':'Mec√°nico que resolvi√≥ el problema'
    );return;
  }
  commitChange(id,s,null);
}
function openMecanicoModal(titulo,subtitulo){
  document.getElementById('mec-title').textContent=titulo;
  document.getElementById('mec-sub').textContent=subtitulo;
  const list=document.getElementById('mec-list');list.innerHTML='';
  MECANICOS.forEach(nombre=>{
    const btn=document.createElement('button');btn.className='mec-btn';btn.textContent='üîß '+nombre;
    btn.addEventListener('click',()=>selectMecanico(nombre));list.appendChild(btn);
  });
  document.getElementById('modal-mecanico').classList.remove('hidden');
}
function selectMecanico(nombre){
  document.getElementById('modal-mecanico').classList.add('hidden');
  if(pendingTransicion){commitChange(pendingTransicion.id,pendingTransicion.estado,nombre);pendingTransicion=null;}
}
function cancelMecanico(){document.getElementById('modal-mecanico').classList.add('hidden');pendingTransicion=null;}

function commitChange(id,s,mecanico){
  const prev=states[id],ahora=Date.now();
  const dur=ahora-(timers[id]||ahora);
  if(prev==='red')    acumRed[id]   +=dur;
  if(prev==='yellow') acumYellow[id]+=dur;
  logChange(id,prev,s,dur,mecanico);
  states[id]=s;timers[id]=ahora;
  if(mecanico) lastMec[id]=mecanico;
  if(s==='red') lastMec[id]=''; // Resetear mec√°nico al volver a alerta
  if(s==='red'&&currentUser==='Televisor') playAlertSound();
  // Enviar cambio al servidor para sincronizar otros dispositivos
  wsSend({type:'change', id, state:s, mecanico:mecanico||''});
  updateStats();if(selectedMod===id)renderBig();showToast(id,s);renderGrid();
}

function toggleFilter(color){
  activeFilter=activeFilter===color?null:color;
  ['green','yellow','red'].forEach(c=>document.getElementById('stat-'+c).classList.toggle('active-filter',activeFilter===c));
  document.getElementById('filter-hint').textContent=activeFilter?`Filtrando: ${LABELS[activeFilter]}  ¬∑  Toca de nuevo para ver todos`:'';
  renderGrid();
}
function renderGrid(){
  const grid=document.getElementById('grid');grid.innerHTML='';
  const visible=activeFilter?MODULES.filter(id=>states[id]===activeFilter):MODULES;
  const cols=visible.length<=3?visible.length:visible.length<=9?3:visible.length<=12?4:visible.length<=18?6:9;
  grid.style.gridTemplateColumns=`repeat(${Math.max(1,cols)},1fr)`;
  if(!visible.length){grid.innerHTML='<div class="empty-msg">‚úÖ No hay m√≥dulos en este estado</div>';return;}
  const canClick=hasPerm('fix');
  visible.forEach(id=>{
    const s=states[id];
    const div=document.createElement('div');
    div.className=`module ${canClick?'clickable':'readonly'} ${s}`;div.id=`mod-${id}`;
    const mecHtml=(s==='yellow'||s==='red')&&lastMec[id]?`<span class="mod-mec">üîß ${lastMec[id]}</span>`:`<span class="mod-mec"></span>`;
    div.innerHTML=`<span class="mod-id">${id}</span><div class="light"></div><span class="mod-label">${LABELS[s]}</span><span class="mod-timer" id="timer-${id}"></span>${mecHtml}`;
    if(canClick) div.addEventListener('click',e=>{addRipple(div,e);applyChange(id,NEXT[states[id]]);});
    grid.appendChild(div);
  });
}
function updateStats(){
  let g=0,y=0,r=0;
  Object.values(states).forEach(s=>{if(s==='green')g++;else if(s==='yellow')y++;else r++;});
  document.getElementById('cnt-g').textContent=g;
  document.getElementById('cnt-y').textContent=y;
  document.getElementById('cnt-r').textContent=r;
}
function formatTime(ms){
  const s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60);
  if(h>0)return`${h}h ${String(m%60).padStart(2,'0')}m`;
  if(m>0)return`${m}m ${String(s%60).padStart(2,'0')}s`;
  return`${s}s`;
}
setInterval(()=>{
  const now=Date.now();
  MODULES.forEach(id=>{const el=document.getElementById(`timer-${id}`);if(el)el.textContent=(states[id]==='red'||states[id]==='yellow')?'‚è± '+formatTime(now-timers[id]):'';});
  const bt=document.getElementById('big-timer');
  if(bt&&selectedMod&&(states[selectedMod]==='red'||states[selectedMod]==='yellow'))bt.textContent='‚è± '+formatTime(now-timers[selectedMod]);
  else if(bt)bt.textContent='';
},1000);
function renderBig(){
  if(!selectedMod)return;
  const s=states[selectedMod];
  const tt=(s==='red'||s==='yellow')?'‚è± '+formatTime(Date.now()-timers[selectedMod]):'';
  document.getElementById('big-container').innerHTML=`
    <div class="big-wrap ${s}" id="big-mod">
      <span class="big-id">${selectedMod}</span><div class="big-light"></div>
      <span class="big-status">${LABELS[s]}</span>
      <span class="big-timer" id="big-timer">${tt}</span>
      <span class="tap-hint">Toca para cambiar estado</span>
    </div>`;
  document.getElementById('big-mod').addEventListener('click',e=>{addRipple(document.getElementById('big-mod'),e);applyChange(selectedMod,NEXT[states[selectedMod]]);});
}

// ‚îÄ‚îÄ MODAL ACUMULADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let acumSortDesc=true;
function openAcumuladoModal(){
  const fMod=document.getElementById('acum-f-modulo');
  const prev=fMod.value;
  fMod.innerHTML='<option value="">Todos los m√≥dulos</option>';
  MODULES.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;fMod.appendChild(o);});
  fMod.value=prev;
  document.getElementById('acum-f-estado').value='';
  document.getElementById('acum-fecha').textContent='Sesi√≥n actual ‚Äî '+new Date().toLocaleDateString('es-CO',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('modal-acumulado').classList.remove('hidden');
  renderAcumulado();
}
function toggleAcumSort(){
  acumSortDesc=!acumSortDesc;
  document.getElementById('acum-sort-btn').textContent=acumSortDesc?'‚Üì Mayor tiempo':'‚Üë Menor tiempo';
  renderAcumulado();
}
function renderAcumulado(){
  const now=Date.now();
  const filtMod=document.getElementById('acum-f-modulo').value;
  const filtEst=document.getElementById('acum-f-estado').value;
  let rows=MODULES.map(id=>{
    const s=states[id];
    const cur=now-timers[id];
    const totalR=acumRed[id]   +(s==='red'   ?cur:0);
    const totalY=acumYellow[id]+(s==='yellow' ?cur:0);
    const total=totalR+totalY;
    return{id,s,totalR,totalY,total};
  });
  if(filtMod) rows=rows.filter(r=>r.id===filtMod);
  if(filtEst==='red')            rows=rows.filter(r=>r.s==='red');
  else if(filtEst==='yellow')    rows=rows.filter(r=>r.s==='yellow');
  else if(filtEst==='green')     rows=rows.filter(r=>r.s==='green');
  else if(filtEst==='contiempo') rows=rows.filter(r=>r.total>0);
  rows.sort((a,b)=>acumSortDesc?(b.total-a.total):(a.total-b.total));
  const tbody=document.getElementById('acum-tbody');tbody.innerHTML='';
  rows.forEach(({id,s,totalR,totalY,total})=>{
    let badge='';
    if(s==='red')         badge='<span class="acum-badge active-red">üî¥ Alerta</span>';
    else if(s==='yellow') badge='<span class="acum-badge active-yel">üü° Atendiendo</span>';
    else                  badge='<span style="color:var(--green);font-size:12px;">üü¢ Operativo</span>';
    const fR=totalR>0?`<span class="acum-red">${formatTime(totalR)}</span>`:'<span class="acum-zero">‚Äî</span>';
    const fY=totalY>0?`<span class="acum-yellow">${formatTime(totalY)}</span>`:'<span class="acum-zero">‚Äî</span>';
    const fT=total>0?`<b style="color:#e2e8f0">${formatTime(total)}</b>`:'<span class="acum-zero">‚Äî</span>';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="acum-mod">${id}</td><td>${badge}</td><td>${fR}</td><td>${fY}</td><td>${fT}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('acum-count').textContent=`${rows.length} de ${MODULES.length} m√≥dulos`;
}
function closeAcumuladoModal(){document.getElementById('modal-acumulado').classList.add('hidden');}

// ‚îÄ‚îÄ CORREGIR MEC√ÅNICO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFixMecModal(){
  const grid=document.getElementById('fix-mod-grid');grid.innerHTML='';
  document.getElementById('fix-mec-section').style.display='none';
  document.getElementById('fix-step-lbl').textContent='Paso 1 ‚Äî Selecciona el m√≥dulo';
  MODULES.forEach(id=>{
    const btn=document.createElement('button');btn.className='fix-mod-opt';btn.textContent=id;
    btn.addEventListener('click',()=>fixSelectMod(id,btn));grid.appendChild(btn);
  });
  document.getElementById('modal-fix-mec').classList.remove('hidden');
}
function fixSelectMod(id,btn){
  document.querySelectorAll('.fix-mod-opt').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('fix-step-lbl').textContent=`M√≥dulo ${id} ‚Äî Paso 2: elige mec√°nico`;
  const sec=document.getElementById('fix-mec-section');sec.style.display='flex';sec.style.flexDirection='column';
  const list=document.getElementById('fix-mec-list');list.innerHTML='';
  MECANICOS.forEach(nombre=>{
    const b=document.createElement('button');b.className='mec-btn';b.textContent='üîß '+nombre;
    b.addEventListener('click',()=>{lastMec[id]=nombre;renderGrid();closeFixMecModal();showToastSimple(`‚úÖ ${id} ‚Üí ${nombre}`);});
    list.appendChild(b);
  });
}
function closeFixMecModal(){document.getElementById('modal-fix-mec').classList.add('hidden');}

// ‚îÄ‚îÄ EXCEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openExcelModal(){
  const today=new Date(),toStr=d=>d.toISOString().slice(0,10);
  const weekAgo=new Date(today);weekAgo.setDate(today.getDate()-7);
  document.getElementById('date-from').value=toStr(weekAgo);
  document.getElementById('date-to').value=toStr(today);
  document.getElementById('excel-modal').classList.remove('hidden');
  updateExcelInfo();
  document.getElementById('date-from').oninput=updateExcelInfo;
  document.getElementById('date-to').oninput=updateExcelInfo;
}
function closeExcelModal(){document.getElementById('excel-modal').classList.add('hidden');}
function filteredHistory(){
  const from=document.getElementById('date-from').value,to=document.getElementById('date-to').value;
  if(!from||!to)return[];
  return loadHistory().filter(r=>{const p=r.fecha.split('/');if(p.length!==3)return false;const iso=`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;return iso>=from&&iso<=to;});
}
function updateExcelInfo(){const f=filteredHistory();document.getElementById('excel-info').innerHTML=`Se exportar√°n <span>${f.length}</span> registro${f.length!==1?'s':''} en el rango seleccionado`;}
function downloadExcel(){
  const rows=filteredHistory();
  if(!rows.length){document.getElementById('excel-info').innerHTML='<span style="color:var(--red)">No hay registros en ese rango</span>';return;}
  const data=rows.map(r=>({'Fecha':r.fecha,'M√≥dulo':r.modulo,'Transici√≥n':`${LABELS[r.estadoAnterior]} ‚Üí ${LABELS[r.estadoNuevo]}`,'Duraci√≥n (minutos)':r.durMinutos,'Mec√°nico':r.mecanico||''}));
  const ws2=XLSX.utils.json_to_sheet(data);ws2['!cols']=[{wch:12},{wch:8},{wch:28},{wch:20},{wch:22}];
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws2,'Historial');
  const desde=document.getElementById('date-from').value.replace(/-/g,''),hasta=document.getElementById('date-to').value.replace(/-/g,'');
  XLSX.writeFile(wb,`mecanicos_millar_${desde}_${hasta}.xlsx`);
  closeExcelModal();showToastSimple('‚úÖ Excel descargado correctamente');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACIONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Lista maestra de permisos ‚Äî agregar aqu√≠ cada nueva pantalla/funci√≥n
const ALL_PERMS = [
  {key:'area_mecanicos', label:'Ver Tablero Mec√°nicos'},
  {key:'tablero',        label:'Tablero Planta'},
  {key:'excel',          label:'Descargar Excel'},
  {key:'area_produccion',label:'√Årea Producci√≥n'},
  {key:'modulos',        label:'M√≥dulos (Vista M√≥dulo)'},
  {key:'fix',            label:'Corregir Mec√°nico'},
  {key:'area_ingreso',   label:'Control de Ingreso'},
];
const PERM_LABELS = Object.fromEntries(ALL_PERMS.map(p=>[p.key,p.label]));

const CONFIG_PERMS = {
  'Administrador': {label:'Administrador', available:ALL_PERMS.map(p=>p.key)},
  'Televisor':     {label:'Televisor',     available:ALL_PERMS.map(p=>p.key)},
  'Mecanicos':     {label:'Mec√°nicos',     available:ALL_PERMS.map(p=>p.key)},
  'Modulos':       {label:'M√≥dulos',       available:ALL_PERMS.map(p=>p.key)},
};
const CONFIG_KEY = 'millar_config_v1';

function loadConfig(){
  try{ return JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}'); }catch(e){ return {}; }
}
function saveConfig(cfg){ localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg)); }

function applyConfig(){
  const cfg = loadConfig();
  // Aplicar cambios a usuarios base
  Object.keys(CONFIG_PERMS).forEach(user=>{
    if(!cfg[user]) return;
    if(cfg[user].disabled){ delete USUARIOS[user]; return; }
    if(cfg[user].perms) USUARIOS[user].perms = cfg[user].perms;
  });
  // Cargar usuarios extra creados manualmente
  (cfg._usuarios_extra||[]).forEach(u=>{
    if(u.disabled){ delete USUARIOS[u.nombre]; return; }
    USUARIOS[u.nombre] = {pass: u.pass, perms: u.perms||[]};
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACIONES ‚Äî 3 pesta√±as: Usuarios | M√≥dulos | Permisos
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentCfgTab = 'usuarios';
let userFormMode = null; // 'create' | 'edit'
let userFormTarget = null; // nombre del usuario editado
let modFormMode = null;
let modFormTarget = null;
let deleteCallback = null;

function openConfigModal(){
  currentCfgTab = 'usuarios';
  document.getElementById('modal-config').classList.remove('hidden');
  const s = document.getElementById('cfg-search');
  if(s) s.value = '';
  switchCfgTab('usuarios');
}

function onCfgSearch(){
  if(currentCfgTab==='usuarios')  renderCfgUsuarios();
  if(currentCfgTab==='modulos')   renderCfgModulos();
  if(currentCfgTab==='permisos')  renderCfgPermisos();
}

function getCfgSearchQuery(){
  const el = document.getElementById('cfg-search');
  return el ? el.value.trim().toLowerCase() : '';
}

function onCfgCrear(){
  if(currentCfgTab==='usuarios') openUserForm('create');
  if(currentCfgTab==='modulos')  openModForm('create');
}
function closeConfigModal(){
  document.getElementById('modal-config').classList.add('hidden');
  populateLoginSelect();
  if(currentView===null) mostrarAreaScreen();
}
function switchCfgTab(tab){
  currentCfgTab = tab;
  const s = document.getElementById('cfg-search');
  if(s) s.value = '';
  const btnCrear = document.getElementById('cfg-btn-crear');
  if(btnCrear) btnCrear.style.display = tab==='permisos' ? 'none' : '';
  ['usuarios','modulos','permisos'].forEach(t=>{
    const btn = document.getElementById('cfg-tab-'+t);
    if(t===tab){ btn.style.background='var(--green)'; btn.style.color='#080c14'; btn.style.borderColor='var(--green)'; }
    else { btn.style.background='transparent'; btn.style.color='var(--muted)'; btn.style.borderColor='var(--border)'; }
  });
  if(tab==='usuarios')  renderCfgUsuarios();
  if(tab==='modulos')   renderCfgModulos();
  if(tab==='permisos')  renderCfgPermisos();
}

// ‚îÄ‚îÄ PESTA√ëA USUARIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCfgUsuarios(){
  // Usuarios base del sistema (no editables = Programador)
  const base = {};
  Object.entries(USUARIOS).forEach(([k,v])=>{ base[k]={pass:v.pass, perms:v.perms, builtin: k==='Programador'}; });
  // Merge con extras guardados en config
  const cfg = loadConfig();
  if(cfg._usuarios_extra){ cfg._usuarios_extra.forEach(u=>{ base[u.nombre]={pass:u.pass, perms:u.perms||[], disabled:!!u.disabled, extra:true}; }); }
  return base;
}
function getUsuariosExtra(){
  const cfg = loadConfig(); return cfg._usuarios_extra||[];
}
function saveUsuariosExtra(arr){
  const cfg = loadConfig(); cfg._usuarios_extra=arr; saveConfig(cfg);
}

function renderCfgUsuarios(){
  const container = document.getElementById('cfg-content');
  container.innerHTML = '';


  const q = getCfgSearchQuery();
  const allUsers = getCfgUsuarios();
  Object.entries(allUsers)
    .sort(([a],[b])=>a.localeCompare(b))
    .filter(([nombre])=> !q || nombre.toLowerCase().includes(q)).forEach(([nombre, data])=>{
    const card = document.createElement('div');
    const isDisabled = !!data.disabled;
    const isBuiltin = !!data.builtin;
    card.style.cssText='background:#080c14;border:1px solid #1a2236;border-radius:10px;padding:13px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;';
    // Info
    const info = document.createElement('div');
    info.style.cssText='flex:1;min-width:0;';
    info.innerHTML=`
      <div style="font-size:14px;font-weight:700;color:${isDisabled?'var(--muted)':'#f1f5f9'};display:flex;align-items:center;gap:8px;">
        ${nombre} ${isBuiltin?'<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(167,139,250,0.15);color:#c4b5fd;letter-spacing:1px;">SISTEMA</span>':''}
        ${isDisabled?'<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,0.12);color:var(--red);">INACTIVO</span>':''}
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:3px;font-family:Courier New,monospace;letter-spacing:2px;">${isBuiltin?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢':'Pass: '+data.pass}</div>`;
    card.appendChild(info);
    // Acciones
    const actions = document.createElement('div');
    actions.style.cssText='display:flex;gap:6px;flex-shrink:0;';
    if(!isBuiltin){
      const btnEdit = document.createElement('button');
      btnEdit.style.cssText='padding:6px 12px;border-radius:6px;border:1px solid rgba(99,179,237,0.3);background:transparent;color:#93c5fd;font-size:12px;font-weight:600;cursor:pointer;';
      btnEdit.textContent='‚úèÔ∏è Editar';
      btnEdit.onclick=()=>openUserForm('edit', nombre, data.pass);
      actions.appendChild(btnEdit);

      const btnToggle = document.createElement('button');
      btnToggle.style.cssText=`padding:6px 12px;border-radius:6px;border:1px solid ${isDisabled?'rgba(34,197,94,0.3)':'rgba(234,179,8,0.3)'};background:transparent;color:${isDisabled?'var(--green)':'var(--yellow)'};font-size:12px;font-weight:600;cursor:pointer;`;
      btnToggle.textContent=isDisabled?'‚úÖ Habilitar':'‚è∏ Inhabilitar';
      btnToggle.onclick=()=>toggleExtraUser(nombre);
      actions.appendChild(btnToggle);

      const btnDel = document.createElement('button');
      btnDel.style.cssText='padding:6px 12px;border-radius:6px;border:1px solid rgba(239,68,68,0.3);background:transparent;color:var(--red);font-size:12px;font-weight:600;cursor:pointer;';
      btnDel.textContent='üóë Eliminar';
      btnDel.onclick=()=>confirmDelete(`¬øEliminar usuario "${nombre}"?`, 'Esta acci√≥n no se puede deshacer.', ()=>deleteExtraUser(nombre));
      actions.appendChild(btnDel);
    } else {
      // Usuarios builtin: solo inhabilitar/habilitar (excepto Programador)
      if(nombre!=='Programador'){
        const cfg=loadConfig(); const isOff=!!(cfg[nombre]&&cfg[nombre].disabled);
        const btnToggle = document.createElement('button');
        btnToggle.style.cssText=`padding:6px 12px;border-radius:6px;border:1px solid ${isOff?'rgba(34,197,94,0.3)':'rgba(234,179,8,0.3)'};background:transparent;color:${isOff?'var(--green)':'var(--yellow)'};font-size:12px;font-weight:600;cursor:pointer;`;
        btnToggle.textContent=isOff?'‚úÖ Habilitar':'‚è∏ Inhabilitar';
        btnToggle.onclick=()=>{ toggleUserEnabled(nombre,null); renderCfgUsuarios(); };
        actions.appendChild(btnToggle);
      }
    }
    card.appendChild(actions);
    container.appendChild(card);
  });
}

function openUserForm(mode, nombre='', pass=''){
  userFormMode=mode; userFormTarget=nombre;
  document.getElementById('user-form-title').textContent = mode==='create'?'Nuevo Usuario':'Editar Usuario';
  document.getElementById('uf-nombre').value=nombre;
  document.getElementById('uf-nombre').disabled=(mode==='edit');
  document.getElementById('uf-nombre').style.opacity=(mode==='edit')?'0.5':'1';
  document.getElementById('uf-pass').value=pass;
  document.getElementById('uf-error').textContent='';
  document.getElementById('modal-user-form').classList.remove('hidden');
  setTimeout(()=>document.getElementById(mode==='create'?'uf-nombre':'uf-pass').focus(),100);
}
function closeUserForm(){ document.getElementById('modal-user-form').classList.add('hidden'); }
function saveUserForm(){
  const nombre = document.getElementById('uf-nombre').value.trim();
  const pass   = document.getElementById('uf-pass').value.trim();
  const errEl  = document.getElementById('uf-error');
  if(!nombre){ errEl.textContent='El nombre no puede estar vac√≠o'; document.getElementById('uf-nombre').style.borderColor='var(--red)'; return; }
  if(!pass)  { errEl.textContent='La contrase√±a no puede estar vac√≠a'; document.getElementById('uf-pass').style.borderColor='var(--red)'; return; }
  const extras = getUsuariosExtra();
  if(userFormMode==='create'){
    if(USUARIOS[nombre]||extras.find(u=>u.nombre===nombre)){ errEl.textContent='Ya existe un usuario con ese nombre'; return; }
    extras.push({nombre, pass, perms:[], disabled:false});
    USUARIOS[nombre]={pass, perms:[]};
  } else {
    const idx=extras.findIndex(u=>u.nombre===userFormTarget);
    if(idx>-1){ extras[idx].pass=pass; }
    if(USUARIOS[userFormTarget]) USUARIOS[userFormTarget].pass=pass;
  }
  saveUsuariosExtra(extras);
  closeUserForm();
  renderCfgUsuarios();
  showToastSimple(`‚úÖ Usuario ${userFormMode==='create'?'creado':'actualizado'}`);
}
function toggleExtraUser(nombre){
  const extras=getUsuariosExtra();
  const idx=extras.findIndex(u=>u.nombre===nombre);
  if(idx>-1){ extras[idx].disabled=!extras[idx].disabled; if(USUARIOS[nombre]) USUARIOS[nombre].perms=extras[idx].disabled?[]:extras[idx].perms; }
  saveUsuariosExtra(extras); renderCfgUsuarios();
}
function deleteExtraUser(nombre){
  const extras=getUsuariosExtra().filter(u=>u.nombre!==nombre);
  saveUsuariosExtra(extras);
  delete USUARIOS[nombre];
  renderCfgUsuarios();
  showToastSimple(`üóë Usuario "${nombre}" eliminado`);
}

// ‚îÄ‚îÄ PESTA√ëA M√ìDULOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCfgModulos(){
  const cfg=loadConfig();
  const disabled=cfg._modulos_disabled||[];
  const extra=cfg._modulos_extra||[];
  return {disabled, extra};
}
function saveCfgModulos(disabled, extra){
  const cfg=loadConfig(); cfg._modulos_disabled=disabled; cfg._modulos_extra=extra; saveConfig(cfg);
  // Reconstruir array MODULES global
  rebuildModules();
}
function rebuildModules(){
  const cfg=loadConfig();
  const base=['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27'];
  const extra=cfg._modulos_extra||[];
  const disabled=cfg._modulos_disabled||[];
  const renamed=cfg._modulos_renamed||{};
  // Rebuild global MODULES
  MODULES.length=0;
  [...base,...extra].forEach(id=>{
    if(!disabled.includes(id)) MODULES.push(renamed[id]||id);
  });
  // Init states for new modules
  MODULES.forEach(id=>{ if(states[id]===undefined){states[id]='green';timers[id]=Date.now();lastMec[id]='';acumRed[id]=0;acumYellow[id]=0;} });
}

function renderCfgModulos(){
  const container=document.getElementById('cfg-content');
  container.innerHTML='';
  const cfg=loadConfig();
  const disabled=cfg._modulos_disabled||[];
  const extra=cfg._modulos_extra||[];
  const renamed=cfg._modulos_renamed||{};
  const base=['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27'];



  // Grid de m√≥dulos
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:8px;';

  const allMods=[...base.map(id=>({id,extra:false})),...extra.map(id=>({id,extra:true}))];
  const qm = getCfgSearchQuery();
  allMods.filter(({id})=> !qm || id.toLowerCase().includes(qm) || (renamed[id]||'').toLowerCase().includes(qm)).forEach(({id,extra:isExtra})=>{
    const isDisabled=disabled.includes(id);
    const displayName=renamed[id]||id;
    const card=document.createElement('div');
    card.style.cssText=`background:#080c14;border:1px solid ${isDisabled?'#1a2236':'rgba(34,197,94,0.15)'};border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:8px;opacity:${isDisabled?'0.5':'1'};`;
    const modPassVal = (cfg._modulos_pass||{})[id]||id;
    card.innerHTML=`<div style="flex:1;min-width:0;">
      <div style="font-family:Courier New,monospace;font-size:13px;font-weight:700;color:${isDisabled?'var(--muted)':'#cbd5e1'};letter-spacing:2px;">${displayName}</div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px;letter-spacing:1px;">üîë ${modPassVal}</div>
    </div>`;
    const acts=document.createElement('div');
    acts.style.cssText='display:flex;gap:4px;';
    // Editar nombre
    const bEdit=document.createElement('button');
    bEdit.style.cssText='padding:4px 8px;border-radius:5px;border:1px solid rgba(99,179,237,0.3);background:transparent;color:#93c5fd;font-size:11px;cursor:pointer;';
    bEdit.textContent='‚úèÔ∏è';bEdit.title='Renombrar';
    bEdit.onclick=()=>openModForm('edit',id,displayName);
    acts.appendChild(bEdit);
    // Inhabilitar/habilitar
    const bToggle=document.createElement('button');
    bToggle.style.cssText=`padding:4px 8px;border-radius:5px;border:1px solid ${isDisabled?'rgba(34,197,94,0.3)':'rgba(234,179,8,0.3)'};background:transparent;color:${isDisabled?'var(--green)':'var(--yellow)'};font-size:11px;cursor:pointer;`;
    bToggle.textContent=isDisabled?'‚úÖ':'‚è∏';bToggle.title=isDisabled?'Habilitar':'Inhabilitar';
    bToggle.onclick=()=>toggleModulo(id);
    acts.appendChild(bToggle);
    // Eliminar (solo extras)
    if(isExtra){
      const bDel=document.createElement('button');
      bDel.style.cssText='padding:4px 8px;border-radius:5px;border:1px solid rgba(239,68,68,0.3);background:transparent;color:var(--red);font-size:11px;cursor:pointer;';
      bDel.textContent='üóë';bDel.title='Eliminar';
      bDel.onclick=()=>confirmDelete(`¬øEliminar m√≥dulo "${displayName}"?`,'Esta acci√≥n no se puede deshacer.',()=>deleteModulo(id));
      acts.appendChild(bDel);
    }
    card.appendChild(acts);
    grid.appendChild(card);
  });
  container.appendChild(grid);
}

function getModPass(id){
  const cfg=loadConfig();
  const passes=cfg._modulos_pass||{};
  return passes[id]||'';
}
function openModForm(mode, id='', nombre=''){
  modFormMode=mode; modFormTarget=id;
  document.getElementById('mod-form-title').textContent=mode==='create'?'Nuevo M√≥dulo':'Editar M√≥dulo';
  const nombreInput=document.getElementById('mf-nombre');
  nombreInput.value=nombre;
  nombreInput.disabled=(mode==='edit');
  nombreInput.style.opacity=(mode==='edit')?'0.5':'1';
  document.getElementById('mf-pass').value=getModPass(id);
  document.getElementById('mf-error').textContent='';
  document.getElementById('modal-mod-form').classList.remove('hidden');
  setTimeout(()=>document.getElementById(mode==='create'?'mf-nombre':'mf-pass').focus(),100);
}
function closeModForm(){ document.getElementById('modal-mod-form').classList.add('hidden'); }
function saveModForm(){
  const nombre=document.getElementById('mf-nombre').value.trim().toUpperCase();
  const pass=document.getElementById('mf-pass').value.trim();
  const errEl=document.getElementById('mf-error');
  if(!nombre){ errEl.textContent='El nombre no puede estar vac√≠o'; return; }
  const cfg=loadConfig();
  const base=['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27'];
  const extra=cfg._modulos_extra||[];
  if(!cfg._modulos_pass) cfg._modulos_pass={};
  if(modFormMode==='create'){
    if([...base,...extra].includes(nombre)){ errEl.textContent='Ya existe un m√≥dulo con ese nombre'; return; }
    extra.push(nombre);
    cfg._modulos_extra=extra;
    states[nombre]='green'; timers[nombre]=Date.now(); lastMec[nombre]=''; acumRed[nombre]=0; acumYellow[nombre]=0;
  } else {
    if(!cfg._modulos_renamed) cfg._modulos_renamed={};
    cfg._modulos_renamed[modFormTarget]=nombre;
  }
  // Guardar contrase√±a si se defini√≥
  const targetId = modFormMode==='create' ? nombre : modFormTarget;
  if(pass) cfg._modulos_pass[targetId]=pass;
  else delete cfg._modulos_pass[targetId];
  saveConfig(cfg);
  rebuildModules();
  closeModForm();
  renderCfgModulos();
  showToastSimple(`‚úÖ M√≥dulo ${modFormMode==='create'?'creado':'actualizado'}`);
}
function toggleModulo(id){
  const cfg=loadConfig();
  const disabled=cfg._modulos_disabled||[];
  const idx=disabled.indexOf(id);
  if(idx>-1) disabled.splice(idx,1); else disabled.push(id);
  cfg._modulos_disabled=disabled; saveConfig(cfg);
  rebuildModules(); renderCfgModulos();
}
function deleteModulo(id){
  const cfg=loadConfig();
  cfg._modulos_extra=(cfg._modulos_extra||[]).filter(m=>m!==id);
  cfg._modulos_disabled=(cfg._modulos_disabled||[]).filter(m=>m!==id);
  if(cfg._modulos_renamed) delete cfg._modulos_renamed[id];
  saveConfig(cfg);
  rebuildModules(); renderCfgModulos();
  showToastSimple(`üóë M√≥dulo "${id}" eliminado`);
}

// ‚îÄ‚îÄ PESTA√ëA PERMISOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCfgPermisos(){
  const cfg = loadConfig();
  const container = document.getElementById('cfg-content');
  container.innerHTML = '';
  const qp = getCfgSearchQuery();

  // Combinar usuarios base (CONFIG_PERMS) + usuarios extra creados manualmente
  const extraUsers = (cfg._usuarios_extra||[]).map(u=>([u.nombre, {label: u.nombre, isExtra: true}]));
  const baseEntries = Object.entries(CONFIG_PERMS).map(([k,v])=>([k, {...v, isExtra:false}]));
  const allEntries = [...baseEntries, ...extraUsers]
    .sort(([a],[b])=>a.localeCompare(b))
    .filter(([user, meta])=> !qp || user.toLowerCase().includes(qp) || (meta.label||'').toLowerCase().includes(qp));

  allEntries.forEach(([user, meta])=>{
    const userCfg = cfg[user] || {};
    const isDisabled = !!userCfg.disabled;
    const activePerms = userCfg.perms !== undefined ? userCfg.perms : (USUARIOS[user]?.perms || []);
    const card = document.createElement('div');
    card.style.cssText = 'background:#080c14;border:1px solid #1a2236;border-radius:12px;padding:16px;margin-bottom:12px;';
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;';
    header.innerHTML = `
      <span style="font-size:14px;font-weight:700;letter-spacing:1px;color:#f1f5f9;">${meta.label}</span>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--muted);">
        <span>${isDisabled?'Deshabilitado':'Habilitado'}</span>
        <div onclick="toggleUserEnabled('${user}',this)" style="width:40px;height:22px;border-radius:11px;background:${isDisabled?'#1a2236':'var(--green)'};border:1px solid ${isDisabled?'#2d3f5a':'var(--green)'};cursor:pointer;position:relative;transition:all 0.2s;">
          <div style="position:absolute;top:3px;${isDisabled?'left:3px':'left:19px'};width:14px;height:14px;border-radius:50%;background:${isDisabled?'var(--muted)':'#080c14'};transition:all 0.2s;"></div>
        </div>
      </label>`;
    card.appendChild(header);
    if(!isDisabled){
      const permsDiv = document.createElement('div');
      permsDiv.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:8px;';
      ALL_PERMS.forEach(({key, label})=>{
        const checked = activePerms.includes(key);
        const row = document.createElement('label');
        row.style.cssText = 'display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px;color:var(--muted);';
        row.innerHTML = `
          <input type="checkbox" data-user="${user}" data-perm="${key}" ${checked?'checked':''}
            onchange="togglePerm('${user}','${key}',this.checked)"
            style="width:16px;height:16px;accent-color:var(--green);cursor:pointer;">
          <span>${label}</span>`;
        permsDiv.appendChild(row);
      });
      card.appendChild(permsDiv);
    }
    container.appendChild(card);
  });
}

// ‚îÄ‚îÄ CONFIRM DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmDelete(titulo, sub, cb){
  deleteCallback=cb;
  document.getElementById('confirm-delete-title').textContent=titulo;
  document.getElementById('confirm-delete-sub').textContent=sub;
  document.getElementById('modal-confirm-delete').classList.remove('hidden');
}
function closeConfirmDelete(){ document.getElementById('modal-confirm-delete').classList.add('hidden'); deleteCallback=null; }
function executeDelete(){ const cb=deleteCallback; closeConfirmDelete(); if(cb) cb(); }

// ‚îÄ‚îÄ CONFIG helpers (mantener compatibilidad) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// renderConfigContent ahora redirige a la pesta√±a de permisos
function renderConfigContent(){ renderCfgPermisos(); }

function toggleUserEnabled(user, toggleEl){
  const cfg = loadConfig();
  if(!cfg[user]) cfg[user] = {};
  cfg[user].disabled = !cfg[user].disabled;
  saveConfig(cfg);
  if(cfg[user].disabled){
    USUARIOS[user] = {pass: USUARIOS[user]?.pass||'1', perms:[]};
  } else {
    const meta = CONFIG_PERMS[user];
    USUARIOS[user] = {pass: USUARIOS[user]?.pass||'1', perms: cfg[user].perms || meta.available};
  }
  if(currentCfgTab==='permisos') renderCfgPermisos();
  if(currentCfgTab==='usuarios') renderCfgUsuarios();
}

function togglePerm(user, perm, enabled){
  const cfg = loadConfig();
  if(!cfg[user]) cfg[user] = {};
  const base = cfg[user].perms !== undefined ? cfg[user].perms : (USUARIOS[user]?.perms ? [...USUARIOS[user].perms] : []);
  if(enabled){ if(!base.includes(perm)) base.push(perm); }
  else { const idx=base.indexOf(perm); if(idx>-1) base.splice(idx,1); }
  cfg[user].perms = base;
  // Si es usuario extra, tambi√©n actualizar en _usuarios_extra
  const extras = cfg._usuarios_extra||[];
  const ei = extras.findIndex(u=>u.nombre===user);
  if(ei>-1){ extras[ei].perms=base; cfg._usuarios_extra=extras; }
  saveConfig(cfg);
  if(USUARIOS[user]) USUARIOS[user].perms = base;
  else USUARIOS[user] = {pass: (extras[ei]?.pass||''), perms: base};
}

// Apply saved config on load
applyConfig();

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(id,state){const msgs={red:`üî¥ ${id} ‚Äî Solicita mec√°nico`,yellow:`üü° ${id} ‚Äî Mec√°nico en camino`,green:`üü¢ ${id} ‚Äî Resuelto`};const t=document.createElement('div');t.className=`toast ${state}`;t.textContent=msgs[state];document.getElementById('toasts').appendChild(t);setTimeout(()=>t.remove(),3200);}
function showToastSimple(msg){const t=document.createElement('div');t.className='toast green';t.textContent=msg;document.getElementById('toasts').appendChild(t);setTimeout(()=>t.remove(),3200);}
function addRipple(el,e){const r=el.getBoundingClientRect(),rip=document.createElement('div');rip.className='ripple';const sz=Math.max(r.width,r.height);rip.style.cssText=`width:${sz}px;height:${sz}px;left:${e.clientX-r.left-sz/2}px;top:${e.clientY-r.top-sz/2}px`;el.appendChild(rip);setTimeout(()=>rip.remove(),650);}
setInterval(()=>{const n=new Date();document.getElementById('clock').textContent=[n.getHours(),n.getMinutes(),n.getSeconds()].map(x=>String(x).padStart(2,'0')).join(':');},1000);
</script>


<!-- MODAL: Configuraciones -->
<div class="modal-overlay hidden" id="modal-config">
  <div style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:28px 28px 24px;display:flex;flex-direction:column;gap:16px;width:96%;max-width:580px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.7);animation:slup 0.25s ease;">
    <div style="text-align:center;font-size:15px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#f1f5f9;">‚öôÔ∏è CONFIGURACIONES</div>
    <!-- Pesta√±as -->
    <div style="display:flex;gap:6px;border-bottom:1px solid var(--border);padding-bottom:12px;">
      <button id="cfg-tab-usuarios"  onclick="switchCfgTab('usuarios')"  style="flex:1;padding:9px 6px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;background:var(--green);color:#080c14;font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all 0.2s;">üë§ USUARIOS</button>
      <button id="cfg-tab-modulos"   onclick="switchCfgTab('modulos')"   style="flex:1;padding:9px 6px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;background:transparent;color:var(--muted);font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all 0.2s;">üè≠ M√ìDULOS</button>
      <button id="cfg-tab-permisos"  onclick="switchCfgTab('permisos')"  style="flex:1;padding:9px 6px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;background:transparent;color:var(--muted);font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all 0.2s;">üîë PERMISOS</button>
    </div>
    <!-- Buscador + Crear -->
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="position:relative;flex:1;">
        <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none;">üîç</span>
        <input id="cfg-search" type="text" placeholder="Buscar..." oninput="onCfgSearch()"
          style="width:100%;padding:10px 14px 10px 36px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;outline:none;transition:border-color 0.2s;"
          onfocus="this.style.borderColor='#3d5a8a'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <button id="cfg-btn-crear" onclick="onCfgCrear()"
        style="padding:10px 16px;border-radius:8px;border:1px solid rgba(34,197,94,0.4);background:rgba(34,197,94,0.08);color:var(--green);font-size:13px;font-weight:700;white-space:nowrap;cursor:pointer;transition:all 0.2s;flex-shrink:0;"
        onmouseover="this.style.background='rgba(34,197,94,0.15)'" onmouseout="this.style.background='rgba(34,197,94,0.08)'">
        + Crear
      </button>
    </div>
    <!-- Contenido pesta√±as -->
    <div id="cfg-content" style="overflow-y:auto;flex:1;min-height:0;"></div>
    <button class="modal-btn secondary" onclick="closeConfigModal()" style="margin-top:4px;flex-shrink:0;">Cerrar</button>
  </div>
</div>

<!-- MODAL: Formulario usuario (crear/editar) -->
<div class="modal-overlay hidden" id="modal-user-form" style="z-index:700;">
  <div class="modal-box" style="max-width:360px;width:92%;gap:14px;">
    <div class="modal-title" id="user-form-title">Nuevo Usuario</div>
    <div style="width:100%;display:flex;flex-direction:column;gap:10px;">
      <div style="display:flex;flex-direction:column;gap:5px;">
        <label style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Nombre de usuario</label>
        <input id="uf-nombre" type="text" placeholder="Ej: Supervisor" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;outline:none;" oninput="this.style.borderColor='var(--border)'">
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;">
        <label style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Contrase√±a</label>
        <input id="uf-pass" type="text" placeholder="Contrase√±a" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;font-family:'Courier New',monospace;letter-spacing:3px;outline:none;" oninput="this.style.borderColor='var(--border)'">
      </div>
    </div>
    <div id="uf-error" style="font-size:12px;color:var(--red);min-height:16px;text-align:center;"></div>
    <div style="display:flex;gap:8px;width:100%;">
      <button class="modal-btn secondary" style="flex:1;" onclick="closeUserForm()">Cancelar</button>
      <button class="modal-btn" style="flex:1;" onclick="saveUserForm()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: Formulario m√≥dulo (crear/editar) -->
<div class="modal-overlay hidden" id="modal-mod-form" style="z-index:700;">
  <div class="modal-box" style="max-width:360px;width:92%;gap:14px;">
    <div class="modal-title" id="mod-form-title">Nuevo M√≥dulo</div>
    <div style="width:100%;display:flex;flex-direction:column;gap:10px;">
      <div style="display:flex;flex-direction:column;gap:5px;">
        <label style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Nombre del m√≥dulo</label>
        <input id="mf-nombre" type="text" placeholder="Ej: M28" maxlength="10" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:16px;font-family:'Courier New',monospace;letter-spacing:4px;outline:none;" oninput="this.style.borderColor='var(--border)'">
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;">
        <label style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);">Contrase√±a del m√≥dulo</label>
        <input id="mf-pass" type="text" placeholder="Dejar vac√≠o = usar nombre como clave" style="padding:11px 14px;border-radius:8px;border:1px solid var(--border);background:#080c14;color:var(--text);font-size:14px;font-family:'Courier New',monospace;letter-spacing:3px;outline:none;" oninput="this.style.borderColor='var(--border)'">
      </div>
    </div>
    <div id="mf-error" style="font-size:12px;color:var(--red);min-height:16px;text-align:center;"></div>
    <div style="display:flex;gap:8px;width:100%;">
      <button class="modal-btn secondary" style="flex:1;" onclick="closeModForm()">Cancelar</button>
      <button class="modal-btn" style="flex:1;" onclick="saveModForm()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: Confirmaci√≥n eliminar -->
<div class="modal-overlay hidden" id="modal-confirm-delete" style="z-index:700;">
  <div class="modal-box" style="max-width:340px;width:92%;gap:16px;">
    <div class="modal-icon">‚ö†Ô∏è</div>
    <div class="modal-title" id="confirm-delete-title">¬øEliminar?</div>
    <div class="modal-sub" id="confirm-delete-sub">Esta acci√≥n no se puede deshacer.</div>
    <div style="display:flex;gap:8px;width:100%;">
      <button class="modal-btn secondary" style="flex:1;" onclick="closeConfirmDelete()">Cancelar</button>
      <button style="flex:1;padding:13px;border-radius:8px;border:none;background:var(--red);color:#fff;font-size:13px;font-weight:700;letter-spacing:1px;cursor:pointer;" onclick="executeDelete()">Eliminar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CONTROL DE INGRESO ‚Äî Pantalla completa superpuesta
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="ingreso-screen" style="
  display:none;
  position:fixed;inset:0;z-index:800;
  background:#0a0e1a;
  flex-direction:column;
  overflow:hidden;
">
  <!-- Barra superior con bot√≥n volver -->
  <div style="
    position:sticky;top:0;z-index:900;
    display:flex;align-items:center;gap:14px;
    padding:12px 20px;
    background:rgba(10,14,26,0.97);
    border-bottom:1px solid #1f2d44;
    backdrop-filter:blur(10px);
    flex-shrink:0;
  ">
    <button onclick="cerrarControlIngreso()" style="
      display:flex;align-items:center;gap:8px;
      padding:8px 16px;border-radius:8px;
      border:1px solid rgba(99,179,237,0.35);
      background:rgba(99,179,237,0.06);
      color:#93c5fd;font-family:'Segoe UI',Arial,sans-serif;
      font-size:13px;font-weight:700;letter-spacing:1px;
      cursor:pointer;transition:all 0.2s;
    "
    onmouseover="this.style.background='rgba(99,179,237,0.14)'"
    onmouseout="this.style.background='rgba(99,179,237,0.06)'"
    >‚¨Ö Volver a Millar</button>
    <span style="font-size:11px;color:#4b5a72;letter-spacing:3px;text-transform:uppercase;">
      Control de Piso ‚Äî Confecciones Millar
    </span>
  </div>

  <!-- Contenedor scrolleable donde se inyecta el Control de Asistencia -->
  <div id="ingreso-body" style="flex:1;overflow-y:auto;"></div>
</div>

<script>
// ‚îÄ‚îÄ CONTROL DE INGRESO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirControlIngreso(){
  const screen = document.getElementById('ingreso-screen');
  screen.style.display = 'flex';
  // Solo inicializar la primera vez
  if(!document.getElementById('ingreso-app-root')){
    // Mostrar loader mientras esperamos datos del servidor
    const body = document.getElementById('ingreso-body');
    body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;gap:16px;color:#6b7a99;font-family:Segoe UI,sans-serif;">' +
      '<div style="width:40px;height:40px;border:3px solid #1f2d44;border-top-color:#00e5a0;border-radius:50%;animation:spin 0.8s linear infinite;"></div>' +
      '<span style="font-size:13px;letter-spacing:2px;text-transform:uppercase;">Cargando datos del servidor...</span>' +
      '<style>@keyframes spin{to{transform:rotate(360deg)}}</style></div>';
    // Esperar datos del servidor antes de cargar la app
    iaWaitReady(function(){
      body.innerHTML = '';
      cargarAppIngreso();
    });
  }
}

function cerrarControlIngreso(){
  document.getElementById('ingreso-screen').style.display = 'none';
  mostrarAreaScreen();
}

function cargarAppIngreso(){
  const body = document.getElementById('ingreso-body');

  // ‚îÄ‚îÄ Inyectar CSS del Control de Asistencia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const style = document.createElement('style');
  style.id = 'ingreso-styles';
  style.textContent = `
    #ingreso-body { font-family: 'Syne', sans-serif; }
    #ingreso-app-root { min-height:100vh; }

    /* Reset scoped al contenedor */
    #ingreso-body *{ box-sizing:border-box; }

    /* Variables propias del Control de Asistencia */
    #ingreso-body {
      --ia-bg:#0a0e1a; --ia-surface:#111827; --ia-surface2:#1a2235;
      --ia-accent:#00e5a0; --ia-accent2:#0077ff;
      --ia-text:#e8ecf4; --ia-muted:#6b7a99; --ia-border:#1f2d44;
      --ia-danger:#ff4d6d; --ia-warn:#ffa63d; --ia-absent:#ff4d6d;
    }
  `;
  document.head.appendChild(style);

  // Cargar fuentes si no est√°n
  if(!document.getElementById('syne-font')){
    const link = document.createElement('link');
    link.id = 'syne-font';
    link.rel = 'stylesheet';
    link.href = 'https://fonts.googleapis.com/css2?family=Syne:wght@400;600;800&family=DM+Mono:wght@400;500&display=swap';
    document.head.appendChild(link);
  }

  // ‚îÄ‚îÄ Inyectar HTML del Control de Asistencia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const wrapper = document.createElement('div');
  wrapper.id = 'ingreso-app-root';
  wrapper.innerHTML = getIngresoHTML();
  body.appendChild(wrapper);

  // ‚îÄ‚îÄ Ejecutar scripts del Control de Asistencia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  runIngresoScript();
}

// ‚îÄ‚îÄ HTML del Control de Asistencia (sin <html>,<head>,<body>) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getIngresoHTML(){
  return `
<style>
/* ‚îÄ‚îÄ‚îÄ Estilos Control de Asistencia ‚îÄ‚îÄ‚îÄ */
#ingreso-app-root{color:#e8ecf4;background:#0a0e1a;
  background-image:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(0,229,160,.08) 0%,transparent 70%);}
#ia-login{min-height:calc(100vh - 54px);display:flex;align-items:center;justify-content:center;padding:2rem;}
.ia-login-card{background:#111827;border:1px solid #1f2d44;border-radius:20px;padding:3rem 2.5rem;
  width:100%;max-width:420px;box-shadow:0 40px 80px rgba(0,0,0,.5);animation:iaSlideUp .4s cubic-bezier(.22,1,.36,1);}
@keyframes iaSlideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.ia-login-logo{text-align:center;margin-bottom:2.5rem;}
.ia-login-logo .ia-icon{display:inline-flex;align-items:center;justify-content:center;width:64px;height:64px;
  border-radius:16px;background:linear-gradient(135deg,rgba(0,229,160,.2),rgba(0,119,255,.2));
  border:1px solid rgba(0,229,160,.3);font-size:28px;margin-bottom:1rem;}
.ia-login-logo h2{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;letter-spacing:-.03em;color:#e8ecf4;}
.ia-login-logo h2 span{color:#00e5a0;}
.ia-login-logo p{color:#6b7a99;font-size:.85rem;margin-top:.3rem;}
.ia-fg{margin-bottom:1.2rem;}
.ia-fg label{display:block;font-size:.8rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:#6b7a99;margin-bottom:.5rem;}
.ia-fg input,.ia-fg select{width:100%;padding:.85rem 1rem;background:#1a2235;border:1px solid #1f2d44;
  border-radius:10px;color:#e8ecf4;font-family:'DM Mono',monospace;font-size:.9rem;outline:none;transition:border-color .2s;}
.ia-fg select option{background:#1a2235;}
.ia-fg input:focus,.ia-fg select:focus{border-color:#00e5a0;}
.ia-btn-primary{width:100%;padding:1rem;background:#00e5a0;color:#0a0e1a;border:none;border-radius:10px;
  font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;cursor:pointer;transition:opacity .2s;margin-top:.5rem;}
.ia-btn-primary:hover{opacity:.9;}
.ia-err{color:#ff4d6d;font-size:.82rem;text-align:center;margin-top:.8rem;display:none;}

/* App principal */
#ia-app{display:none;}
.ia-header{padding:1rem 2rem;border-bottom:1px solid #1f2d44;display:flex;align-items:center;
  justify-content:space-between;background:rgba(10,14,26,.95);flex-wrap:wrap;gap:.8rem;}
.ia-header-left h3{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;letter-spacing:-.02em;color:#e8ecf4;}
.ia-header-left h3 span{color:#00e5a0;}
.ia-header-left p{font-size:.78rem;color:#6b7a99;font-family:'DM Mono',monospace;}
.ia-header-right{display:flex;align-items:center;gap:.8rem;flex-wrap:wrap;}
.ia-sup-badge{display:flex;align-items:center;gap:.5rem;background:#1a2235;border:1px solid #1f2d44;
  padding:.5rem 1rem;border-radius:8px;font-size:.82rem;color:#e8ecf4;}
.ia-sup-dot{width:8px;height:8px;border-radius:50%;background:#00e5a0;animation:iaPulse 2s infinite;}
@keyframes iaPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.3)}}
.ia-badge-admin{display:inline-flex;align-items:center;gap:.4rem;background:rgba(255,166,61,.1);
  border:1px solid rgba(255,166,61,.3);color:#ffa63d;padding:.3rem .8rem;border-radius:20px;font-size:.75rem;font-weight:700;}
.ia-btn-logout{background:transparent;border:1px solid #1f2d44;color:#6b7a99;padding:.5rem 1rem;
  border-radius:8px;font-family:'Syne',sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s;}
.ia-btn-logout:hover{border-color:#ff4d6d;color:#ff4d6d;}

/* Main */
.ia-main{max-width:1200px;margin:0 auto;padding:2rem;display:grid;gap:1.5rem;}
.ia-tabs{display:flex;gap:.5rem;background:#111827;border:1px solid #1f2d44;padding:.4rem;border-radius:12px;width:fit-content;flex-wrap:wrap;}
.ia-tab-btn{padding:.55rem 1.2rem;border-radius:8px;border:none;font-family:'Syne',sans-serif;
  font-size:.85rem;font-weight:600;cursor:pointer;background:transparent;color:#6b7a99;transition:all .2s;}
.ia-tab-btn.active{background:#00e5a0;color:#0a0e1a;}
.ia-tab-btn.admin-tab.active{background:#ffa63d;color:#0a0e1a;}

/* Stats */
.ia-stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;}
.ia-stat-card{background:#111827;border:1px solid #1f2d44;border-radius:12px;padding:1.2rem 1.5rem;}
.ia-stat-card .ia-slabel{font-size:.75rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:#6b7a99;margin-bottom:.4rem;}
.ia-stat-card .ia-value{font-size:2rem;font-weight:800;color:#00e5a0;line-height:1;font-family:'DM Mono',monospace;}
.ia-stat-card .ia-value.absent{color:#ff4d6d;}
.ia-stat-card .ia-sub{font-size:.78rem;color:#6b7a99;margin-top:.3rem;}

/* Panel */
.ia-panel{background:#111827;border:1px solid #1f2d44;border-radius:16px;padding:2rem;}
.ia-panel h3{font-size:1rem;font-weight:800;letter-spacing:-.02em;margin-bottom:1.5rem;display:flex;align-items:center;gap:.5rem;color:#e8ecf4;}
.ia-panel h3::before{content:'';display:inline-block;width:4px;height:18px;background:#00e5a0;border-radius:2px;}
.ia-panel.ia-warn-panel h3::before{background:#ffa63d;}
.ia-panel-subtitle{font-size:.8rem;color:#6b7a99;margin-top:-.8rem;margin-bottom:1.2rem;}

/* Register grid */
.ia-reg-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
@media(max-width:600px){.ia-reg-grid{grid-template-columns:1fr;}}
.ia-search-wrapper{position:relative;}
.ia-clear-btn{position:absolute;right:.8rem;top:50%;transform:translateY(-50%);background:none;border:none;color:#6b7a99;cursor:pointer;font-size:1rem;}
.ia-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#1a2235;
  border:1px solid #1f2d44;border-radius:10px;max-height:220px;overflow-y:auto;
  z-index:200;display:none;box-shadow:0 20px 40px rgba(0,0,0,.4);}
.ia-dropdown.open{display:block;}
.ia-dd-item{padding:.7rem 1rem;cursor:pointer;font-size:.85rem;font-family:'DM Mono',monospace;
  border-bottom:1px solid rgba(31,45,68,.5);color:#e8ecf4;transition:background .15s;}
.ia-dd-item:last-child{border-bottom:none;}
.ia-dd-item:hover{background:rgba(0,229,160,.08);color:#00e5a0;}
.ia-dd-item mark{background:transparent;color:#00e5a0;font-weight:700;}
.ia-action-btns{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.ia-btn-register{padding:1rem;background:linear-gradient(135deg,#00e5a0,#00c47a);border:none;
  border-radius:10px;color:#0a0e1a;font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.5rem;transition:opacity .2s;}
.ia-btn-register:hover{opacity:.9;}
.ia-btn-absent{padding:1rem;background:transparent;border:2px solid #ff4d6d;border-radius:10px;
  color:#ff4d6d;font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:.5rem;transition:all .2s;}
.ia-btn-absent:hover{background:rgba(255,77,109,.1);}
.ia-toast{grid-column:1/-1;padding:1rem;border-radius:10px;font-size:.9rem;display:none;text-align:center;font-weight:600;}
.ia-toast.ok{background:rgba(0,229,160,.1);border:1px solid rgba(0,229,160,.3);color:#00e5a0;}
.ia-toast.bad{background:rgba(255,77,109,.1);border:1px solid rgba(255,77,109,.3);color:#ff4d6d;}
.ia-today-section{margin-top:1.5rem;}
.ia-today-section h4{font-size:.85rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:#6b7a99;margin-bottom:1rem;}
.ia-chips{display:flex;flex-wrap:wrap;gap:.5rem;}
.ia-chip{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .9rem;border-radius:20px;
  background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);font-size:.78rem;font-family:'DM Mono',monospace;color:#00e5a0;}
.ia-chip.absent{background:rgba(255,77,109,.08);border-color:rgba(255,77,109,.2);color:#ff4d6d;}
.ia-chip .ia-area-tag{background:rgba(0,119,255,.15);color:#7ab8ff;padding:.1rem .4rem;border-radius:4px;font-size:.7rem;}

/* History controls */
.ia-hist-controls{margin-bottom:1.2rem;}
.ia-date-row{display:flex;align-items:flex-end;gap:1rem;flex-wrap:wrap;}
.ia-ctrl-grp{display:flex;flex-direction:column;gap:.4rem;}
.ia-ctrl-grp label{font-size:.75rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:#6b7a99;}
.ia-ctrl-grp input[type="date"],.ia-ctrl-grp select{width:auto;padding:.55rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;outline:none;font-family:'DM Mono',monospace;}
.ia-sort-controls{display:flex;gap:.5rem;align-items:center;}
.ia-sort-label{font-size:.75rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:#6b7a99;}
.ia-sort-btn{padding:.4rem .9rem;background:transparent;border:1px solid #1f2d44;color:#6b7a99;
  border-radius:7px;font-family:'Syne',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .2s;}
.ia-sort-btn.active{border-color:#00e5a0;color:#00e5a0;background:rgba(0,229,160,.08);}
.ia-btn-excel{padding:.6rem 1.3rem;background:rgba(34,139,34,.15);border:1px solid rgba(34,139,34,.4);
  color:#4caf50;border-radius:8px;font-family:'Syne',sans-serif;font-size:.82rem;font-weight:700;
  cursor:pointer;transition:all .2s;white-space:nowrap;}
.ia-btn-excel:hover{background:rgba(34,139,34,.25);}

/* Table */
.ia-table-wrap{overflow-x:auto;}
.ia-table{width:100%;border-collapse:collapse;font-size:.88rem;}
.ia-table thead tr{border-bottom:1px solid #1f2d44;}
.ia-table th{text-align:left;padding:.8rem 1rem;font-size:.75rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:#6b7a99;}
.ia-table td{padding:.9rem 1rem;border-bottom:1px solid rgba(31,45,68,.5);font-family:'DM Mono',monospace;font-size:.85rem;color:#e8ecf4;vertical-align:middle;}
.ia-table tr:hover td{background:rgba(255,255,255,.02);}
.ia-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.25rem .7rem;border-radius:20px;font-size:.75rem;font-weight:600;font-family:'Syne',sans-serif;}
.ia-badge.in{background:rgba(0,229,160,.12);color:#00e5a0;border:1px solid rgba(0,229,160,.2);}
.ia-badge.out{background:rgba(255,77,109,.12);color:#ff4d6d;border:1px solid rgba(255,77,109,.2);}
.ia-badge.area{background:rgba(0,119,255,.12);color:#7ab8ff;border:1px solid rgba(0,119,255,.2);}
.ia-btn-edit{padding:.3rem .8rem;background:transparent;border:1px solid #ffa63d;color:#ffa63d;
  border-radius:6px;font-family:'Syne',sans-serif;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .2s;}
.ia-btn-edit:hover{background:rgba(255,166,61,.1);}
.ia-empty{text-align:center;padding:3rem;color:#6b7a99;font-size:.9rem;display:none;}

/* Admin config */
.ia-admin-sections{display:grid;gap:2rem;}
.ia-admin-section{background:#1a2235;border:1px solid #1f2d44;border-radius:12px;padding:1.5rem;}
.ia-admin-section h4{font-size:.9rem;font-weight:800;margin-bottom:1.2rem;display:flex;align-items:center;gap:.5rem;color:#ffa63d;}
.ia-input-row{display:flex;gap:1rem;align-items:flex-end;flex-wrap:wrap;margin-bottom:1rem;}
.ia-input-row .ia-fg{flex:1;min-width:160px;margin-bottom:0;}
.ia-btn-add{padding:.85rem 1.4rem;background:#00e5a0;color:#0a0e1a;border:none;border-radius:10px;
  font-family:'Syne',sans-serif;font-size:.88rem;font-weight:800;cursor:pointer;white-space:nowrap;transition:opacity .2s;}
.ia-btn-add:hover{opacity:.85;}
.ia-btn-sec{padding:.85rem 1.4rem;background:transparent;color:#0077ff;border:1px solid #0077ff;border-radius:10px;
  font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .2s;}
.ia-btn-sec:hover{background:rgba(0,119,255,.1);}
.ia-search-filter{margin-bottom:.8rem;}
.ia-search-filter input{width:100%;padding:.6rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;font-family:'DM Mono',monospace;font-size:.85rem;outline:none;}
.ia-list-grid{display:flex;flex-direction:column;gap:.4rem;max-height:320px;overflow-y:auto;}
.ia-list-item{display:flex;align-items:center;gap:.8rem;padding:.65rem 1rem;background:rgba(255,255,255,.03);
  border:1px solid #1f2d44;border-radius:8px;flex-wrap:wrap;}
.ia-item-name{flex:1;font-size:.85rem;font-family:'DM Mono',monospace;min-width:0;word-break:break-word;color:#e8ecf4;}
.ia-item-actions{display:flex;gap:.4rem;flex-shrink:0;}
.ia-tag{padding:.2rem .6rem;border-radius:12px;font-size:.72rem;font-weight:600;font-family:'Syne',sans-serif;}
.ia-tag.sup{background:rgba(0,229,160,.12);color:#00e5a0;border:1px solid rgba(0,229,160,.2);}
.ia-tag.none{background:rgba(107,122,153,.12);color:#6b7a99;border:1px solid #1f2d44;}
.ia-areas-grid{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.8rem;}
.ia-area-chip{display:inline-flex;align-items:center;gap:.4rem;padding:.3rem .8rem;border-radius:20px;
  background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);font-size:.8rem;font-family:'DM Mono',monospace;color:#00e5a0;}
.ia-area-chip .rm{background:none;border:none;color:#ff4d6d;cursor:pointer;font-size:.9rem;line-height:1;padding:0 0 0 4px;}
.ia-import-result{padding:.8rem 1rem;border-radius:8px;font-size:.85rem;font-weight:600;display:none;margin-top:.8rem;}
.ia-import-result.ok{background:rgba(0,229,160,.1);border:1px solid rgba(0,229,160,.3);color:#00e5a0;}
.ia-import-result.err{background:rgba(255,77,109,.1);border:1px solid rgba(255,77,109,.3);color:#ff4d6d;}
.ia-divider{border:none;border-top:1px solid #1f2d44;margin:1.2rem 0;}

/* Modal */
.ia-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);
  z-index:1000;display:none;align-items:center;justify-content:center;padding:1rem;}
.ia-modal-overlay.open{display:flex;}
.ia-modal{background:#111827;border:1px solid #1f2d44;border-radius:16px;padding:2rem;
  width:100%;max-width:480px;box-shadow:0 40px 80px rgba(0,0,0,.7);animation:iaSlideUp .3s cubic-bezier(.22,1,.36,1);}
.ia-modal h4{font-size:1rem;font-weight:800;margin-bottom:1.5rem;color:#ffa63d;}
.ia-modal-actions{display:flex;gap:1rem;margin-top:1.5rem;flex-wrap:wrap;}
.ia-btn-save{flex:1;padding:.85rem;background:#ffa63d;color:#0a0e1a;border:none;border-radius:10px;
  font-family:'Syne',sans-serif;font-size:.95rem;font-weight:800;cursor:pointer;transition:opacity .2s;}
.ia-btn-save:hover{opacity:.9;}
.ia-btn-cancel{flex:1;padding:.85rem;background:transparent;border:1px solid #1f2d44;color:#6b7a99;
  border-radius:10px;font-family:'Syne',sans-serif;font-size:.95rem;font-weight:600;cursor:pointer;transition:all .2s;}
.ia-btn-cancel:hover{border-color:#ff4d6d;color:#ff4d6d;}
.ia-btn-del{padding:.85rem 1.2rem;background:transparent;border:1px solid #ff4d6d;color:#ff4d6d;
  border-radius:10px;font-family:'Syne',sans-serif;font-size:.95rem;font-weight:600;cursor:pointer;transition:all .2s;}
.ia-btn-del:hover{background:rgba(255,77,109,.15);}
</style>

<!-- Login del Control de Asistencia -->
<div id="ia-login">
  <div class="ia-login-card">
    <div class="ia-login-logo">
      <div class="ia-icon">üè¢</div>
      <h2>Control de <span>Asistencia</span></h2>
      <p>Sistema de registro de ingresos</p>
    </div>
    <div class="ia-fg">
      <label>Usuario</label>
      <select id="ia-login-user"></select>
    </div>
    <div class="ia-fg">
      <label>Contrase√±a</label>
      <input type="password" id="ia-login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="ia-btn-primary" onclick="iaDoLogin()">Ingresar al sistema</button>
    <p class="ia-err" id="ia-login-error">‚ö† Usuario o contrase√±a incorrectos</p>
  </div>
</div>

<!-- App principal del Control de Asistencia -->
<div id="ia-app">
  <div class="ia-header">
    <div class="ia-header-left">
      <h3>Control de <span>Asistencia</span></h3>
      <p id="ia-header-date">‚Äî</p>
    </div>
    <div class="ia-header-right">
      <div id="ia-admin-badge-wrap"></div>
      <div class="ia-sup-badge"><div class="ia-sup-dot"></div><span id="ia-sup-name">‚Äî</span></div>
      <button class="ia-btn-logout" onclick="iaDoLogout()">Cerrar sesi√≥n</button>
    </div>
  </div>

  <div class="ia-main">
    <div class="ia-tabs">
      <button class="ia-tab-btn active" id="ia-tab-btn-register" onclick="iaShowTab('register',this)">‚ûï Registrar</button>
      <button class="ia-tab-btn" id="ia-tab-btn-history" onclick="iaShowTab('history',this)">üìã Historial</button>
      <button class="ia-tab-btn admin-tab hidden" id="ia-tab-btn-records" onclick="iaShowTab('records',this)">üõ† Editar Registros</button>
      <button class="ia-tab-btn admin-tab hidden" id="ia-tab-btn-config" onclick="iaShowTab('config',this)">‚öôÔ∏è Configuraci√≥n</button>
    </div>

    <div class="ia-stats-row">
      <div class="ia-stat-card"><div class="ia-slabel">Presentes hoy</div><div class="ia-value" id="ia-stat-today">0</div><div class="ia-sub" id="ia-stat-date">‚Äî</div></div>
      <div class="ia-stat-card"><div class="ia-slabel">Faltas hoy</div><div class="ia-value absent" id="ia-stat-absent">0</div><div class="ia-sub">registradas</div></div>
      <div class="ia-stat-card"><div class="ia-slabel">Pendientes</div><div class="ia-value" id="ia-stat-pending">0</div><div class="ia-sub">sin registrar</div></div>
      <div class="ia-stat-card"><div class="ia-slabel">Total registros</div><div class="ia-value" id="ia-stat-total">0</div><div class="ia-sub">todos los d√≠as</div></div>
    </div>

    <!-- REGISTRAR -->
    <div class="ia-panel" id="ia-tab-register">
      <h3>Nuevo Ingreso</h3>
      <div class="ia-reg-grid">
        <div class="ia-fg hidden" id="ia-admin-sup-filter-wrap" style="grid-column:1/-1">
          <label>Supervisor (filtrar empleados)</label>
          <select id="ia-admin-sup-filter" onchange="iaBuildAdminAreaSelect(); iaFilterEmployees()">
            <option value="">‚Äî Todos los empleados ‚Äî</option>
          </select>
        </div>
        <div class="ia-fg" style="grid-column:1/-1">
          <label>Buscar empleado</label>
          <div class="ia-search-wrapper">
            <input type="text" id="ia-emp-search" placeholder="Escribe el nombre..." autocomplete="off"
              oninput="iaFilterEmployees()" onfocus="iaOpenDropdown()" onblur="iaDelayClose()">
            <button class="ia-clear-btn" onclick="iaClearEmployee()">‚úï</button>
            <div class="ia-dropdown" id="ia-emp-dropdown"></div>
          </div>
          <input type="hidden" id="ia-emp-selected">
        </div>
        <div class="ia-fg" style="grid-column:1/-1">
          <label>√Årea</label>
          <select id="ia-emp-area"><option value="">‚Äî Seleccionar √°rea ‚Äî</option></select>
        </div>
        <div class="ia-toast ok" id="ia-success-toast">‚úÖ Ingreso registrado exitosamente</div>
        <div class="ia-toast bad" id="ia-absent-toast">‚ùå Falta registrada</div>
        <div class="ia-action-btns">
          <button class="ia-btn-register" onclick="iaRegisterEntry('presente')">‚úÖ Registrar Ingreso</button>
          <button class="ia-btn-absent"   onclick="iaRegisterEntry('falto')">‚ùå Falt√≥</button>
        </div>
      </div>
      <div class="ia-today-section">
        <h4>Registrados hoy</h4>
        <div class="ia-chips" id="ia-today-chips"><span style="color:#6b7a99;font-size:.85rem;">A√∫n no hay registros hoy</span></div>
      </div>
    </div>

    <!-- HISTORIAL -->
    <div class="ia-panel hidden" id="ia-tab-history">
      <h3>Historial de Asistencia</h3>
      <div class="ia-hist-controls">
        <div class="ia-date-row">
          <div class="ia-ctrl-grp"><label>Desde</label><input type="date" id="ia-filter-from" onchange="iaRenderHistory()"></div>
          <div class="ia-ctrl-grp"><label>Hasta</label><input type="date" id="ia-filter-to" onchange="iaRenderHistory()"></div>
          <div class="ia-sort-controls">
            <span class="ia-sort-label">Ordenar:</span>
            <button class="ia-sort-btn active" id="ia-sort-area-btn" onclick="iaSetSortHistory('area')">Por √Årea</button>
            <button class="ia-sort-btn" id="ia-sort-name-btn" onclick="iaSetSortHistory('name')">Por Nombre</button>
          </div>
          <button class="ia-btn-excel hidden" id="ia-btn-export-hist" onclick="iaExportExcel('history')">üìä Descargar Excel</button>
        </div>
      </div>
      <div class="ia-table-wrap">
        <table class="ia-table">
          <thead><tr><th>#</th><th>Empleado</th><th>√Årea</th><th>Fecha</th><th>Supervisor</th><th>Estado</th></tr></thead>
          <tbody id="ia-hist-body"></tbody>
        </table>
        <div class="ia-empty" id="ia-hist-empty">üì≠ No hay registros para este rango</div>
      </div>
    </div>

    <!-- EDITAR REGISTROS (admin) -->
    <div class="ia-panel ia-warn-panel hidden" id="ia-tab-records">
      <h3>Editar Registros</h3>
      <div class="ia-hist-controls">
        <div class="ia-date-row">
          <div class="ia-ctrl-grp"><label>Desde</label><input type="date" id="ia-admin-from" onchange="iaRenderAdminTable()"></div>
          <div class="ia-ctrl-grp"><label>Hasta</label><input type="date" id="ia-admin-to" onchange="iaRenderAdminTable()"></div>
          <div class="ia-ctrl-grp">
            <label>Supervisor</label>
            <select id="ia-admin-filter-sup" onchange="iaRenderAdminTable()"><option value="">‚Äî Todos ‚Äî</option></select>
          </div>
          <div class="ia-sort-controls">
            <span class="ia-sort-label">Ordenar:</span>
            <button class="ia-sort-btn active" id="ia-sort-adm-area-btn" onclick="iaSetSortAdmin('area')">Por √Årea</button>
            <button class="ia-sort-btn" id="ia-sort-adm-name-btn" onclick="iaSetSortAdmin('name')">Por Nombre</button>
          </div>
          <button class="ia-btn-excel" onclick="iaExportExcel('admin')">üìä Descargar Excel</button>
        </div>
        <div style="margin-top:.8rem;">
          <input type="text" id="ia-admin-search-emp" placeholder="üîç Buscar por nombre..." oninput="iaRenderAdminTable()"
            style="max-width:400px;padding:.6rem 1rem;font-size:.85rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;font-family:'DM Mono',monospace;outline:none;">
        </div>
      </div>
      <div class="ia-table-wrap">
        <table class="ia-table">
          <thead><tr><th>#</th><th>Empleado</th><th>√Årea</th><th>Fecha</th><th>Supervisor</th><th>Estado</th><th>Editar</th></tr></thead>
          <tbody id="ia-admin-body"></tbody>
        </table>
        <div class="ia-empty" id="ia-admin-empty">üì≠ No hay registros</div>
      </div>
    </div>

    <!-- CONFIG (admin) -->
    <div class="ia-panel ia-warn-panel hidden" id="ia-tab-config">
      <h3>‚öôÔ∏è Configuraci√≥n del Sistema</h3>
      <div class="ia-admin-sections">
        <div class="ia-admin-section">
          <h4>üë§ Supervisores</h4>
          <div class="ia-input-row">
            <div class="ia-fg"><label>Nombre</label><input type="text" id="ia-new-sup-name" placeholder="Nombre del supervisor"></div>
            <div class="ia-fg"><label>Contrase√±a</label><input type="password" id="ia-new-sup-pass" placeholder="Contrase√±a"></div>
            <button class="ia-btn-add" onclick="iaAddSupervisor()">+ Agregar</button>
          </div>
          <div class="ia-list-grid" id="ia-supervisors-list"></div>
        </div>
        <div class="ia-admin-section">
          <h4>üë• Empleados</h4>
          <div class="ia-input-row">
            <div class="ia-fg" style="flex:2"><label>Nombre completo</label><input type="text" id="ia-new-emp-name" placeholder="Nombre del empleado"></div>
            <div class="ia-fg"><label>Supervisor</label><select id="ia-new-emp-sup"><option value="">‚Äî Sin asignar ‚Äî</option></select></div>
            <button class="ia-btn-add" onclick="iaAddEmployee()">+ Agregar</button>
          </div>
          <hr class="ia-divider">
          <div class="ia-input-row" style="margin-bottom:.5rem;">
            <button class="ia-btn-sec" onclick="iaDownloadTemplate()">‚¨á Plantilla Excel</button>
            <label class="ia-btn-add" style="cursor:pointer;display:flex;align-items:center;">
              üìÇ Importar Excel
              <input type="file" id="ia-import-file" accept=".xlsx,.xls" onchange="iaImportEmployees(this)" style="display:none;">
            </label>
          </div>
          <div class="ia-import-result" id="ia-import-result"></div>
          <hr class="ia-divider">
          <div class="ia-search-filter"><input type="text" id="ia-emp-filter" placeholder="üîç Buscar empleado..." oninput="iaRenderEmployeeList()"></div>
          <div class="ia-list-grid" id="ia-employees-list"></div>
        </div>
        <div class="ia-admin-section">
          <h4>üóÇ √Åreas por Supervisor</h4>
          <div class="ia-input-row">
            <div class="ia-fg"><label>Supervisor</label><select id="ia-area-sup-select" onchange="iaRenderAreaManager()"><option value="">‚Äî Seleccionar ‚Äî</option></select></div>
            <div class="ia-fg"><label>Nueva √°rea</label><input type="text" id="ia-new-area-name" placeholder="Ej: M28, Corte"></div>
            <button class="ia-btn-add" onclick="iaAddArea()">+ Agregar</button>
          </div>
          <div id="ia-area-manager-wrap"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modales del Control de Asistencia -->
<div class="ia-modal-overlay" id="ia-edit-modal">
  <div class="ia-modal">
    <h4>‚úèÔ∏è Editar Registro</h4>
    <div class="ia-fg"><label>Empleado</label><input type="text" id="ia-edit-emp" readonly style="opacity:.6;cursor:not-allowed;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;padding:.75rem 1rem;width:100%;"></div>
    <div class="ia-fg"><label>√Årea</label><select id="ia-edit-area" style="width:100%;padding:.75rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;outline:none;"></select></div>
    <div class="ia-fg"><label>Estado</label><select id="ia-edit-status" style="width:100%;padding:.75rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;outline:none;"><option value="presente">‚úÖ Presente</option><option value="falto">‚ùå Falt√≥</option></select></div>
    <div class="ia-fg"><label>Supervisor</label><select id="ia-edit-supervisor" style="width:100%;padding:.75rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;outline:none;"></select></div>
    <div class="ia-modal-actions">
      <button class="ia-btn-cancel" onclick="iaCloseModal('ia-edit-modal')">Cancelar</button>
      <button class="ia-btn-del" onclick="iaDeleteRecord()">üóë Eliminar</button>
      <button class="ia-btn-save" onclick="iaSaveEdit()">üíæ Guardar</button>
    </div>
  </div>
</div>
<div class="ia-modal-overlay" id="ia-sup-modal">
  <div class="ia-modal">
    <h4>‚úèÔ∏è Editar Supervisor</h4>
    <div class="ia-fg"><label>Nombre</label><input type="text" id="ia-edit-sup-name" style="width:100%;padding:.75rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;outline:none;font-family:'DM Mono',monospace;"></div>
    <div class="ia-fg"><label>Nueva contrase√±a <span style="color:#6b7a99;font-weight:400;">(vac√≠o = sin cambio)</span></label><input type="password" id="ia-edit-sup-pass" style="width:100%;padding:.75rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;outline:none;font-family:'DM Mono',monospace;"></div>
    <div class="ia-modal-actions">
      <button class="ia-btn-cancel" onclick="iaCloseModal('ia-sup-modal')">Cancelar</button>
      <button class="ia-btn-del" onclick="iaDeleteSupervisor()">üóë Eliminar</button>
      <button class="ia-btn-save" onclick="iaSaveSupervisor()">üíæ Guardar</button>
    </div>
  </div>
</div>
<div class="ia-modal-overlay" id="ia-emp-modal">
  <div class="ia-modal">
    <h4>‚úèÔ∏è Editar Empleado</h4>
    <div class="ia-fg"><label>Nombre completo</label><input type="text" id="ia-edit-emp-name" style="width:100%;padding:.75rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;outline:none;font-family:'DM Mono',monospace;"></div>
    <div class="ia-fg"><label>Supervisor</label><select id="ia-edit-emp-sup" style="width:100%;padding:.75rem 1rem;background:#1a2235;border:1px solid #1f2d44;border-radius:8px;color:#e8ecf4;outline:none;"><option value="">‚Äî Sin asignar ‚Äî</option></select></div>
    <div class="ia-modal-actions">
      <button class="ia-btn-cancel" onclick="iaCloseModal('ia-emp-modal')">Cancelar</button>
      <button class="ia-btn-del" onclick="iaDeleteEmployee()">üóë Eliminar</button>
      <button class="ia-btn-save" onclick="iaSaveEmployee()">üíæ Guardar</button>
    </div>
  </div>
</div>
  `;
}

// ‚îÄ‚îÄ L√ìGICA JavaScript del Control de Asistencia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runIngresoScript(){

const IA_INITIAL = {
  supervisors:[
    {id:'maria_pineda',  name:'Mar√≠a Pineda',  pass:'1234',isAdmin:false,areas:['M01','M02','M03','M04','M05','M06','M07','M08','M09']},
    {id:'yurany_zapata', name:'Yurany Zapata', pass:'1234',isAdmin:false,areas:['M10','M15','M16','M17','M18','M19','M20','M21']},
    {id:'mery_tabares',  name:'Mery Tabares',  pass:'1234',isAdmin:false,areas:['M22','M23','M24','M25','M26','M27']},
    {id:'leidy_galeano', name:'Leidy Galeano', pass:'1234',isAdmin:false,areas:['M01','M02','M03','M04','M05','M06','M07','M08','M09','M10','M11','M12','M13','M14','M15','M16','M17','M18','M19','M20','M21','M22','M23','M24','M25','M26','M27']},
    {id:'beiro',         name:'Beiro',          pass:'B1234',isAdmin:true, areas:[]}
  ],
  employees:[
    {id:'e1',name:'ADRIANA MARIA RODRIGUEZ CORREA',supId:'maria_pineda'},{id:'e2',name:'ALBA LUCIA POSSO GIRALDO',supId:'maria_pineda'},{id:'e3',name:'ALEXANDRA MARIA RENDON GRISALES',supId:'maria_pineda'},{id:'e4',name:'AMANDA MEJIA GARCIA',supId:'maria_pineda'},{id:'e5',name:'ANA CATALINA MESA BETANCUR',supId:'maria_pineda'},{id:'e6',name:'ANA RAQUEL MARTINEZ PATI√ëO',supId:'maria_pineda'},{id:'e7',name:'ANGELA MARIA GIRALDO ROJAS',supId:'maria_pineda'},{id:'e8',name:'ASTRID YURANY RAMIREZ ARCILA',supId:'maria_pineda'},{id:'e9',name:'BRILLIN ESTEFANI BOLA√ëOS SEPULVEDA',supId:'maria_pineda'},{id:'e10',name:'CELENY PATRICIA TUBERQUIA PINO',supId:'maria_pineda'},{id:'e11',name:'DANEXY LISBETH PALENCIA ROMERO',supId:'maria_pineda'},{id:'e12',name:'DEISY ALEJANDRA VILLA YEPES',supId:'maria_pineda'},{id:'e13',name:'DEISY JULIANA RUIZ CESPEDES',supId:'maria_pineda'},{id:'e14',name:'DIANA CRISTINA GIRALDO MORA',supId:'maria_pineda'},{id:'e15',name:'DIANA MILENA MAZO GUERRA',supId:'maria_pineda'},{id:'e16',name:'DIDIER HERNAN CEBALLOS CIFUENTES',supId:'maria_pineda'},{id:'e17',name:'EDILMARY AREIZA AREIZA',supId:'maria_pineda'},{id:'e18',name:'EDISSON ALONSO ARISTIZABAL SALAZAR',supId:'maria_pineda'},{id:'e19',name:'ELIANA MAR√çA JARAMILLO L√ìPEZ',supId:'maria_pineda'},{id:'e20',name:'ESTEFANIA ZAPATA SIERRA',supId:'maria_pineda'},
    {id:'e83',name:'ALDERIS DEL SOCORRO GARCIA GODOY',supId:'yurany_zapata'},{id:'e84',name:'ALICIA RODRIGUEZ RIOS',supId:'yurany_zapata'},{id:'e85',name:'ANDRES FELIPE LOPEZ CORREA',supId:'yurany_zapata'},{id:'e86',name:'ASTRID FERNANDA ESCOBAR CHAGUENDO',supId:'yurany_zapata'},{id:'e87',name:'BEATRIZ ELENA LEZCANO HERNANDEZ',supId:'yurany_zapata'},{id:'e88',name:'BLANCA OLIVA OQUENDO GIRALDO',supId:'yurany_zapata'},{id:'e89',name:'CRISTIAN CAMILO ORREGO BOHORQUEZ',supId:'yurany_zapata'},
    {id:'e146',name:'ADRIANA JANNET ARENAS OSORNO',supId:'mery_tabares'},{id:'e147',name:'ALEJANDRO CARO VELASQUEZ',supId:'mery_tabares'},{id:'e148',name:'ANA CECILIA CORREA ORTIZ',supId:'mery_tabares'},{id:'e149',name:'ANA JOSEFINA ESPINEL GOMEZ',supId:'mery_tabares'},
    {id:'e197',name:'ANGELA MARIA VANEGAS MARIN',supId:'leidy_galeano'},{id:'e198',name:'HELLEN VANESSA GUERRA MUNERA',supId:'leidy_galeano'},{id:'e199',name:'DIANA CAROLINA CORREA CARDONA',supId:'leidy_galeano'}
  ]
};

// Variables de asistencia ‚Äî declaradas globalmente (el WS las llena antes de runIngresoScript)
// (declaradas arriba en el scope global, ver justo antes de connectWS)
let iaCurrentUser=null, iaEditingRecordId=null, iaEditingSupId=null, iaEditingEmpId=null;
let iaSortHistory='area', iaSortAdmin='area';
let iaSelectedEmployee='';

function iaTodayStr(){return new Date().toISOString().split('T')[0];}
function iaFormatDateLong(s){return new Date(s+'T12:00:00').toLocaleDateString('es-CO',{weekday:'long',year:'numeric',month:'long',day:'numeric'});}
function iaGenId(){return 'id_'+Date.now()+'_'+Math.random().toString(36).slice(2,7);}
function iaGetSup(id){return iaState.supervisors.find(s=>s.id===id);}
function iaNonAdminSups(){return iaState.supervisors.filter(s=>!s.isAdmin);}
function iaIsAdmin(){return iaGetSup(iaCurrentUser)?.isAdmin;}
function iaAreaOrder(a){if(a==='‚Äî')return 9999;const m=a.match(/M(\d+)/);return m?parseInt(m[1]):9998;}
function iaSortData(data,mode){
  if(mode==='area')return[...data].sort((a,b)=>{const ao=iaAreaOrder(a.area),bo=iaAreaOrder(b.area);return ao!==bo?ao-bo:a.empName.localeCompare(b.empName);});
  return[...data].sort((a,b)=>a.empName.localeCompare(b.empName));
}
function iaFilterByRange(data,fromId,toId){
  const from=document.getElementById(fromId)?.value,to=document.getElementById(toId)?.value;
  if(from)data=data.filter(r=>r.date>=from);
  if(to)data=data.filter(r=>r.date<=to);
  return data;
}
window.iaBuildLoginSelect=function(){
  const sel=document.getElementById('ia-login-user');if(!sel)return;
  sel.innerHTML='<option value="">‚Äî Seleccionar usuario ‚Äî</option>';
  iaState.supervisors.forEach(s=>{const o=document.createElement('option');o.value=s.id;o.textContent=s.isAdmin?`${s.name} (Administrador)`:s.name;sel.appendChild(o);});
};
window.iaDoLogin=function(){
  const uid=document.getElementById('ia-login-user').value;
  const pass=document.getElementById('ia-login-pass').value;
  const sup=iaGetSup(uid);
  if(!sup||sup.pass!==pass){document.getElementById('ia-login-error').style.display='block';return;}
  document.getElementById('ia-login-error').style.display='none';
  iaCurrentUser=uid; iaInitApp();
};
document.getElementById('ia-login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')iaDoLogin();});
window.iaDoLogout=function(){
  iaCurrentUser=null;
  document.getElementById('ia-app').style.display='none';
  document.getElementById('ia-login').style.display='flex';
  document.getElementById('ia-login-user').value='';
  document.getElementById('ia-login-pass').value='';
  iaBuildLoginSelect();
};
function iaInitApp(){
  document.getElementById('ia-login').style.display='none';
  document.getElementById('ia-app').style.display='block';
  const sup=iaGetSup(iaCurrentUser);
  document.getElementById('ia-sup-name').textContent=sup.name;
  document.getElementById('ia-header-date').textContent=iaFormatDateLong(iaTodayStr());
  document.getElementById('ia-stat-date').textContent=iaTodayStr();
  const t=iaTodayStr();
  document.getElementById('ia-filter-from').value=t;
  document.getElementById('ia-filter-to').value=t;
  const adminTabs=document.querySelectorAll('#ingreso-app-root .admin-tab');
  if(sup.isAdmin){
    document.getElementById('ia-admin-badge-wrap').innerHTML='<span class="ia-badge-admin">‚öôÔ∏è ADMINISTRADOR</span>';
    adminTabs.forEach(b=>b.classList.remove('hidden'));
    document.getElementById('ia-admin-from').value=t;
    document.getElementById('ia-admin-to').value=t;
    document.getElementById('ia-btn-export-hist').classList.remove('hidden');
    iaRebuildAdminFilterSup();
    document.getElementById('ia-admin-sup-filter-wrap').classList.remove('hidden');
    iaBuildAdminSupFilter();
  } else {
    document.getElementById('ia-admin-badge-wrap').innerHTML='';
    adminTabs.forEach(b=>b.classList.add('hidden'));
    document.getElementById('ia-btn-export-hist').classList.add('hidden');
    document.getElementById('ia-admin-sup-filter-wrap').classList.add('hidden');
  }
  iaBuildAreaSelect();
  iaShowTab('register',document.getElementById('ia-tab-btn-register'));
  iaUpdateStats(); iaRenderTodayChips();
}
function iaBuildAdminSupFilter(){
  const sel=document.getElementById('ia-admin-sup-filter');
  sel.innerHTML='<option value="">‚Äî Todos los empleados ‚Äî</option>';
  iaNonAdminSups().forEach(s=>{const o=document.createElement('option');o.value=s.id;o.textContent=s.name;sel.appendChild(o);});
}
window.iaBuildAdminAreaSelect=function(){iaBuildAreaSelect();};
function iaBuildAreaSelect(){
  const asel=document.getElementById('ia-emp-area');
  asel.innerHTML='<option value="">‚Äî Seleccionar √°rea ‚Äî</option>';
  if(iaIsAdmin()){
    const filtSupId=document.getElementById('ia-admin-sup-filter')?.value;
    let areas=filtSupId?(iaGetSup(filtSupId)?.areas||[]):[...new Set(iaNonAdminSups().flatMap(s=>s.areas||[]))].sort((a,b)=>iaAreaOrder(a)-iaAreaOrder(b));
    areas.forEach(a=>{const o=document.createElement('option');o.value=a;o.textContent=a;asel.appendChild(o);});
  } else {
    (iaGetSup(iaCurrentUser)?.areas||[]).forEach(a=>{const o=document.createElement('option');o.value=a;o.textContent=a;asel.appendChild(o);});
  }
}
function iaRebuildAdminFilterSup(){
  const sel=document.getElementById('ia-admin-filter-sup');const cur=sel.value;
  sel.innerHTML='<option value="">‚Äî Todos ‚Äî</option>';
  iaNonAdminSups().forEach(s=>{const o=document.createElement('option');o.value=s.name;o.textContent=s.name;sel.appendChild(o);});
  if(cur)sel.value=cur;
}
function iaGetAvailableEmployees(){
  const today=iaTodayStr();
  if(iaIsAdmin()){
    const filtSupId=document.getElementById('ia-admin-sup-filter')?.value;
    let pool=filtSupId?iaState.employees.filter(e=>e.supId===filtSupId):iaState.employees;
    const reg=new Set(iaRecords.filter(r=>r.date===today).map(r=>r.empName));
    return pool.filter(e=>!reg.has(e.name)).map(e=>e.name).sort();
  } else {
    const sup=iaGetSup(iaCurrentUser);
    const reg=new Set(iaRecords.filter(r=>r.date===today&&r.supervisor===sup.name).map(r=>r.empName));
    return iaState.employees.filter(e=>e.supId===iaCurrentUser&&!reg.has(e.name)).map(e=>e.name).sort();
  }
}
window.iaFilterEmployees=function(){
  iaSelectedEmployee='';document.getElementById('ia-emp-selected').value='';
  const q=document.getElementById('ia-emp-search').value.trim().toLowerCase();
  const list=iaGetAvailableEmployees();
  iaBuildDropdown(q?list.filter(e=>e.toLowerCase().includes(q)).slice(0,80):list.slice(0,80),q);
  document.getElementById('ia-emp-dropdown').classList.add('open');
};
window.iaOpenDropdown=function(){
  const q=document.getElementById('ia-emp-search').value.trim().toLowerCase();
  const list=iaGetAvailableEmployees();
  iaBuildDropdown(q?list.filter(e=>e.toLowerCase().includes(q)).slice(0,80):list.slice(0,80),q);
  document.getElementById('ia-emp-dropdown').classList.add('open');
};
function iaBuildDropdown(items,q){
  const dd=document.getElementById('ia-emp-dropdown');
  if(!items.length){dd.innerHTML='<div class="ia-dd-item" style="color:#6b7a99">Sin empleados pendientes</div>';return;}
  dd.innerHTML=items.map(name=>{
    const safe=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const hi=q?name.replace(new RegExp('('+safe+')','gi'),'<mark>$1</mark>'):name;
    return`<div class="ia-dd-item" onmousedown="iaSelectEmployee('${name.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}')">${hi}</div>`;
  }).join('');
}
window.iaDelayClose=function(){setTimeout(()=>document.getElementById('ia-emp-dropdown').classList.remove('open'),200);};
window.iaSelectEmployee=function(name){
  iaSelectedEmployee=name;
  document.getElementById('ia-emp-search').value=name;
  document.getElementById('ia-emp-selected').value=name;
  document.getElementById('ia-emp-dropdown').classList.remove('open');
};
window.iaClearEmployee=function(){
  iaSelectedEmployee='';
  document.getElementById('ia-emp-search').value='';
  document.getElementById('ia-emp-selected').value='';
  document.getElementById('ia-emp-search').focus();
};
window.iaRegisterEntry=function(status){
  const empName=document.getElementById('ia-emp-selected').value||document.getElementById('ia-emp-search').value.trim();
  const area=document.getElementById('ia-emp-area').value;
  if(!empName){alert('Por favor selecciona un empleado.');return;}
  if(status==='presente'&&!area){alert('Por favor selecciona un √°rea.');return;}
  let supName;
  if(iaIsAdmin()){
    const filtSupId=document.getElementById('ia-admin-sup-filter')?.value;
    if(filtSupId){supName=iaGetSup(filtSupId)?.name||'Admin';}
    else{const emp=iaState.employees.find(e=>e.name===empName);supName=emp&&emp.supId?iaGetSup(emp.supId)?.name:'Admin';}
  } else {supName=iaGetSup(iaCurrentUser).name;}
  const today=iaTodayStr();
  const newRecord={id:iaGenId(),empName,area:status==='falto'?'‚Äî':area,status,date:today,supervisor:supName};
  // Actualizar localmente
  iaRecords=iaRecords.filter(r=>!(r.empName===empName&&r.date===today&&r.supervisor===supName));
  iaRecords.push(newRecord);
  // Enviar al servidor para todos los dispositivos
  wsSend({type:'ia_add_record', record:newRecord});
  iaClearEmployee(); document.getElementById('ia-emp-area').value='';
  const toastId=status==='presente'?'ia-success-toast':'ia-absent-toast';
  const t=document.getElementById(toastId);t.style.display='block';setTimeout(()=>t.style.display='none',3000);
  iaUpdateStats(); iaRenderTodayChips();
};
function iaUpdateStats(){
  const today=iaTodayStr(),sup=iaGetSup(iaCurrentUser);
  if(iaIsAdmin()){
    const tr=iaRecords.filter(r=>r.date===today);
    document.getElementById('ia-stat-today').textContent=tr.filter(r=>r.status==='presente').length;
    document.getElementById('ia-stat-absent').textContent=tr.filter(r=>r.status==='falto').length;
    document.getElementById('ia-stat-total').textContent=iaRecords.length;
    document.getElementById('ia-stat-pending').textContent=Math.max(0,iaState.employees.length-[...new Set(tr.map(r=>r.empName))].length);
  } else {
    const tr=iaRecords.filter(r=>r.date===today&&r.supervisor===sup.name);
    document.getElementById('ia-stat-today').textContent=tr.filter(r=>r.status==='presente').length;
    document.getElementById('ia-stat-absent').textContent=tr.filter(r=>r.status==='falto').length;
    document.getElementById('ia-stat-total').textContent=iaRecords.filter(r=>r.supervisor===sup.name).length;
    const empCount=iaState.employees.filter(e=>e.supId===iaCurrentUser).length;
    document.getElementById('ia-stat-pending').textContent=Math.max(0,empCount-[...new Set(tr.map(r=>r.empName))].length);
  }
}
function iaRenderTodayChips(){
  const today=iaTodayStr(),sup=iaGetSup(iaCurrentUser);
  let recs=iaIsAdmin()?iaSortData(iaRecords.filter(r=>r.date===today),'area'):iaSortData(iaRecords.filter(r=>r.date===today&&r.supervisor===sup.name),'area');
  const c=document.getElementById('ia-today-chips');
  if(!recs.length){c.innerHTML='<span style="color:#6b7a99;font-size:.85rem;">A√∫n no hay registros hoy</span>';return;}
  c.innerHTML=recs.map(r=>r.status==='falto'
    ?`<span class="ia-chip absent">‚ùå ${r.empName}</span>`
    :`<span class="ia-chip">‚úì ${r.empName} <span class="ia-area-tag">${r.area}</span></span>`).join('');
}
window.iaShowTab=function(name,btn){
  document.querySelectorAll('#ingreso-app-root .ia-tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ['ia-tab-register','ia-tab-history','ia-tab-records','ia-tab-config'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('ia-tab-'+name).classList.remove('hidden');
  if(name==='history') iaRenderHistory();
  if(name==='records') iaRenderAdminTable();
  if(name==='config')  iaRenderConfig();
};
window.iaSetSortHistory=function(mode){
  iaSortHistory=mode;
  document.getElementById('ia-sort-area-btn').classList.toggle('active',mode==='area');
  document.getElementById('ia-sort-name-btn').classList.toggle('active',mode==='name');
  iaRenderHistory();
};
window.iaSetSortAdmin=function(mode){
  iaSortAdmin=mode;
  document.getElementById('ia-sort-adm-area-btn').classList.toggle('active',mode==='area');
  document.getElementById('ia-sort-adm-name-btn').classList.toggle('active',mode==='name');
  iaRenderAdminTable();
};
function iaRenderHistory(){
  const sup=iaGetSup(iaCurrentUser);
  let data=iaIsAdmin()?iaFilterByRange([...iaRecords],'ia-filter-from','ia-filter-to'):iaFilterByRange(iaRecords.filter(r=>r.supervisor===sup.name),'ia-filter-from','ia-filter-to');
  data=iaSortData(data,iaSortHistory);
  const tbody=document.getElementById('ia-hist-body'),empty=document.getElementById('ia-hist-empty');
  if(!data.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=data.map((r,i)=>`<tr>
    <td>${i+1}</td><td>${r.empName}</td>
    <td>${r.status==='falto'?'<span style="color:#ff4d6d">‚Äî</span>':`<span class="ia-badge area">${r.area}</span>`}</td>
    <td>${r.date}</td><td>${r.supervisor}</td>
    <td>${r.status==='falto'?'<span class="ia-badge out">‚ùå Falt√≥</span>':'<span class="ia-badge in">‚úÖ Presente</span>'}</td>
  </tr>`).join('');
}
function iaRenderAdminTable(){
  let data=iaFilterByRange([...iaRecords],'ia-admin-from','ia-admin-to');
  const fs=document.getElementById('ia-admin-filter-sup')?.value;if(fs)data=data.filter(r=>r.supervisor===fs);
  const q=(document.getElementById('ia-admin-search-emp')?.value||'').toLowerCase().trim();if(q)data=data.filter(r=>r.empName.toLowerCase().includes(q));
  data=iaSortData(data,iaSortAdmin);
  const tbody=document.getElementById('ia-admin-body'),empty=document.getElementById('ia-admin-empty');
  if(!data.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=data.map((r,i)=>`<tr>
    <td>${i+1}</td><td>${r.empName}</td>
    <td>${r.status==='falto'?'<span style="color:#ff4d6d">‚Äî</span>':`<span class="ia-badge area">${r.area}</span>`}</td>
    <td>${r.date}</td><td>${r.supervisor}</td>
    <td>${r.status==='falto'?'<span class="ia-badge out">‚ùå Falt√≥</span>':'<span class="ia-badge in">‚úÖ Presente</span>'}</td>
    <td><button class="ia-btn-edit" onclick="iaOpenEditRecord('${r.id}')">‚úèÔ∏è Editar</button></td>
  </tr>`).join('');
}
window.iaExportExcel=function(panel){
  let data,fromId,toId;
  if(panel==='history'){
    fromId='ia-filter-from';toId='ia-filter-to';
    data=iaIsAdmin()?iaFilterByRange([...iaRecords],fromId,toId):iaFilterByRange(iaRecords.filter(r=>r.supervisor===iaGetSup(iaCurrentUser).name),fromId,toId);
    data=iaSortData(data,iaSortHistory);
  } else {
    fromId='ia-admin-from';toId='ia-admin-to';
    data=iaFilterByRange([...iaRecords],fromId,toId);
    const fs=document.getElementById('ia-admin-filter-sup')?.value;if(fs)data=data.filter(r=>r.supervisor===fs);
    data=iaSortData(data,iaSortAdmin);
  }
  if(!data.length){alert('No hay registros para exportar.');return;}
  const from=document.getElementById(fromId).value||'todos',to=document.getElementById(toId).value||'todos';
  const wsData=[['#','Empleado','√Årea','Fecha','Supervisor','Estado'],...data.map((r,i)=>[i+1,r.empName,r.area,r.date,r.supervisor,r.status==='falto'?'Falt√≥':'Presente'])];
  const wb=XLSX.utils.book_new(),ws=XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols']=[{wch:5},{wch:40},{wch:8},{wch:12},{wch:20},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws,'Asistencia');
  XLSX.writeFile(wb,`Asistencia_${from}_${to}.xlsx`);
};
window.iaOpenEditRecord=function(id){
  const r=iaRecords.find(x=>x.id===id);if(!r)return;
  iaEditingRecordId=id;
  document.getElementById('ia-edit-emp').value=r.empName;
  document.getElementById('ia-edit-status').value=r.status;
  const allAreas=[...new Set(iaNonAdminSups().flatMap(s=>s.areas||[]))].sort((a,b)=>iaAreaOrder(a)-iaAreaOrder(b));
  const asel=document.getElementById('ia-edit-area');
  asel.innerHTML='<option value="">‚Äî Sin √°rea ‚Äî</option>';
  allAreas.forEach(a=>{const o=document.createElement('option');o.value=a;o.textContent=a;if(a===r.area)o.selected=true;asel.appendChild(o);});
  const ssel=document.getElementById('ia-edit-supervisor');ssel.innerHTML='';
  iaNonAdminSups().forEach(s=>{const o=document.createElement('option');o.value=s.name;o.textContent=s.name;if(s.name===r.supervisor)o.selected=true;ssel.appendChild(o);});
  iaOpenModal('ia-edit-modal');
};
window.iaSaveEdit=function(){
  const r=iaRecords.find(x=>x.id===iaEditingRecordId);if(!r)return;
  r.status=document.getElementById('ia-edit-status').value;
  r.area=r.status==='falto'?'‚Äî':(document.getElementById('ia-edit-area').value||'‚Äî');
  r.supervisor=document.getElementById('ia-edit-supervisor').value;
  wsSend({type:'ia_edit_record', record:{...r}});
  iaCloseModal('ia-edit-modal');iaRenderAdminTable();
};
window.iaDeleteRecord=function(){
  if(!confirm('¬øEliminar este registro?'))return;
  iaRecords=iaRecords.filter(x=>x.id!==iaEditingRecordId);
  wsSend({type:'ia_delete_record', id:iaEditingRecordId});
  iaCloseModal('ia-edit-modal');iaRenderAdminTable();
};
window.iaOpenModal=function(id){document.getElementById(id).classList.add('open');};
window.iaCloseModal=function(id){document.getElementById(id).classList.remove('open');};
document.querySelectorAll('.ia-modal-overlay').forEach(m=>m.addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');}));

// CONFIG
function iaRenderConfig(){iaRenderSupervisorList();iaBuildSupSelects();iaRenderEmployeeList();iaBuildAreaSupSelect();iaRenderAreaManager();}
function iaRenderSupervisorList(){
  const c=document.getElementById('ia-supervisors-list');const sups=iaNonAdminSups();
  if(!sups.length){c.innerHTML='<div style="color:#6b7a99;padding:1rem;text-align:center;font-size:.85rem;">No hay supervisores</div>';return;}
  c.innerHTML=sups.map(s=>`<div class="ia-list-item"><span class="ia-item-name">üë§ ${s.name}</span><span class="ia-tag sup">${(s.areas||[]).length} √°reas ¬∑ ${iaState.employees.filter(e=>e.supId===s.id).length} emp.</span><div class="ia-item-actions"><button class="ia-btn-edit" onclick="iaOpenEditSup('${s.id}')">‚úèÔ∏è Editar</button></div></div>`).join('');
}
window.iaAddSupervisor=function(){
  const name=document.getElementById('ia-new-sup-name').value.trim();
  const pass=document.getElementById('ia-new-sup-pass').value.trim();
  if(!name||!pass){alert('Completa nombre y contrase√±a.');return;}
  const id='sup_'+Date.now();
  iaState.supervisors.push({id,name,pass,isAdmin:false,areas:[]});
  iaSaveState();document.getElementById('ia-new-sup-name').value='';document.getElementById('ia-new-sup-pass').value='';
  iaRenderSupervisorList();iaBuildSupSelects();iaBuildAdminSupFilter();iaRebuildAdminFilterSup();iaBuildAreaSupSelect();
};
window.iaOpenEditSup=function(id){
  const s=iaGetSup(id);if(!s)return;
  iaEditingSupId=id;document.getElementById('ia-edit-sup-name').value=s.name;document.getElementById('ia-edit-sup-pass').value='';
  iaOpenModal('ia-sup-modal');
};
window.iaSaveSupervisor=function(){
  const s=iaGetSup(iaEditingSupId);if(!s)return;
  const name=document.getElementById('ia-edit-sup-name').value.trim();const pass=document.getElementById('ia-edit-sup-pass').value.trim();
  if(!name)return;const oldName=s.name;s.name=name;if(pass)s.pass=pass;
  iaRecords.forEach(r=>{if(r.supervisor===oldName)r.supervisor=name;});
  iaSaveState();iaSaveRecords();iaCloseModal('ia-sup-modal');
  iaRenderSupervisorList();iaBuildSupSelects();iaBuildAdminSupFilter();iaRebuildAdminFilterSup();iaBuildAreaSupSelect();
};
window.iaDeleteSupervisor=function(){
  if(!confirm(`¬øEliminar supervisor "${iaGetSup(iaEditingSupId)?.name}"?`))return;
  iaState.employees.forEach(e=>{if(e.supId===iaEditingSupId)e.supId='';});
  iaState.supervisors=iaState.supervisors.filter(s=>s.id!==iaEditingSupId);
  iaSaveState();iaCloseModal('ia-sup-modal');
  iaRenderSupervisorList();iaRenderEmployeeList();iaBuildSupSelects();iaBuildAdminSupFilter();iaRebuildAdminFilterSup();iaBuildAreaSupSelect();
};
function iaBuildSupSelects(){
  const sups=iaNonAdminSups();
  ['ia-new-emp-sup','ia-edit-emp-sup'].forEach(selId=>{
    const sel=document.getElementById(selId);if(!sel)return;const cur=sel.value;
    sel.innerHTML='<option value="">‚Äî Sin asignar ‚Äî</option>';
    sups.forEach(s=>{const o=document.createElement('option');o.value=s.id;o.textContent=s.name;sel.appendChild(o);});
    if(cur)sel.value=cur;
  });
}
function iaRenderEmployeeList(){
  const q=(document.getElementById('ia-emp-filter')?.value||'').toLowerCase();
  const c=document.getElementById('ia-employees-list');
  let emps=[...iaState.employees];if(q)emps=emps.filter(e=>e.name.toLowerCase().includes(q));
  emps.sort((a,b)=>a.name.localeCompare(b.name));
  if(!emps.length){c.innerHTML='<div style="color:#6b7a99;padding:1rem;text-align:center;font-size:.85rem;">No hay empleados</div>';return;}
  c.innerHTML=emps.map(e=>{const sup=iaGetSup(e.supId);return`<div class="ia-list-item"><span class="ia-item-name">${e.name}</span><span class="ia-tag ${sup?'sup':'none'}">${sup?sup.name:'Sin asignar'}</span><div class="ia-item-actions"><button class="ia-btn-edit" onclick="iaOpenEditEmp('${e.id}')">‚úèÔ∏è</button></div></div>`;}).join('');
}
window.iaAddEmployee=function(){
  const name=document.getElementById('ia-new-emp-name').value.trim().toUpperCase();const supId=document.getElementById('ia-new-emp-sup').value;
  if(!name){alert('Ingresa el nombre.');return;}
  if(iaState.employees.find(e=>e.name===name)){alert('Ya existe.');return;}
  iaState.employees.push({id:iaGenId(),name,supId});iaSaveState();document.getElementById('ia-new-emp-name').value='';iaRenderEmployeeList();
};
window.iaOpenEditEmp=function(id){
  const e=iaState.employees.find(x=>x.id===id);if(!e)return;
  iaEditingEmpId=id;document.getElementById('ia-edit-emp-name').value=e.name;iaBuildSupSelects();document.getElementById('ia-edit-emp-sup').value=e.supId||'';iaOpenModal('ia-emp-modal');
};
window.iaSaveEmployee=function(){
  const e=iaState.employees.find(x=>x.id===iaEditingEmpId);if(!e)return;
  const name=document.getElementById('ia-edit-emp-name').value.trim().toUpperCase();if(!name)return;
  e.name=name;e.supId=document.getElementById('ia-edit-emp-sup').value;iaSaveState();iaCloseModal('ia-emp-modal');iaRenderEmployeeList();
};
window.iaDeleteEmployee=function(){
  if(!confirm(`¬øEliminar "${iaState.employees.find(x=>x.id===iaEditingEmpId)?.name}"?`))return;
  iaState.employees=iaState.employees.filter(x=>x.id!==iaEditingEmpId);iaSaveState();iaCloseModal('ia-emp-modal');iaRenderEmployeeList();
};
window.iaDownloadTemplate=function(){
  const wsData=[['Empleado','Supervisor'],['NOMBRE APELLIDO APELLIDO','Mar√≠a Pineda']];
  const wb=XLSX.utils.book_new(),ws=XLSX.utils.aoa_to_sheet(wsData);ws['!cols']=[{wch:45},{wch:25}];
  XLSX.utils.book_append_sheet(wb,ws,'Plantilla');XLSX.writeFile(wb,'Plantilla_Empleados.xlsx');
};
window.iaImportEmployees=function(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(e.target.result,{type:'binary'});const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});if(rows.length<2)return;
      const header=rows[0].map(h=>String(h).toLowerCase().trim());
      const empCol=header.findIndex(h=>h.includes('empleado')||h.includes('nombre'));const supCol=header.findIndex(h=>h.includes('supervisor'));
      if(empCol===-1)return;
      let added=0,skipped=0;
      rows.slice(1).forEach(row=>{
        const name=String(row[empCol]||'').trim().toUpperCase();const supName=supCol>=0?String(row[supCol]||'').trim():'';
        if(!name||iaState.employees.find(e=>e.name===name)){skipped++;return;}
        let supId='';if(supName){const found=iaNonAdminSups().find(s=>s.name.toLowerCase()===supName.toLowerCase());if(found)supId=found.id;}
        iaState.employees.push({id:iaGenId(),name,supId});added++;
      });
      iaSaveState();iaRenderEmployeeList();
      const el=document.getElementById('ia-import-result');el.textContent=`‚úÖ ${added} importados, ${skipped} omitidos.`;el.className='ia-import-result ok';el.style.display='block';setTimeout(()=>el.style.display='none',5000);
    }catch(err){const el=document.getElementById('ia-import-result');el.textContent='Error: '+err.message;el.className='ia-import-result err';el.style.display='block';}
    input.value='';
  };reader.readAsBinaryString(file);
};
function iaBuildAreaSupSelect(){
  const sel=document.getElementById('ia-area-sup-select');const cur=sel.value;
  sel.innerHTML='<option value="">‚Äî Seleccionar ‚Äî</option>';
  iaNonAdminSups().forEach(s=>{const o=document.createElement('option');o.value=s.id;o.textContent=s.name;sel.appendChild(o);});
  if(cur)sel.value=cur;
}
window.iaRenderAreaManager=function(){
  const supId=document.getElementById('ia-area-sup-select').value;const wrap=document.getElementById('ia-area-manager-wrap');
  if(!supId){wrap.innerHTML='';return;}const sup=iaGetSup(supId);const areas=sup.areas||[];
  if(!areas.length){wrap.innerHTML='<p style="color:#6b7a99;font-size:.85rem;margin-top:.8rem;">Sin √°reas.</p>';return;}
  wrap.innerHTML=`<div class="ia-areas-grid">${areas.map(a=>`<span class="ia-area-chip">${a}<button class="rm" onclick="iaRemoveArea('${supId}','${a}')">‚úï</button></span>`).join('')}</div>`;
};
window.iaAddArea=function(){
  const supId=document.getElementById('ia-area-sup-select').value;const name=document.getElementById('ia-new-area-name').value.trim().toUpperCase();
  if(!supId||!name)return;const sup=iaGetSup(supId);if(!sup.areas)sup.areas=[];if(sup.areas.includes(name))return;
  sup.areas.push(name);sup.areas.sort((a,b)=>iaAreaOrder(a)-iaAreaOrder(b));iaSaveState();document.getElementById('ia-new-area-name').value='';iaRenderAreaManager();if(iaIsAdmin())iaBuildAreaSelect();
};
window.iaRemoveArea=function(supId,area){
  if(!confirm(`¬øQuitar "${area}"?`))return;const sup=iaGetSup(supId);sup.areas=sup.areas.filter(a=>a!==area);iaSaveState();iaRenderAreaManager();if(iaIsAdmin())iaBuildAreaSelect();
};

// Inicializar: esperar datos del servidor antes de mostrar login
iaWaitReady(function(){
  iaBuildLoginSelect();
});
} // end runIngresoScript
</script>

</body>
</html>
